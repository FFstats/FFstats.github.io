/*! For license information please see 7112840a-0e8783e98dabcd880da1.js.LICENSE.txt */
(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{CCl1:function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return $f})),n.d(t,"b",(function(){return Xl})),n.d(t,"c",(function(){return Fl})),n.d(t,"d",(function(){return Ol})),n.d(t,"e",(function(){return nh})),n.d(t,"f",(function(){return Yl})),n.d(t,"g",(function(){return P})),n.d(t,"h",(function(){return $l})),n.d(t,"i",(function(){return rh})),n.d(t,"j",(function(){return ih})),n.d(t,"k",(function(){return ee})),n.d(t,"l",(function(){return Ih})),n.d(t,"m",(function(){return Ct})),n.d(t,"n",(function(){return ue})),n.d(t,"o",(function(){return ae})),n.d(t,"p",(function(){return kl})),n.d(t,"q",(function(){return M})),n.d(t,"r",(function(){return xt})),n.d(t,"s",(function(){return C})),n.d(t,"t",(function(){return yl})),n.d(t,"u",(function(){return mh})),n.d(t,"v",(function(){return Dh})),n.d(t,"w",(function(){return jh})),n.d(t,"x",(function(){return Bl})),n.d(t,"y",(function(){return Sl})),n.d(t,"z",(function(){return _l})),n.d(t,"A",(function(){return Il})),n.d(t,"B",(function(){return ph})),n.d(t,"C",(function(){return Sh})),n.d(t,"D",(function(){return Gl})),n.d(t,"E",(function(){return jl})),n.d(t,"F",(function(){return Pl})),n.d(t,"G",(function(){return ql})),n.d(t,"H",(function(){return zl})),n.d(t,"I",(function(){return Qf})),n.d(t,"J",(function(){return Gf})),n.d(t,"K",(function(){return Vl})),n.d(t,"L",(function(){return bh})),n.d(t,"M",(function(){return oh})),n.d(t,"N",(function(){return ch})),n.d(t,"O",(function(){return lh})),n.d(t,"P",(function(){return fh})),n.d(t,"Q",(function(){return hh})),n.d(t,"R",(function(){return dh})),n.d(t,"S",(function(){return Ah})),n.d(t,"T",(function(){return Pf})),n.d(t,"U",(function(){return qf})),n.d(t,"V",(function(){return Ql})),n.d(t,"W",(function(){return Wl})),n.d(t,"X",(function(){return gh})),n.d(t,"Y",(function(){return kh})),n.d(t,"Z",(function(){return Vf})),n.d(t,"ab",(function(){return Cf})),n.d(t,"bb",(function(){return Al})),n.d(t,"cb",(function(){return Dl})),n.d(t,"db",(function(){return Th})),n.d(t,"eb",(function(){return _h})),n.d(t,"fb",(function(){return vh})),n.d(t,"gb",(function(){return j})),n.d(t,"hb",(function(){return uh})),n.d(t,"ib",(function(){return Kf})),n.d(t,"jb",(function(){return Bf})),n.d(t,"kb",(function(){return yh})),n.d(t,"lb",(function(){return Kl})),n.d(t,"mb",(function(){return Rf}));var r=n("RHh3"),i=n("ReuC"),a=n("ODXe"),u=n("kHIg"),o=n("HaE+"),s=n("Ji7U"),c=n("md7G"),l=n("foSv"),f=n("KQm4"),h=n("1OyB"),d=n("vuIU"),v=(n("IZzc"),n("ToJy"),n("E9XD"),n("o0o1")),y=n.n(v),p=n("WJvL"),m=n("IuUc"),g=n("5pEQ"),k=n("H9WU"),b=n("nEQb");function w(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return x(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return x(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,u=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return u=e.done,e},e:function(e){o=!0,a=e},f:function(){try{u||null==n.return||n.return()}finally{if(o)throw a}}}}function x(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function I(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Object(l.a)(e);if(t){var i=Object(l.a)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Object(c.a)(this,n)}}var O="@firebase/firestore",E=function(){function e(t){Object(h.a)(this,e),this.uid=t}return Object(d.a)(e,[{key:"isAuthenticated",value:function(){return null!=this.uid}},{key:"toKey",value:function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}},{key:"isEqual",value:function(e){return e.uid===this.uid}}]),e}();E.UNAUTHENTICATED=new E(null),E.GOOGLE_CREDENTIALS=new E("google-credentials-uid"),E.FIRST_PARTY=new E("first-party-uid"),E.MOCK_USER=new E("mock-user");var T="9.21.0",S=new g.b("@firebase/firestore");function _(){return S.logLevel}function j(e){S.setLogLevel(e)}function D(e){if(S.logLevel<=g.a.DEBUG){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i=n.map(N);S.debug.apply(S,["Firestore (".concat(T,"): ").concat(e)].concat(Object(f.a)(i)))}}function A(e){if(S.logLevel<=g.a.ERROR){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i=n.map(N);S.error.apply(S,["Firestore (".concat(T,"): ").concat(e)].concat(Object(f.a)(i)))}}function C(e){if(S.logLevel<=g.a.WARN){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i=n.map(N);S.warn.apply(S,["Firestore (".concat(T,"): ").concat(e)].concat(Object(f.a)(i)))}}function N(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function R(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected state",t="FIRESTORE (".concat(T,") INTERNAL ASSERTION FAILED: ")+e;throw A(t),new Error(t)}function F(e,t){e||R()}function M(e,t){e||R()}function V(e,t){return e}var L={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},P=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this,e,r)).code=e,i.message=r,i.toString=function(){return"".concat(i.name,": [code=").concat(i.code,"]: ").concat(i.message)},i}return n}(k.c),q=function e(){var t=this;Object(h.a)(this,e),this.promise=new Promise((function(e,n){t.resolve=e,t.reject=n}))},U=function e(t,n){Object(h.a)(this,e),this.user=n,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization","Bearer ".concat(t))},B=function(){function e(){Object(h.a)(this,e)}return Object(d.a)(e,[{key:"getToken",value:function(){return Promise.resolve(null)}},{key:"invalidateToken",value:function(){}},{key:"start",value:function(e,t){e.enqueueRetryable((function(){return t(E.UNAUTHENTICATED)}))}},{key:"shutdown",value:function(){}}]),e}(),K=function(){function e(t){Object(h.a)(this,e),this.token=t,this.changeListener=null}return Object(d.a)(e,[{key:"getToken",value:function(){return Promise.resolve(this.token)}},{key:"invalidateToken",value:function(){}},{key:"start",value:function(e,t){var n=this;this.changeListener=t,e.enqueueRetryable((function(){return t(n.token.user)}))}},{key:"shutdown",value:function(){this.changeListener=null}}]),e}(),z=function(){function e(t){Object(h.a)(this,e),this.t=t,this.currentUser=E.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}return Object(d.a)(e,[{key:"start",value:function(e,t){var n=this,r=this.i,i=function(e){return n.i!==r?(r=n.i,t(e)):Promise.resolve()},a=new q;this.o=function(){n.i++,n.currentUser=n.u(),a.resolve(),a=new q,e.enqueueRetryable((function(){return i(n.currentUser)}))};var u=function(){var t=a;e.enqueueRetryable(Object(o.a)(y.a.mark((function e(){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.promise;case 2:return e.next=4,i(n.currentUser);case 4:case"end":return e.stop()}}),e)}))))},s=function(e){D("FirebaseAuthCredentialsProvider","Auth detected"),n.auth=e,n.auth.addAuthTokenListener(n.o),u()};this.t.onInit((function(e){return s(e)})),setTimeout((function(){if(!n.auth){var e=n.t.getImmediate({optional:!0});e?s(e):(D("FirebaseAuthCredentialsProvider","Auth not yet detected"),a.resolve(),a=new q)}}),0),u()}},{key:"getToken",value:function(){var e=this,t=this.i,n=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(n).then((function(n){return e.i!==t?(D("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),e.getToken()):n?(F("string"==typeof n.accessToken),new U(n.accessToken,e.currentUser)):null})):Promise.resolve(null)}},{key:"invalidateToken",value:function(){this.forceRefresh=!0}},{key:"shutdown",value:function(){this.auth&&this.auth.removeAuthTokenListener(this.o)}},{key:"u",value:function(){var e=this.auth&&this.auth.getUid();return F(null===e||"string"==typeof e),new E(e)}}]),e}(),G=function(){function e(t,n,r){Object(h.a)(this,e),this.h=t,this.l=n,this.m=r,this.type="FirstParty",this.user=E.FIRST_PARTY,this.g=new Map}return Object(d.a)(e,[{key:"p",value:function(){return this.m?this.m():null}},{key:"headers",get:function(){this.g.set("X-Goog-AuthUser",this.h);var e=this.p();return e&&this.g.set("Authorization",e),this.l&&this.g.set("X-Goog-Iam-Authorization-Token",this.l),this.g}}]),e}(),Q=function(){function e(t,n,r){Object(h.a)(this,e),this.h=t,this.l=n,this.m=r}return Object(d.a)(e,[{key:"getToken",value:function(){return Promise.resolve(new G(this.h,this.l,this.m))}},{key:"start",value:function(e,t){e.enqueueRetryable((function(){return t(E.FIRST_PARTY)}))}},{key:"shutdown",value:function(){}},{key:"invalidateToken",value:function(){}}]),e}(),W=function e(t){Object(h.a)(this,e),this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)},H=function(){function e(t){Object(h.a)(this,e),this.I=t,this.forceRefresh=!1,this.appCheck=null,this.T=null}return Object(d.a)(e,[{key:"start",value:function(e,t){var n=this,r=function(e){null!=e.error&&D("FirebaseAppCheckTokenProvider","Error getting App Check token; using placeholder token instead. Error: ".concat(e.error.message));var r=e.token!==n.T;return n.T=e.token,D("FirebaseAppCheckTokenProvider","Received ".concat(r?"new":"existing"," token.")),r?t(e.token):Promise.resolve()};this.o=function(t){e.enqueueRetryable((function(){return r(t)}))};var i=function(e){D("FirebaseAppCheckTokenProvider","AppCheck detected"),n.appCheck=e,n.appCheck.addTokenListener(n.o)};this.I.onInit((function(e){return i(e)})),setTimeout((function(){if(!n.appCheck){var e=n.I.getImmediate({optional:!0});e?i(e):D("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}},{key:"getToken",value:function(){var e=this,t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((function(t){return t?(F("string"==typeof t.token),e.T=t.token,new W(t.token)):null})):Promise.resolve(null)}},{key:"invalidateToken",value:function(){this.forceRefresh=!0}},{key:"shutdown",value:function(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}]),e}();function X(e){var t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(var r=0;r<e;r++)n[r]=Math.floor(256*Math.random());return n}var Y=function(){function e(){Object(h.a)(this,e)}return Object(d.a)(e,null,[{key:"A",value:function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length,n="";n.length<20;)for(var r=X(40),i=0;i<r.length;++i)n.length<20&&r[i]<t&&(n+=e.charAt(r[i]%e.length));return n}}]),e}();function J(e,t){return e<t?-1:e>t?1:0}function $(e,t,n){return e.length===t.length&&e.every((function(e,r){return n(e,t[r])}))}function Z(e){return e+"\0"}var ee=function(){function e(t,n){if(Object(h.a)(this,e),this.seconds=t,this.nanoseconds=n,n<0)throw new P(L.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+n);if(n>=1e9)throw new P(L.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+n);if(t<-62135596800)throw new P(L.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new P(L.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}return Object(d.a)(e,[{key:"toDate",value:function(){return new Date(this.toMillis())}},{key:"toMillis",value:function(){return 1e3*this.seconds+this.nanoseconds/1e6}},{key:"_compareTo",value:function(e){return this.seconds===e.seconds?J(this.nanoseconds,e.nanoseconds):J(this.seconds,e.seconds)}},{key:"isEqual",value:function(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}},{key:"toString",value:function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}},{key:"toJSON",value:function(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}},{key:"valueOf",value:function(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}],[{key:"now",value:function(){return e.fromMillis(Date.now())}},{key:"fromDate",value:function(t){return e.fromMillis(t.getTime())}},{key:"fromMillis",value:function(t){var n=Math.floor(t/1e3);return new e(n,Math.floor(1e6*(t-1e3*n)))}}]),e}(),te=function(){function e(t){Object(h.a)(this,e),this.timestamp=t}return Object(d.a)(e,[{key:"compareTo",value:function(e){return this.timestamp._compareTo(e.timestamp)}},{key:"isEqual",value:function(e){return this.timestamp.isEqual(e.timestamp)}},{key:"toMicroseconds",value:function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}},{key:"toString",value:function(){return"SnapshotVersion("+this.timestamp.toString()+")"}},{key:"toTimestamp",value:function(){return this.timestamp}}],[{key:"fromTimestamp",value:function(t){return new e(t)}},{key:"min",value:function(){return new e(new ee(0,0))}},{key:"max",value:function(){return new e(new ee(253402300799,999999999))}}]),e}(),ne=function(){function e(t,n,r){Object(h.a)(this,e),void 0===n?n=0:n>t.length&&R(),void 0===r?r=t.length-n:r>t.length-n&&R(),this.segments=t,this.offset=n,this.len=r}return Object(d.a)(e,[{key:"length",get:function(){return this.len}},{key:"isEqual",value:function(t){return 0===e.comparator(this,t)}},{key:"child",value:function(t){var n=this.segments.slice(this.offset,this.limit());return t instanceof e?t.forEach((function(e){n.push(e)})):n.push(t),this.construct(n)}},{key:"limit",value:function(){return this.offset+this.length}},{key:"popFirst",value:function(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}},{key:"popLast",value:function(){return this.construct(this.segments,this.offset,this.length-1)}},{key:"firstSegment",value:function(){return this.segments[this.offset]}},{key:"lastSegment",value:function(){return this.get(this.length-1)}},{key:"get",value:function(e){return this.segments[this.offset+e]}},{key:"isEmpty",value:function(){return 0===this.length}},{key:"isPrefixOf",value:function(e){if(e.length<this.length)return!1;for(var t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}},{key:"isImmediateParentOf",value:function(e){if(this.length+1!==e.length)return!1;for(var t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}},{key:"forEach",value:function(e){for(var t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}},{key:"toArray",value:function(){return this.segments.slice(this.offset,this.limit())}}],[{key:"comparator",value:function(e,t){for(var n=Math.min(e.length,t.length),r=0;r<n;r++){var i=e.get(r),a=t.get(r);if(i<a)return-1;if(i>a)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}]),e}(),re=function(e){Object(s.a)(n,e);var t=I(n);function n(){return Object(h.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"construct",value:function(e,t,r){return new n(e,t,r)}},{key:"canonicalString",value:function(){return this.toArray().join("/")}},{key:"toString",value:function(){return this.canonicalString()}}],[{key:"fromString",value:function(){for(var e=[],t=arguments.length,r=new Array(t),i=0;i<t;i++)r[i]=arguments[i];for(var a=0,u=r;a<u.length;a++){var o=u[a];if(o.indexOf("//")>=0)throw new P(L.INVALID_ARGUMENT,"Invalid segment (".concat(o,"). Paths must not contain // in them."));e.push.apply(e,Object(f.a)(o.split("/").filter((function(e){return e.length>0}))))}return new n(e)}},{key:"emptyPath",value:function(){return new n([])}}]),n}(ne),ie=/^[_a-zA-Z][_a-zA-Z0-9]*$/,ae=function(e){Object(s.a)(n,e);var t=I(n);function n(){return Object(h.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"construct",value:function(e,t,r){return new n(e,t,r)}},{key:"canonicalString",value:function(){return this.toArray().map((function(e){return e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),n.isValidIdentifier(e)||(e="`"+e+"`"),e})).join(".")}},{key:"toString",value:function(){return this.canonicalString()}},{key:"isKeyField",value:function(){return 1===this.length&&"__name__"===this.get(0)}}],[{key:"isValidIdentifier",value:function(e){return ie.test(e)}},{key:"keyField",value:function(){return new n(["__name__"])}},{key:"fromServerFormat",value:function(e){for(var t=[],r="",i=0,a=function(){if(0===r.length)throw new P(L.INVALID_ARGUMENT,"Invalid field path (".concat(e,"). Paths must not be empty, begin with '.', end with '.', or contain '..'"));t.push(r),r=""},u=!1;i<e.length;){var o=e[i];if("\\"===o){if(i+1===e.length)throw new P(L.INVALID_ARGUMENT,"Path has trailing escape character: "+e);var s=e[i+1];if("\\"!==s&&"."!==s&&"`"!==s)throw new P(L.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);r+=s,i+=2}else"`"===o?(u=!u,i++):"."!==o||u?(r+=o,i++):(a(),i++)}if(a(),u)throw new P(L.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new n(t)}},{key:"emptyPath",value:function(){return new n([])}}]),n}(ne),ue=function(){function e(t){Object(h.a)(this,e),this.path=t}return Object(d.a)(e,[{key:"collectionGroup",get:function(){return this.path.popLast().lastSegment()}},{key:"hasCollectionId",value:function(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}},{key:"getCollectionGroup",value:function(){return this.path.get(this.path.length-2)}},{key:"getCollectionPath",value:function(){return this.path.popLast()}},{key:"isEqual",value:function(e){return null!==e&&0===re.comparator(this.path,e.path)}},{key:"toString",value:function(){return this.path.toString()}}],[{key:"fromPath",value:function(t){return new e(re.fromString(t))}},{key:"fromName",value:function(t){return new e(re.fromString(t).popFirst(5))}},{key:"empty",value:function(){return new e(re.emptyPath())}},{key:"comparator",value:function(e,t){return re.comparator(e.path,t.path)}},{key:"isDocumentKey",value:function(e){return e.length%2==0}},{key:"fromSegments",value:function(t){return new e(new re(t.slice()))}}]),e}(),oe=function e(t,n,r,i){Object(h.a)(this,e),this.indexId=t,this.collectionGroup=n,this.fields=r,this.indexState=i};function se(e){return e.fields.find((function(e){return 2===e.kind}))}function ce(e){return e.fields.filter((function(e){return 2!==e.kind}))}oe.UNKNOWN_ID=-1;var le=function e(t,n){Object(h.a)(this,e),this.fieldPath=t,this.kind=n};var fe=function(){function e(t,n){Object(h.a)(this,e),this.sequenceNumber=t,this.offset=n}return Object(d.a)(e,null,[{key:"empty",value:function(){return new e(0,ve.min())}}]),e}();function he(e,t){var n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,i=te.fromTimestamp(1e9===r?new ee(n+1,0):new ee(n,r));return new ve(i,ue.empty(),t)}function de(e){return new ve(e.readTime,e.key,-1)}var ve=function(){function e(t,n,r){Object(h.a)(this,e),this.readTime=t,this.documentKey=n,this.largestBatchId=r}return Object(d.a)(e,null,[{key:"min",value:function(){return new e(te.min(),ue.empty(),-1)}},{key:"max",value:function(){return new e(te.max(),ue.empty(),-1)}}]),e}();function ye(e,t){var n=e.readTime.compareTo(t.readTime);return 0!==n?n:0!==(n=ue.comparator(e.documentKey,t.documentKey))?n:J(e.largestBatchId,t.largestBatchId)}var pe="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",me=function(){function e(){Object(h.a)(this,e),this.onCommittedListeners=[]}return Object(d.a)(e,[{key:"addOnCommittedListener",value:function(e){this.onCommittedListeners.push(e)}},{key:"raiseOnCommittedEvent",value:function(){this.onCommittedListeners.forEach((function(e){return e()}))}}]),e}();function ge(e){return ke.apply(this,arguments)}function ke(){return(ke=Object(o.a)(y.a.mark((function e(t){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.code===L.FAILED_PRECONDITION&&t.message===pe){e.next=2;break}throw t;case 2:D("LocalStore","Unexpectedly lost primary lease");case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var be=function(){function e(t){var n=this;Object(h.a)(this,e),this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((function(e){n.isDone=!0,n.result=e,n.nextCallback&&n.nextCallback(e)}),(function(e){n.isDone=!0,n.error=e,n.catchCallback&&n.catchCallback(e)}))}return Object(d.a)(e,[{key:"catch",value:function(e){return this.next(void 0,e)}},{key:"next",value:function(t,n){var r=this;return this.callbackAttached&&R(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(n,this.error):this.wrapSuccess(t,this.result):new e((function(e,i){r.nextCallback=function(n){r.wrapSuccess(t,n).next(e,i)},r.catchCallback=function(t){r.wrapFailure(n,t).next(e,i)}}))}},{key:"toPromise",value:function(){var e=this;return new Promise((function(t,n){e.next(t,n)}))}},{key:"wrapUserFunction",value:function(t){try{var n=t();return n instanceof e?n:e.resolve(n)}catch(t){return e.reject(t)}}},{key:"wrapSuccess",value:function(t,n){return t?this.wrapUserFunction((function(){return t(n)})):e.resolve(n)}},{key:"wrapFailure",value:function(t,n){return t?this.wrapUserFunction((function(){return t(n)})):e.reject(n)}}],[{key:"resolve",value:function(t){return new e((function(e,n){e(t)}))}},{key:"reject",value:function(t){return new e((function(e,n){n(t)}))}},{key:"waitFor",value:function(t){return new e((function(e,n){var r=0,i=0,a=!1;t.forEach((function(t){++r,t.next((function(){++i,a&&i===r&&e()}),(function(e){return n(e)}))})),a=!0,i===r&&e()}))}},{key:"or",value:function(t){var n,r=e.resolve(!1),i=w(t);try{var a=function(){var t=n.value;r=r.next((function(n){return n?e.resolve(n):t()}))};for(i.s();!(n=i.n()).done;)a()}catch(u){i.e(u)}finally{i.f()}return r}},{key:"forEach",value:function(e,t){var n=this,r=[];return e.forEach((function(e,i){r.push(t.call(n,e,i))})),this.waitFor(r)}},{key:"mapArray",value:function(t,n){return new e((function(e,r){for(var i=t.length,a=new Array(i),u=0,o=function(o){var s=o;n(t[s]).next((function(t){a[s]=t,++u===i&&e(a)}),(function(e){return r(e)}))},s=0;s<i;s++)o(s)}))}},{key:"doWhile",value:function(t,n){return new e((function(e,r){!function i(){!0===t()?n().next((function(){i()}),r):e()}()}))}}]),e}(),we=function(){function e(t,n){var r=this;Object(h.a)(this,e),this.action=t,this.transaction=n,this.aborted=!1,this.R=new q,this.transaction.oncomplete=function(){r.R.resolve()},this.transaction.onabort=function(){n.error?r.R.reject(new Oe(t,n.error)):r.R.resolve()},this.transaction.onerror=function(e){var n=je(e.target.error);r.R.reject(new Oe(t,n))}}return Object(d.a)(e,[{key:"v",get:function(){return this.R.promise}},{key:"abort",value:function(e){e&&this.R.reject(e),this.aborted||(D("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}},{key:"P",value:function(){var e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}},{key:"store",value:function(e){var t=this.transaction.objectStore(e);return new Te(t)}}],[{key:"open",value:function(t,n,r,i){try{return new e(n,t.transaction(i,r))}catch(t){throw new Oe(n,t)}}}]),e}(),xe=function(){function t(e,n,r){Object(h.a)(this,t),this.name=e,this.version=n,this.V=r,12.2===t.S(Object(k.q)())&&A("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}var n,r;return Object(d.a)(t,[{key:"O",value:(r=Object(o.a)(y.a.mark((function e(t){var n=this;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.db,e.t0){e.next=6;break}return D("SimpleDb","Opening database:",this.name),e.next=5,new Promise((function(e,r){var i=indexedDB.open(n.name,n.version);i.onsuccess=function(t){var n=t.target.result;e(n)},i.onblocked=function(){r(new Oe(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=function(e){var n=e.target.error;"VersionError"===n.name?r(new P(L.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===n.name?r(new P(L.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+n)):r(new Oe(t,n))},i.onupgradeneeded=function(e){D("SimpleDb",'Database "'+n.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;n.V.$(t,i.transaction,e.oldVersion,n.version).next((function(){D("SimpleDb","Database upgrade to version "+n.version+" complete")}))}}));case 5:this.db=e.sent;case 6:return this.F&&(this.db.onversionchange=function(e){return n.F(e)}),e.abrupt("return",this.db);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"B",value:function(e){this.F=e,this.db&&(this.db.onversionchange=function(t){return e(t)})}},{key:"runTransaction",value:(n=Object(o.a)(y.a.mark((function e(t,n,r,i){var a,u,o,s,c,l=this;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a="readonly"===n,u=0;case 2:return++u,e.prev=3,e.delegateYield(y.a.mark((function e(){var n,u;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.O(t);case 2:return l.db=e.sent,n=we.open(l.db,t,a?"readonly":"readwrite",r),(u=i(n).next((function(e){return n.P(),e})).catch((function(e){return n.abort(e),be.reject(e)})).toPromise()).catch((function(){})),e.next=7,n.v;case 7:return e.t0=u,e.abrupt("return",{v:e.t0});case 9:case"end":return e.stop()}}),e)}))(),"t0",5);case 5:if("object"!=typeof(o=e.t0)){e.next=8;break}return e.abrupt("return",o.v);case 8:e.next=15;break;case 10:if(e.prev=10,e.t1=e.catch(3),s=e.t1,c="FirebaseError"!==s.name&&u<3,D("SimpleDb","Transaction failed with error:",s.message,"Retrying:",c),this.close(),c){e.next=15;break}return e.abrupt("return",Promise.reject(s));case 15:e.next=2;break;case 17:case"end":return e.stop()}}),e,this,[[3,10]])}))),function(e,t,r,i){return n.apply(this,arguments)})},{key:"close",value:function(){this.db&&this.db.close(),this.db=void 0}}],[{key:"delete",value:function(e){return D("SimpleDb","Removing database:",e),Se(window.indexedDB.deleteDatabase(e)).toPromise()}},{key:"D",value:function(){if(!Object(k.v)())return!1;if(t.C())return!0;var e=Object(k.q)(),n=t.S(e),r=0<n&&n<10,i=t.N(e),a=0<i&&i<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||r||a)}},{key:"C",value:function(){var t;return void 0!==e&&"YES"===(null===(t={})||void 0===t?void 0:t.k)}},{key:"M",value:function(e,t){return e.store(t)}},{key:"S",value:function(e){var t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}},{key:"N",value:function(e){var t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}}]),t}(),Ie=function(){function e(t){Object(h.a)(this,e),this.L=t,this.q=!1,this.U=null}return Object(d.a)(e,[{key:"isDone",get:function(){return this.q}},{key:"K",get:function(){return this.U}},{key:"cursor",set:function(e){this.L=e}},{key:"done",value:function(){this.q=!0}},{key:"G",value:function(e){this.U=e}},{key:"delete",value:function(){return Se(this.L.delete())}}]),e}(),Oe=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this,L.UNAVAILABLE,"IndexedDB transaction '".concat(e,"' failed: ").concat(r))).name="IndexedDbTransactionError",i}return n}(P);function Ee(e){return"IndexedDbTransactionError"===e.name}var Te=function(){function e(t){Object(h.a)(this,e),this.store=t}return Object(d.a)(e,[{key:"put",value:function(e,t){var n;return void 0!==t?(D("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(D("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),Se(n)}},{key:"add",value:function(e){return D("SimpleDb","ADD",this.store.name,e,e),Se(this.store.add(e))}},{key:"get",value:function(e){var t=this;return Se(this.store.get(e)).next((function(n){return void 0===n&&(n=null),D("SimpleDb","GET",t.store.name,e,n),n}))}},{key:"delete",value:function(e){return D("SimpleDb","DELETE",this.store.name,e),Se(this.store.delete(e))}},{key:"count",value:function(){return D("SimpleDb","COUNT",this.store.name),Se(this.store.count())}},{key:"j",value:function(e,t){var n=this.options(e,t);if(n.index||"function"!=typeof this.store.getAll){var r=this.cursor(n),i=[];return this.W(r,(function(e,t){i.push(t)})).next((function(){return i}))}var a=this.store.getAll(n.range);return new be((function(e,t){a.onerror=function(e){t(e.target.error)},a.onsuccess=function(t){e(t.target.result)}}))}},{key:"H",value:function(e,t){var n=this.store.getAll(e,null===t?void 0:t);return new be((function(e,t){n.onerror=function(e){t(e.target.error)},n.onsuccess=function(t){e(t.target.result)}}))}},{key:"J",value:function(e,t){D("SimpleDb","DELETE ALL",this.store.name);var n=this.options(e,t);n.Y=!1;var r=this.cursor(n);return this.W(r,(function(e,t,n){return n.delete()}))}},{key:"X",value:function(e,t){var n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.W(r,t)}},{key:"Z",value:function(e){var t=this.cursor({});return new be((function(n,r){t.onerror=function(e){var t=je(e.target.error);r(t)},t.onsuccess=function(t){var r=t.target.result;r?e(r.primaryKey,r.value).next((function(e){e?r.continue():n()})):n()}}))}},{key:"W",value:function(e,t){var n=[];return new be((function(r,i){e.onerror=function(e){i(e.target.error)},e.onsuccess=function(e){var i=e.target.result;if(i){var a=new Ie(i),u=t(i.primaryKey,i.value,a);if(u instanceof be){var o=u.catch((function(e){return a.done(),be.reject(e)}));n.push(o)}a.isDone?r():null===a.K?i.continue():i.continue(a.K)}else r()}})).next((function(){return be.waitFor(n)}))}},{key:"options",value:function(e,t){var n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}},{key:"cursor",value:function(e){var t="next";if(e.reverse&&(t="prev"),e.index){var n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}]),e}();function Se(e){return new be((function(t,n){e.onsuccess=function(e){var n=e.target.result;t(n)},e.onerror=function(e){var t=je(e.target.error);n(t)}}))}var _e=!1;function je(e){var t=xe.S(Object(k.q)());if(t>=12.2&&t<13){var n="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(n)>=0){var r=new P("internal","IOS_INDEXEDDB_BUG1: IndexedDb has thrown '".concat(n,"'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround."));return _e||(_e=!0,setTimeout((function(){throw r}),0)),r}}return e}var De=function(){function e(t,n){Object(h.a)(this,e),this.asyncQueue=t,this.tt=n,this.task=null}return Object(d.a)(e,[{key:"start",value:function(){this.et(15e3)}},{key:"stop",value:function(){this.task&&(this.task.cancel(),this.task=null)}},{key:"started",get:function(){return null!==this.task}},{key:"et",value:function(e){var t=this;D("IndexBackiller","Scheduled in ".concat(e,"ms")),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,Object(o.a)(y.a.mark((function e(){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.task=null,e.prev=1,e.t0=D,e.t1="Documents written: ",e.next=6,t.tt.nt();case 6:e.t2=e.sent,e.t3=e.t1.concat.call(e.t1,e.t2),(0,e.t0)("IndexBackiller",e.t3),e.next=19;break;case 11:if(e.prev=11,e.t4=e.catch(1),!Ee(e.t4)){e.next=17;break}D("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e.t4),e.next=19;break;case 17:return e.next=19,ge(e.t4);case 19:return e.next=21,t.et(6e4);case 21:case"end":return e.stop()}}),e,null,[[1,11]])}))))}}]),e}(),Ae=function(){function e(t,n){Object(h.a)(this,e),this.localStore=t,this.persistence=n}var t;return Object(d.a)(e,[{key:"nt",value:(t=Object(o.a)(y.a.mark((function e(){var t,n=this,r=arguments;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:50,e.abrupt("return",this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(function(e){return n.st(e,t)})));case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"st",value:function(e,t){var n=this,r=new Set,i=t,a=!0;return be.doWhile((function(){return!0===a&&i>0}),(function(){return n.localStore.indexManager.getNextCollectionGroupToUpdate(e).next((function(t){if(null!==t&&!r.has(t))return D("IndexBackiller","Processing collection: ".concat(t)),n.it(e,t,i).next((function(e){i-=e,r.add(t)}));a=!1}))})).next((function(){return t-i}))}},{key:"it",value:function(e,t,n){var r=this;return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next((function(i){return r.localStore.localDocuments.getNextDocuments(e,t,i,n).next((function(n){var a=n.changes;return r.localStore.indexManager.updateIndexEntries(e,a).next((function(){return r.rt(i,n)})).next((function(n){return D("IndexBackiller","Updating offset: ".concat(n)),r.localStore.indexManager.updateCollectionGroup(e,t,n)})).next((function(){return a.size}))}))}))}},{key:"rt",value:function(e,t){var n=e;return t.changes.forEach((function(e,t){var r=de(t);ye(r,n)>0&&(n=r)})),new ve(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}]),e}(),Ce=function(){function e(t,n){var r=this;Object(h.a)(this,e),this.previousValue=t,n&&(n.sequenceNumberHandler=function(e){return r.ot(e)},this.ut=function(e){return n.writeSequenceNumber(e)})}return Object(d.a)(e,[{key:"ot",value:function(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}},{key:"next",value:function(){var e=++this.previousValue;return this.ut&&this.ut(e),e}}]),e}();function Ne(e){return null==e}function Re(e){return 0===e&&1/e==-1/0}function Fe(e){return"number"==typeof e&&Number.isInteger(e)&&!Re(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Me(e){for(var t="",n=0;n<e.length;n++)t.length>0&&(t=Le(t)),t=Ve(e.get(n),t);return Le(t)}function Ve(e,t){for(var n=t,r=e.length,i=0;i<r;i++){var a=e.charAt(i);switch(a){case"\0":n+="";break;case"":n+="";break;default:n+=a}}return n}function Le(e){return e+""}function Pe(e){var t=e.length;if(F(t>=2),2===t)return F(""===e.charAt(0)&&""===e.charAt(1)),re.emptyPath();for(var n=t-2,r=[],i="",a=0;a<t;){var u=e.indexOf("",a);switch((u<0||u>n)&&R(),e.charAt(u+1)){case"":var o=e.substring(a,u),s=void 0;0===i.length?s=o:(s=i+=o,i=""),r.push(s);break;case"":i+=e.substring(a,u),i+="\0";break;case"":i+=e.substring(a,u+1);break;default:R()}a=u+2}return new re(r)}Ce.ct=-1;var qe=["userId","batchId"];function Ue(e,t){return[e,Me(t)]}function Be(e,t,n){return[e,Me(t),n]}var Ke={},ze=["prefixPath","collectionGroup","readTime","documentId"],Ge=["prefixPath","collectionGroup","documentId"],Qe=["collectionGroup","readTime","prefixPath","documentId"],We=["canonicalId","targetId"],He=["targetId","path"],Xe=["path","targetId"],Ye=["collectionId","parent"],Je=["indexId","uid"],$e=["uid","sequenceNumber"],Ze=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],et=["indexId","uid","orderedDocumentKey"],tt=["userId","collectionPath","documentId"],nt=["userId","collectionPath","largestBatchId"],rt=["userId","collectionGroup","largestBatchId"],it=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments"].concat(["clientMetadata"]).concat(["remoteDocumentGlobal"]).concat(["collectionParents"]).concat(["bundles","namedQueries"]),at=[].concat(Object(f.a)(it),["documentOverlays"]),ut=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],ot=ut,st=[].concat(ot,["indexConfiguration","indexState","indexEntries"]),ct=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this)).at=e,i.currentSequenceNumber=r,i}return n}(me);function lt(e,t){var n=V(e);return xe.M(n.at,t)}function ft(e){var t=0;for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function ht(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function dt(e){for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}var vt=function(){function e(t,n){Object(h.a)(this,e),this.comparator=t,this.root=n||pt.EMPTY}return Object(d.a)(e,[{key:"insert",value:function(t,n){return new e(this.comparator,this.root.insert(t,n,this.comparator).copy(null,null,pt.BLACK,null,null))}},{key:"remove",value:function(t){return new e(this.comparator,this.root.remove(t,this.comparator).copy(null,null,pt.BLACK,null,null))}},{key:"get",value:function(e){for(var t=this.root;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}},{key:"indexOf",value:function(e){for(var t=0,n=this.root;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}},{key:"isEmpty",value:function(){return this.root.isEmpty()}},{key:"size",get:function(){return this.root.size}},{key:"minKey",value:function(){return this.root.minKey()}},{key:"maxKey",value:function(){return this.root.maxKey()}},{key:"inorderTraversal",value:function(e){return this.root.inorderTraversal(e)}},{key:"forEach",value:function(e){this.inorderTraversal((function(t,n){return e(t,n),!1}))}},{key:"toString",value:function(){var e=[];return this.inorderTraversal((function(t,n){return e.push("".concat(t,":").concat(n)),!1})),"{".concat(e.join(", "),"}")}},{key:"reverseTraversal",value:function(e){return this.root.reverseTraversal(e)}},{key:"getIterator",value:function(){return new yt(this.root,null,this.comparator,!1)}},{key:"getIteratorFrom",value:function(e){return new yt(this.root,e,this.comparator,!1)}},{key:"getReverseIterator",value:function(){return new yt(this.root,null,this.comparator,!0)}},{key:"getReverseIteratorFrom",value:function(e){return new yt(this.root,e,this.comparator,!0)}}]),e}(),yt=function(){function e(t,n,r,i){Object(h.a)(this,e),this.isReverse=i,this.nodeStack=[];for(var a=1;!t.isEmpty();)if(a=n?r(t.key,n):1,n&&i&&(a*=-1),a<0)t=this.isReverse?t.left:t.right;else{if(0===a){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}return Object(d.a)(e,[{key:"getNext",value:function(){var e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}},{key:"hasNext",value:function(){return this.nodeStack.length>0}},{key:"peek",value:function(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}]),e}(),pt=function(){function e(t,n,r,i,a){Object(h.a)(this,e),this.key=t,this.value=n,this.color=null!=r?r:e.RED,this.left=null!=i?i:e.EMPTY,this.right=null!=a?a:e.EMPTY,this.size=this.left.size+1+this.right.size}return Object(d.a)(e,[{key:"copy",value:function(t,n,r,i,a){return new e(null!=t?t:this.key,null!=n?n:this.value,null!=r?r:this.color,null!=i?i:this.left,null!=a?a:this.right)}},{key:"isEmpty",value:function(){return!1}},{key:"inorderTraversal",value:function(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}},{key:"reverseTraversal",value:function(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}},{key:"min",value:function(){return this.left.isEmpty()?this:this.left.min()}},{key:"minKey",value:function(){return this.min().key}},{key:"maxKey",value:function(){return this.right.isEmpty()?this.key:this.right.maxKey()}},{key:"insert",value:function(e,t,n){var r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}},{key:"removeMin",value:function(){if(this.left.isEmpty())return e.EMPTY;var t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),(t=t.copy(null,null,null,t.left.removeMin(),null)).fixUp()}},{key:"remove",value:function(t,n){var r,i=this;if(n(t,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(t,n),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),0===n(t,i.key)){if(i.right.isEmpty())return e.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(t,n))}return i.fixUp()}},{key:"isRed",value:function(){return this.color}},{key:"fixUp",value:function(){var e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}},{key:"moveRedLeft",value:function(){var e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}},{key:"moveRedRight",value:function(){var e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}},{key:"rotateLeft",value:function(){var t=this.copy(null,null,e.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}},{key:"rotateRight",value:function(){var t=this.copy(null,null,e.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}},{key:"colorFlip",value:function(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}},{key:"checkMaxDepth",value:function(){var e=this.check();return Math.pow(2,e)<=this.size+1}},{key:"check",value:function(){if(this.isRed()&&this.left.isRed())throw R();if(this.right.isRed())throw R();var e=this.left.check();if(e!==this.right.check())throw R();return e+(this.isRed()?0:1)}}]),e}();pt.EMPTY=null,pt.RED=!0,pt.BLACK=!1,pt.EMPTY=new(function(){function e(){Object(h.a)(this,e),this.size=0}return Object(d.a)(e,[{key:"key",get:function(){throw R()}},{key:"value",get:function(){throw R()}},{key:"color",get:function(){throw R()}},{key:"left",get:function(){throw R()}},{key:"right",get:function(){throw R()}},{key:"copy",value:function(e,t,n,r,i){return this}},{key:"insert",value:function(e,t,n){return new pt(e,t)}},{key:"remove",value:function(e,t){return this}},{key:"isEmpty",value:function(){return!0}},{key:"inorderTraversal",value:function(e){return!1}},{key:"reverseTraversal",value:function(e){return!1}},{key:"minKey",value:function(){return null}},{key:"maxKey",value:function(){return null}},{key:"isRed",value:function(){return!1}},{key:"checkMaxDepth",value:function(){return!0}},{key:"check",value:function(){return 0}}]),e}());var mt=function(){function e(t){Object(h.a)(this,e),this.comparator=t,this.data=new vt(this.comparator)}return Object(d.a)(e,[{key:"has",value:function(e){return null!==this.data.get(e)}},{key:"first",value:function(){return this.data.minKey()}},{key:"last",value:function(){return this.data.maxKey()}},{key:"size",get:function(){return this.data.size}},{key:"indexOf",value:function(e){return this.data.indexOf(e)}},{key:"forEach",value:function(e){this.data.inorderTraversal((function(t,n){return e(t),!1}))}},{key:"forEachInRange",value:function(e,t){for(var n=this.data.getIteratorFrom(e[0]);n.hasNext();){var r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}},{key:"forEachWhile",value:function(e,t){var n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}},{key:"firstAfterOrEqual",value:function(e){var t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}},{key:"getIterator",value:function(){return new gt(this.data.getIterator())}},{key:"getIteratorFrom",value:function(e){return new gt(this.data.getIteratorFrom(e))}},{key:"add",value:function(e){return this.copy(this.data.remove(e).insert(e,!0))}},{key:"delete",value:function(e){return this.has(e)?this.copy(this.data.remove(e)):this}},{key:"isEmpty",value:function(){return this.data.isEmpty()}},{key:"unionWith",value:function(e){var t=this;return t.size<e.size&&(t=e,e=this),e.forEach((function(e){t=t.add(e)})),t}},{key:"isEqual",value:function(t){if(!(t instanceof e))return!1;if(this.size!==t.size)return!1;for(var n=this.data.getIterator(),r=t.data.getIterator();n.hasNext();){var i=n.getNext().key,a=r.getNext().key;if(0!==this.comparator(i,a))return!1}return!0}},{key:"toArray",value:function(){var e=[];return this.forEach((function(t){e.push(t)})),e}},{key:"toString",value:function(){var e=[];return this.forEach((function(t){return e.push(t)})),"SortedSet("+e.toString()+")"}},{key:"copy",value:function(t){var n=new e(this.comparator);return n.data=t,n}}]),e}(),gt=function(){function e(t){Object(h.a)(this,e),this.iter=t}return Object(d.a)(e,[{key:"getNext",value:function(){return this.iter.getNext().key}},{key:"hasNext",value:function(){return this.iter.hasNext()}}]),e}();function kt(e){return e.hasNext()?e.getNext():void 0}var bt=function(){function e(t){Object(h.a)(this,e),this.fields=t,t.sort(ae.comparator)}return Object(d.a)(e,[{key:"unionWith",value:function(t){var n,r=new mt(ae.comparator),i=w(this.fields);try{for(i.s();!(n=i.n()).done;){var a=n.value;r=r.add(a)}}catch(c){i.e(c)}finally{i.f()}var u,o=w(t);try{for(o.s();!(u=o.n()).done;){var s=u.value;r=r.add(s)}}catch(c){o.e(c)}finally{o.f()}return new e(r.toArray())}},{key:"covers",value:function(e){var t,n=w(this.fields);try{for(n.s();!(t=n.n()).done;){if(t.value.isPrefixOf(e))return!0}}catch(r){n.e(r)}finally{n.f()}return!1}},{key:"isEqual",value:function(e){return $(this.fields,e.fields,(function(e,t){return e.isEqual(t)}))}}],[{key:"empty",value:function(){return new e([])}}]),e}(),wt=function(e){Object(s.a)(n,e);var t=I(n);function n(){var e;return Object(h.a)(this,n),(e=t.apply(this,arguments)).name="Base64DecodeError",e}return n}(Object(u.a)(Error));function xt(){return"undefined"!=typeof atob}var It=function(e){function t(e){Object(h.a)(this,t),this.binaryString=e}return Object(d.a)(t,[{key:e,value:function(){var e=this,t=0;return{next:function(){return t<e.binaryString.length?{value:e.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}}},{key:"toBase64",value:function(){return e=this.binaryString,btoa(e);var e}},{key:"toUint8Array",value:function(){return function(e){for(var t=new Uint8Array(e.length),n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}},{key:"approximateByteSize",value:function(){return 2*this.binaryString.length}},{key:"compareTo",value:function(e){return J(this.binaryString,e.binaryString)}},{key:"isEqual",value:function(e){return this.binaryString===e.binaryString}}],[{key:"fromBase64String",value:function(e){return new t(function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new wt("Invalid base64 string: "+e):e}}(e))}},{key:"fromUint8Array",value:function(e){return new t(function(e){for(var t="",n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e))}}]),t}(Symbol.iterator);It.EMPTY_BYTE_STRING=new It("");var Ot=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Et(e){if(F(!!e),"string"==typeof e){var t=0,n=Ot.exec(e);if(F(!!n),n[1]){var r=n[1];r=(r+"000000000").substr(0,9),t=Number(r)}var i=new Date(e);return{seconds:Math.floor(i.getTime()/1e3),nanos:t}}return{seconds:Tt(e.seconds),nanos:Tt(e.nanos)}}function Tt(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function St(e){return"string"==typeof e?It.fromBase64String(e):It.fromUint8Array(e)}function _t(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function jt(e){var t=e.mapValue.fields.__previous_value__;return _t(t)?jt(t):t}function Dt(e){var t=Et(e.mapValue.fields.__local_write_time__.timestampValue);return new ee(t.seconds,t.nanos)}var At=function e(t,n,r,i,a,u,o,s){Object(h.a)(this,e),this.databaseId=t,this.appId=n,this.persistenceKey=r,this.host=i,this.ssl=a,this.forceLongPolling=u,this.autoDetectLongPolling=o,this.useFetchStreams=s},Ct=function(){function e(t,n){Object(h.a)(this,e),this.projectId=t,this.database=n||"(default)"}return Object(d.a)(e,[{key:"isDefaultDatabase",get:function(){return"(default)"===this.database}},{key:"isEqual",value:function(t){return t instanceof e&&t.projectId===this.projectId&&t.database===this.database}}],[{key:"empty",value:function(){return new e("","")}}]),e}(),Nt={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Rt={nullValue:"NULL_VALUE"};function Ft(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?_t(e)?4:Ht(e)?9007199254740991:10:R()}function Mt(e,t){if(e===t)return!0;var n=Ft(e);if(n!==Ft(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Dt(e).isEqual(Dt(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;var n=Et(e.timestampValue),r=Et(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return St(e.bytesValue).isEqual(St(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return Tt(e.geoPointValue.latitude)===Tt(t.geoPointValue.latitude)&&Tt(e.geoPointValue.longitude)===Tt(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Tt(e.integerValue)===Tt(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){var n=Tt(e.doubleValue),r=Tt(t.doubleValue);return n===r?Re(n)===Re(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return $(e.arrayValue.values||[],t.arrayValue.values||[],Mt);case 10:return function(e,t){var n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(ft(n)!==ft(r))return!1;for(var i in n)if(n.hasOwnProperty(i)&&(void 0===r[i]||!Mt(n[i],r[i])))return!1;return!0}(e,t);default:return R()}}function Vt(e,t){return void 0!==(e.values||[]).find((function(e){return Mt(e,t)}))}function Lt(e,t){if(e===t)return 0;var n=Ft(e),r=Ft(t);if(n!==r)return J(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return J(e.booleanValue,t.booleanValue);case 2:return function(e,t){var n=Tt(e.integerValue||e.doubleValue),r=Tt(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return Pt(e.timestampValue,t.timestampValue);case 4:return Pt(Dt(e),Dt(t));case 5:return J(e.stringValue,t.stringValue);case 6:return function(e,t){var n=St(e),r=St(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){for(var n=e.split("/"),r=t.split("/"),i=0;i<n.length&&i<r.length;i++){var a=J(n[i],r[i]);if(0!==a)return a}return J(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){var n=J(Tt(e.latitude),Tt(t.latitude));return 0!==n?n:J(Tt(e.longitude),Tt(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){for(var n=e.values||[],r=t.values||[],i=0;i<n.length&&i<r.length;++i){var a=Lt(n[i],r[i]);if(a)return a}return J(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Nt.mapValue&&t===Nt.mapValue)return 0;if(e===Nt.mapValue)return 1;if(t===Nt.mapValue)return-1;var n=e.fields||{},r=Object.keys(n),i=t.fields||{},a=Object.keys(i);r.sort(),a.sort();for(var u=0;u<r.length&&u<a.length;++u){var o=J(r[u],a[u]);if(0!==o)return o;var s=Lt(n[r[u]],i[a[u]]);if(0!==s)return s}return J(r.length,a.length)}(e.mapValue,t.mapValue);default:throw R()}}function Pt(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return J(e,t);var n=Et(e),r=Et(t),i=J(n.seconds,r.seconds);return 0!==i?i:J(n.nanos,r.nanos)}function qt(e){return function e(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(e){var t=Et(e);return"time(".concat(t.seconds,",").concat(t.nanos,")")}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?St(t.bytesValue).toBase64():"referenceValue"in t?(r=t.referenceValue,ue.fromName(r).toString()):"geoPointValue"in t?"geo(".concat((n=t.geoPointValue).latitude,",").concat(n.longitude,")"):"arrayValue"in t?function(t){var n,r="[",i=!0,a=w(t.values||[]);try{for(a.s();!(n=a.n()).done;){var u=n.value;i?i=!1:r+=",",r+=e(u)}}catch(o){a.e(o)}finally{a.f()}return r+"]"}(t.arrayValue):"mapValue"in t?function(t){var n,r="{",i=!0,a=w(Object.keys(t.fields||{}).sort());try{for(a.s();!(n=a.n()).done;){var u=n.value;i?i=!1:r+=",",r+="".concat(u,":").concat(e(t.fields[u]))}}catch(o){a.e(o)}finally{a.f()}return r+"}"}(t.mapValue):R();var n,r}(e)}function Ut(e,t){return{referenceValue:"projects/".concat(e.projectId,"/databases/").concat(e.database,"/documents/").concat(t.path.canonicalString())}}function Bt(e){return!!e&&"integerValue"in e}function Kt(e){return!!e&&"arrayValue"in e}function zt(e){return!!e&&"nullValue"in e}function Gt(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Qt(e){return!!e&&"mapValue"in e}function Wt(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){var t={mapValue:{fields:{}}};return ht(e.mapValue.fields,(function(e,n){return t.mapValue.fields[e]=Wt(n)})),t}if(e.arrayValue){for(var n={arrayValue:{values:[]}},r=0;r<(e.arrayValue.values||[]).length;++r)n.arrayValue.values[r]=Wt(e.arrayValue.values[r]);return n}return Object.assign({},e)}function Ht(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function Xt(e){return"nullValue"in e?Rt:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?Ut(Ct.empty(),ue.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?{mapValue:{}}:R()}function Yt(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?Ut(Ct.empty(),ue.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?{mapValue:{}}:"mapValue"in e?Nt:R()}function Jt(e,t){var n=Lt(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function $t(e,t){var n=Lt(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}var Zt=function(){function e(t){Object(h.a)(this,e),this.value=t}return Object(d.a)(e,[{key:"field",value:function(e){if(e.isEmpty())return this.value;for(var t=this.value,n=0;n<e.length-1;++n)if(!Qt(t=(t.mapValue.fields||{})[e.get(n)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}},{key:"set",value:function(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Wt(t)}},{key:"setAll",value:function(e){var t=this,n=ae.emptyPath(),r={},i=[];e.forEach((function(e,a){if(!n.isImmediateParentOf(a)){var u=t.getFieldsMap(n);t.applyChanges(u,r,i),r={},i=[],n=a.popLast()}e?r[a.lastSegment()]=Wt(e):i.push(a.lastSegment())}));var a=this.getFieldsMap(n);this.applyChanges(a,r,i)}},{key:"delete",value:function(e){var t=this.field(e.popLast());Qt(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}},{key:"isEqual",value:function(e){return Mt(this.value,e.value)}},{key:"getFieldsMap",value:function(e){var t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(var n=0;n<e.length;++n){var r=t.mapValue.fields[e.get(n)];Qt(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}},{key:"applyChanges",value:function(e,t,n){ht(t,(function(t,n){return e[t]=n}));var r,i=w(n);try{for(i.s();!(r=i.n()).done;){var a=r.value;delete e[a]}}catch(u){i.e(u)}finally{i.f()}}},{key:"clone",value:function(){return new e(Wt(this.value))}}],[{key:"empty",value:function(){return new e({mapValue:{}})}}]),e}();function en(e){var t=[];return ht(e.fields,(function(e,n){var r=new ae([e]);if(Qt(n)){var i=en(n.mapValue).fields;if(0===i.length)t.push(r);else{var a,u=w(i);try{for(u.s();!(a=u.n()).done;){var o=a.value;t.push(r.child(o))}}catch(s){u.e(s)}finally{u.f()}}}else t.push(r)})),new bt(t)}var tn=function(){function e(t,n,r,i,a,u,o){Object(h.a)(this,e),this.key=t,this.documentType=n,this.version=r,this.readTime=i,this.createTime=a,this.data=u,this.documentState=o}return Object(d.a)(e,[{key:"convertToFoundDocument",value:function(e,t){return!this.createTime.isEqual(te.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}},{key:"convertToNoDocument",value:function(e){return this.version=e,this.documentType=2,this.data=Zt.empty(),this.documentState=0,this}},{key:"convertToUnknownDocument",value:function(e){return this.version=e,this.documentType=3,this.data=Zt.empty(),this.documentState=2,this}},{key:"setHasCommittedMutations",value:function(){return this.documentState=2,this}},{key:"setHasLocalMutations",value:function(){return this.documentState=1,this.version=te.min(),this}},{key:"setReadTime",value:function(e){return this.readTime=e,this}},{key:"hasLocalMutations",get:function(){return 1===this.documentState}},{key:"hasCommittedMutations",get:function(){return 2===this.documentState}},{key:"hasPendingWrites",get:function(){return this.hasLocalMutations||this.hasCommittedMutations}},{key:"isValidDocument",value:function(){return 0!==this.documentType}},{key:"isFoundDocument",value:function(){return 1===this.documentType}},{key:"isNoDocument",value:function(){return 2===this.documentType}},{key:"isUnknownDocument",value:function(){return 3===this.documentType}},{key:"isEqual",value:function(t){return t instanceof e&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}},{key:"mutableCopy",value:function(){return new e(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}},{key:"toString",value:function(){return"Document(".concat(this.key,", ").concat(this.version,", ").concat(JSON.stringify(this.data.value),", {createTime: ").concat(this.createTime,"}), {documentType: ").concat(this.documentType,"}), {documentState: ").concat(this.documentState,"})")}}],[{key:"newInvalidDocument",value:function(t){return new e(t,0,te.min(),te.min(),te.min(),Zt.empty(),0)}},{key:"newFoundDocument",value:function(t,n,r,i){return new e(t,1,n,te.min(),r,i,0)}},{key:"newNoDocument",value:function(t,n){return new e(t,2,n,te.min(),te.min(),Zt.empty(),0)}},{key:"newUnknownDocument",value:function(t,n){return new e(t,3,n,te.min(),te.min(),Zt.empty(),2)}}]),e}(),nn=function e(t,n){Object(h.a)(this,e),this.position=t,this.inclusive=n};function rn(e,t,n){for(var r=0,i=0;i<e.position.length;i++){var a=t[i],u=e.position[i];if(r=a.field.isKeyField()?ue.comparator(ue.fromName(u.referenceValue),n.key):Lt(u,n.data.field(a.field)),"desc"===a.dir&&(r*=-1),0!==r)break}return r}function an(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(var n=0;n<e.position.length;n++)if(!Mt(e.position[n],t.position[n]))return!1;return!0}var un=function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"asc";Object(h.a)(this,e),this.field=t,this.dir=n};function on(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}var sn=function e(){Object(h.a)(this,e)},cn=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r,i){var a;return Object(h.a)(this,n),(a=t.call(this)).field=e,a.op=r,a.value=i,a}return Object(d.a)(n,[{key:"matches",value:function(e){var t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Lt(t,this.value)):null!==t&&Ft(this.value)===Ft(t)&&this.matchesComparison(Lt(t,this.value))}},{key:"matchesComparison",value:function(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return R()}}},{key:"isInequality",value:function(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}},{key:"getFlattenedFilters",value:function(){return[this]}},{key:"getFilters",value:function(){return[this]}},{key:"getFirstInequalityField",value:function(){return this.isInequality()?this.field:null}}],[{key:"create",value:function(e,t,r){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,r):new gn(e,t,r):"array-contains"===t?new xn(e,r):"in"===t?new In(e,r):"not-in"===t?new On(e,r):"array-contains-any"===t?new En(e,r):new n(e,t,r)}},{key:"createKeyFieldInFilter",value:function(e,t,n){return"in"===t?new kn(e,n):new bn(e,n)}}]),n}(sn),ln=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this)).filters=e,i.op=r,i.ht=null,i}return Object(d.a)(n,[{key:"matches",value:function(e){return fn(this)?void 0===this.filters.find((function(t){return!t.matches(e)})):void 0!==this.filters.find((function(t){return t.matches(e)}))}},{key:"getFlattenedFilters",value:function(){return null!==this.ht||(this.ht=this.filters.reduce((function(e,t){return e.concat(t.getFlattenedFilters())}),[])),this.ht}},{key:"getFilters",value:function(){return Object.assign([],this.filters)}},{key:"getFirstInequalityField",value:function(){var e=this.lt((function(e){return e.isInequality()}));return null!==e?e.field:null}},{key:"lt",value:function(e){var t,n=w(this.getFlattenedFilters());try{for(n.s();!(t=n.n()).done;){var r=t.value;if(e(r))return r}}catch(i){n.e(i)}finally{n.f()}return null}}],[{key:"create",value:function(e,t){return new n(e,t)}}]),n}(sn);function fn(e){return"and"===e.op}function hn(e){return"or"===e.op}function dn(e){return vn(e)&&fn(e)}function vn(e){var t,n=w(e.filters);try{for(n.s();!(t=n.n()).done;){if(t.value instanceof ln)return!1}}catch(r){n.e(r)}finally{n.f()}return!0}function yn(e,t){return e instanceof cn?function(e,t){return t instanceof cn&&e.op===t.op&&e.field.isEqual(t.field)&&Mt(e.value,t.value)}(e,t):e instanceof ln?function(e,t){return t instanceof ln&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce((function(e,n,r){return e&&yn(n,t.filters[r])}),!0)}(e,t):void R()}function pn(e,t){var n=e.filters.concat(t);return ln.create(n,e.op)}function mn(e){return e instanceof cn?function(e){return"".concat(e.field.canonicalString()," ").concat(e.op," ").concat(qt(e.value))}(e):e instanceof ln?function(e){return e.op.toString()+" {"+e.getFilters().map(mn).join(" ,")+"}"}(e):"Filter"}var gn=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r,i){var a;return Object(h.a)(this,n),(a=t.call(this,e,r,i)).key=ue.fromName(i.referenceValue),a}return Object(d.a)(n,[{key:"matches",value:function(e){var t=ue.comparator(e.key,this.key);return this.matchesComparison(t)}}]),n}(cn),kn=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this,e,"in",r)).keys=wn("in",r),i}return Object(d.a)(n,[{key:"matches",value:function(e){return this.keys.some((function(t){return t.isEqual(e.key)}))}}]),n}(cn),bn=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this,e,"not-in",r)).keys=wn("not-in",r),i}return Object(d.a)(n,[{key:"matches",value:function(e){return!this.keys.some((function(t){return t.isEqual(e.key)}))}}]),n}(cn);function wn(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((function(e){return ue.fromName(e.referenceValue)}))}var xn=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){return Object(h.a)(this,n),t.call(this,e,"array-contains",r)}return Object(d.a)(n,[{key:"matches",value:function(e){var t=e.data.field(this.field);return Kt(t)&&Vt(t.arrayValue,this.value)}}]),n}(cn),In=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){return Object(h.a)(this,n),t.call(this,e,"in",r)}return Object(d.a)(n,[{key:"matches",value:function(e){var t=e.data.field(this.field);return null!==t&&Vt(this.value.arrayValue,t)}}]),n}(cn),On=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){return Object(h.a)(this,n),t.call(this,e,"not-in",r)}return Object(d.a)(n,[{key:"matches",value:function(e){if(Vt(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var t=e.data.field(this.field);return null!==t&&!Vt(this.value.arrayValue,t)}}]),n}(cn),En=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){return Object(h.a)(this,n),t.call(this,e,"array-contains-any",r)}return Object(d.a)(n,[{key:"matches",value:function(e){var t=this,n=e.data.field(this.field);return!(!Kt(n)||!n.arrayValue.values)&&n.arrayValue.values.some((function(e){return Vt(t.value.arrayValue,e)}))}}]),n}(cn),Tn=function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;Object(h.a)(this,e),this.path=t,this.collectionGroup=n,this.orderBy=r,this.filters=i,this.limit=a,this.startAt=u,this.endAt=o,this.ft=null};function Sn(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;return new Tn(e,t,n,r,i,a,u)}function _n(e){var t=V(e);if(null===t.ft){var n=t.path.canonicalString();null!==t.collectionGroup&&(n+="|cg:"+t.collectionGroup),n+="|f:",n+=t.filters.map((function(e){return function e(t){if(t instanceof cn)return t.field.canonicalString()+t.op.toString()+qt(t.value);if(dn(t))return t.filters.map((function(t){return e(t)})).join(",");var n=t.filters.map((function(t){return e(t)})).join(",");return"".concat(t.op,"(").concat(n,")")}(e)})).join(","),n+="|ob:",n+=t.orderBy.map((function(e){return function(e){return e.field.canonicalString()+e.dir}(e)})).join(","),Ne(t.limit)||(n+="|l:",n+=t.limit),t.startAt&&(n+="|lb:",n+=t.startAt.inclusive?"b:":"a:",n+=t.startAt.position.map((function(e){return qt(e)})).join(",")),t.endAt&&(n+="|ub:",n+=t.endAt.inclusive?"a:":"b:",n+=t.endAt.position.map((function(e){return qt(e)})).join(",")),t.ft=n}return t.ft}function jn(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(var n=0;n<e.orderBy.length;n++)if(!on(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(var r=0;r<e.filters.length;r++)if(!yn(e.filters[r],t.filters[r]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!an(e.startAt,t.startAt)&&an(e.endAt,t.endAt)}function Dn(e){return ue.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function An(e,t){return e.filters.filter((function(e){return e instanceof cn&&e.field.isEqual(t)}))}function Cn(e,t,n){var r,i=Rt,a=!0,u=w(An(e,t));try{for(u.s();!(r=u.n()).done;){var o=r.value,s=Rt,c=!0;switch(o.op){case"<":case"<=":s=Xt(o.value);break;case"==":case"in":case">=":s=o.value;break;case">":s=o.value,c=!1;break;case"!=":case"not-in":s=Rt}Jt({value:i,inclusive:a},{value:s,inclusive:c})<0&&(i=s,a=c)}}catch(h){u.e(h)}finally{u.f()}if(null!==n)for(var l=0;l<e.orderBy.length;++l)if(e.orderBy[l].field.isEqual(t)){var f=n.position[l];Jt({value:i,inclusive:a},{value:f,inclusive:n.inclusive})<0&&(i=f,a=n.inclusive);break}return{value:i,inclusive:a}}function Nn(e,t,n){var r,i=Nt,a=!0,u=w(An(e,t));try{for(u.s();!(r=u.n()).done;){var o=r.value,s=Nt,c=!0;switch(o.op){case">=":case">":s=Yt(o.value),c=!1;break;case"==":case"in":case"<=":s=o.value;break;case"<":s=o.value,c=!1;break;case"!=":case"not-in":s=Nt}$t({value:i,inclusive:a},{value:s,inclusive:c})>0&&(i=s,a=c)}}catch(h){u.e(h)}finally{u.f()}if(null!==n)for(var l=0;l<e.orderBy.length;++l)if(e.orderBy[l].field.isEqual(t)){var f=n.position[l];$t({value:i,inclusive:a},{value:f,inclusive:n.inclusive})>0&&(i=f,a=n.inclusive);break}return{value:i,inclusive:a}}var Rn=function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"F",o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;Object(h.a)(this,e),this.path=t,this.collectionGroup=n,this.explicitOrderBy=r,this.filters=i,this.limit=a,this.limitType=u,this.startAt=o,this.endAt=s,this.dt=null,this._t=null,this.startAt,this.endAt};function Fn(e,t,n,r,i,a,u,o){return new Rn(e,t,n,r,i,a,u,o)}function Mn(e){return new Rn(e)}function Vn(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Ln(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}function Pn(e){var t,n=w(e.filters);try{for(n.s();!(t=n.n()).done;){var r=t.value.getFirstInequalityField();if(null!==r)return r}}catch(i){n.e(i)}finally{n.f()}return null}function qn(e){return null!==e.collectionGroup}function Un(e){var t=V(e);if(null===t.dt){t.dt=[];var n=Pn(t),r=Ln(t);if(null!==n&&null===r)n.isKeyField()||t.dt.push(new un(n)),t.dt.push(new un(ae.keyField(),"asc"));else{var i,a=!1,u=w(t.explicitOrderBy);try{for(u.s();!(i=u.n()).done;){var o=i.value;t.dt.push(o),o.field.isKeyField()&&(a=!0)}}catch(c){u.e(c)}finally{u.f()}if(!a){var s=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.dt.push(new un(ae.keyField(),s))}}}return t.dt}function Bn(e){var t=V(e);if(!t._t)if("F"===t.limitType)t._t=Sn(t.path,t.collectionGroup,Un(t),t.filters,t.limit,t.startAt,t.endAt);else{var n,r=[],i=w(Un(t));try{for(i.s();!(n=i.n()).done;){var a=n.value,u="desc"===a.dir?"asc":"desc";r.push(new un(a.field,u))}}catch(c){i.e(c)}finally{i.f()}var o=t.endAt?new nn(t.endAt.position,t.endAt.inclusive):null,s=t.startAt?new nn(t.startAt.position,t.startAt.inclusive):null;t._t=Sn(t.path,t.collectionGroup,r,t.filters,t.limit,o,s)}return t._t}function Kn(e,t){t.getFirstInequalityField(),Pn(e);var n=e.filters.concat([t]);return new Rn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function zn(e,t,n){return new Rn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Gn(e,t){return jn(Bn(e),Bn(t))&&e.limitType===t.limitType}function Qn(e){return"".concat(_n(Bn(e)),"|lt:").concat(e.limitType)}function Wn(e){return"Query(target=".concat(function(e){var t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=", filters: [".concat(e.filters.map((function(e){return mn(e)})).join(", "),"]")),Ne(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=", orderBy: [".concat(e.orderBy.map((function(e){return function(e){return"".concat(e.field.canonicalString()," (").concat(e.dir,")")}(e)})).join(", "),"]")),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((function(e){return qt(e)})).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((function(e){return qt(e)})).join(",")),"Target(".concat(t,")")}(Bn(e)),"; limitType=").concat(e.limitType,")")}function Hn(e,t){return t.isFoundDocument()&&function(e,t){var n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):ue.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){var n,r=w(Un(e));try{for(r.s();!(n=r.n()).done;){var i=n.value;if(!i.field.isKeyField()&&null===t.data.field(i.field))return!1}}catch(a){r.e(a)}finally{r.f()}return!0}(e,t)&&function(e,t){var n,r=w(e.filters);try{for(r.s();!(n=r.n()).done;){if(!n.value.matches(t))return!1}}catch(i){r.e(i)}finally{r.f()}return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){var r=rn(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,Un(e),t))&&!(e.endAt&&!function(e,t,n){var r=rn(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,Un(e),t))}(e,t)}function Xn(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Yn(e){return function(t,n){var r,i=!1,a=w(Un(e));try{for(a.s();!(r=a.n()).done;){var u=r.value,o=Jn(u,t,n);if(0!==o)return o;i=i||u.field.isKeyField()}}catch(s){a.e(s)}finally{a.f()}return 0}}function Jn(e,t,n){var r=e.field.isKeyField()?ue.comparator(t.key,n.key):function(e,t,n){var r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?Lt(r,i):R()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return R()}}var $n=function(){function e(t,n){Object(h.a)(this,e),this.mapKeyFn=t,this.equalsFn=n,this.inner={},this.innerSize=0}return Object(d.a)(e,[{key:"get",value:function(e){var t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n){var r,i=w(n);try{for(i.s();!(r=i.n()).done;){var u=Object(a.a)(r.value,2),o=u[0],s=u[1];if(this.equalsFn(o,e))return s}}catch(c){i.e(c)}finally{i.f()}}}},{key:"has",value:function(e){return void 0!==this.get(e)}},{key:"set",value:function(e,t){var n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(var i=0;i<r.length;i++)if(this.equalsFn(r[i][0],e))return void(r[i]=[e,t]);r.push([e,t]),this.innerSize++}},{key:"delete",value:function(e){var t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(var r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}},{key:"forEach",value:function(e){ht(this.inner,(function(t,n){var r,i=w(n);try{for(i.s();!(r=i.n()).done;){var u=Object(a.a)(r.value,2),o=u[0],s=u[1];e(o,s)}}catch(c){i.e(c)}finally{i.f()}}))}},{key:"isEmpty",value:function(){return dt(this.inner)}},{key:"size",value:function(){return this.innerSize}}]),e}(),Zn=new vt(ue.comparator);function er(){return Zn}var tr=new vt(ue.comparator);function nr(){for(var e=tr,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(var i=0,a=n;i<a.length;i++){var u=a[i];e=e.insert(u.key,u)}return e}function rr(e){var t=tr;return e.forEach((function(e,n){return t=t.insert(e,n.overlayedDocument)})),t}function ir(){return ur()}function ar(){return ur()}function ur(){return new $n((function(e){return e.toString()}),(function(e,t){return e.isEqual(t)}))}var or=new vt(ue.comparator),sr=new mt(ue.comparator);function cr(){for(var e=sr,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(var i=0,a=n;i<a.length;i++){var u=a[i];e=e.add(u)}return e}var lr=new mt(J);function fr(){return lr}function hr(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Re(t)?"-0":t}}function dr(e){return{integerValue:""+e}}function vr(e,t){return Fe(t)?dr(t):hr(e,t)}var yr=function e(){Object(h.a)(this,e),this._=void 0};function pr(e,t,n){return e instanceof kr?function(e,t){var n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&_t(t)&&(t=jt(t)),t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof br?wr(e,t):e instanceof xr?Ir(e,t):function(e,t){var n=gr(e,t),r=Er(n)+Er(e.wt);return Bt(n)&&Bt(e.wt)?dr(r):hr(e.serializer,r)}(e,t)}function mr(e,t,n){return e instanceof br?wr(e,t):e instanceof xr?Ir(e,t):n}function gr(e,t){return e instanceof Or?Bt(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}var kr=function(e){Object(s.a)(n,e);var t=I(n);function n(){return Object(h.a)(this,n),t.apply(this,arguments)}return n}(yr),br=function(e){Object(s.a)(n,e);var t=I(n);function n(e){var r;return Object(h.a)(this,n),(r=t.call(this)).elements=e,r}return n}(yr);function wr(e,t){var n,r=Tr(t),i=w(e.elements);try{var a=function(){var e=n.value;r.some((function(t){return Mt(t,e)}))||r.push(e)};for(i.s();!(n=i.n()).done;)a()}catch(u){i.e(u)}finally{i.f()}return{arrayValue:{values:r}}}var xr=function(e){Object(s.a)(n,e);var t=I(n);function n(e){var r;return Object(h.a)(this,n),(r=t.call(this)).elements=e,r}return n}(yr);function Ir(e,t){var n,r=Tr(t),i=w(e.elements);try{var a=function(){var e=n.value;r=r.filter((function(t){return!Mt(t,e)}))};for(i.s();!(n=i.n()).done;)a()}catch(u){i.e(u)}finally{i.f()}return{arrayValue:{values:r}}}var Or=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this)).serializer=e,i.wt=r,i}return n}(yr);function Er(e){return Tt(e.integerValue||e.doubleValue)}function Tr(e){return Kt(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}var Sr=function e(t,n){Object(h.a)(this,e),this.field=t,this.transform=n};var _r=function e(t,n){Object(h.a)(this,e),this.version=t,this.transformResults=n},jr=function(){function e(t,n){Object(h.a)(this,e),this.updateTime=t,this.exists=n}return Object(d.a)(e,[{key:"isNone",get:function(){return void 0===this.updateTime&&void 0===this.exists}},{key:"isEqual",value:function(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}],[{key:"none",value:function(){return new e}},{key:"exists",value:function(t){return new e(void 0,t)}},{key:"updateTime",value:function(t){return new e(t)}}]),e}();function Dr(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}var Ar=function e(){Object(h.a)(this,e)};function Cr(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new zr(e.key,jr.none()):new Vr(e.key,e.data,jr.none());var n,r=e.data,i=Zt.empty(),a=new mt(ae.comparator),u=w(t.fields);try{for(u.s();!(n=u.n()).done;){var o=n.value;if(!a.has(o)){var s=r.field(o);null===s&&o.length>1&&(o=o.popLast(),s=r.field(o)),null===s?i.delete(o):i.set(o,s),a=a.add(o)}}}catch(c){u.e(c)}finally{u.f()}return new Lr(e.key,i,new bt(a.toArray()),jr.none())}function Nr(e,t,n){e instanceof Vr?function(e,t,n){var r=e.value.clone(),i=qr(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof Lr?function(e,t,n){if(Dr(e.precondition,t)){var r=qr(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(Pr(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}else t.convertToUnknownDocument(n.version)}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function Rr(e,t,n,r){return e instanceof Vr?function(e,t,n,r){if(!Dr(e.precondition,t))return n;var i=e.value.clone(),a=Ur(e.fieldTransforms,r,t);return i.setAll(a),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof Lr?function(e,t,n,r){if(!Dr(e.precondition,t))return n;var i=Ur(e.fieldTransforms,r,t),a=t.data;return a.setAll(Pr(e)),a.setAll(i),t.convertToFoundDocument(t.version,a).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((function(e){return e.field})))}(e,t,n,r):function(e,t,n){return Dr(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function Fr(e,t){var n,r=null,i=w(e.fieldTransforms);try{for(i.s();!(n=i.n()).done;){var a=n.value,u=t.data.field(a.field),o=gr(a.transform,u||null);null!=o&&(null===r&&(r=Zt.empty()),r.set(a.field,o))}}catch(s){i.e(s)}finally{i.f()}return r||null}function Mr(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&$(e,t,(function(e,t){return function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof br&&t instanceof br||e instanceof xr&&t instanceof xr?$(e.elements,t.elements,Mt):e instanceof Or&&t instanceof Or?Mt(e.wt,t.wt):e instanceof kr&&t instanceof kr}(e.transform,t.transform)}(e,t)}))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}var Vr=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r,i){var a,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];return Object(h.a)(this,n),(a=t.call(this)).key=e,a.value=r,a.precondition=i,a.fieldTransforms=u,a.type=0,a}return Object(d.a)(n,[{key:"getFieldMask",value:function(){return null}}]),n}(Ar),Lr=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r,i,a){var u,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];return Object(h.a)(this,n),(u=t.call(this)).key=e,u.data=r,u.fieldMask=i,u.precondition=a,u.fieldTransforms=o,u.type=1,u}return Object(d.a)(n,[{key:"getFieldMask",value:function(){return this.fieldMask}}]),n}(Ar);function Pr(e){var t=new Map;return e.fieldMask.fields.forEach((function(n){if(!n.isEmpty()){var r=e.data.field(n);t.set(n,r)}})),t}function qr(e,t,n){var r=new Map;F(e.length===n.length);for(var i=0;i<n.length;i++){var a=e[i],u=a.transform,o=t.data.field(a.field);r.set(a.field,mr(u,o,n[i]))}return r}function Ur(e,t,n){var r,i=new Map,a=w(e);try{for(a.s();!(r=a.n()).done;){var u=r.value,o=u.transform,s=n.data.field(u.field);i.set(u.field,pr(o,s,t))}}catch(c){a.e(c)}finally{a.f()}return i}var Br,Kr,zr=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this)).key=e,i.precondition=r,i.type=2,i.fieldTransforms=[],i}return Object(d.a)(n,[{key:"getFieldMask",value:function(){return null}}]),n}(Ar),Gr=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this)).key=e,i.precondition=r,i.type=3,i.fieldTransforms=[],i}return Object(d.a)(n,[{key:"getFieldMask",value:function(){return null}}]),n}(Ar),Qr=function(){function e(t,n,r,i){Object(h.a)(this,e),this.batchId=t,this.localWriteTime=n,this.baseMutations=r,this.mutations=i}return Object(d.a)(e,[{key:"applyToRemoteDocument",value:function(e,t){for(var n=t.mutationResults,r=0;r<this.mutations.length;r++){var i=this.mutations[r];i.key.isEqual(e.key)&&Nr(i,e,n[r])}}},{key:"applyToLocalView",value:function(e,t){var n,r=w(this.baseMutations);try{for(r.s();!(n=r.n()).done;){var i=n.value;i.key.isEqual(e.key)&&(t=Rr(i,e,t,this.localWriteTime))}}catch(s){r.e(s)}finally{r.f()}var a,u=w(this.mutations);try{for(u.s();!(a=u.n()).done;){var o=a.value;o.key.isEqual(e.key)&&(t=Rr(o,e,t,this.localWriteTime))}}catch(s){u.e(s)}finally{u.f()}return t}},{key:"applyToLocalDocumentSet",value:function(e,t){var n=this,r=ar();return this.mutations.forEach((function(i){var a=e.get(i.key),u=a.overlayedDocument,o=n.applyToLocalView(u,a.mutatedFields),s=Cr(u,o=t.has(i.key)?null:o);null!==s&&r.set(i.key,s),u.isValidDocument()||u.convertToNoDocument(te.min())})),r}},{key:"keys",value:function(){return this.mutations.reduce((function(e,t){return e.add(t.key)}),cr())}},{key:"isEqual",value:function(e){return this.batchId===e.batchId&&$(this.mutations,e.mutations,(function(e,t){return Mr(e,t)}))&&$(this.baseMutations,e.baseMutations,(function(e,t){return Mr(e,t)}))}}]),e}(),Wr=function(){function e(t,n,r,i){Object(h.a)(this,e),this.batch=t,this.commitVersion=n,this.mutationResults=r,this.docVersions=i}return Object(d.a)(e,null,[{key:"from",value:function(t,n,r){F(t.mutations.length===r.length);for(var i=or,a=t.mutations,u=0;u<a.length;u++)i=i.insert(a[u].key,r[u].version);return new e(t,n,r,i)}}]),e}(),Hr=function(){function e(t,n){Object(h.a)(this,e),this.largestBatchId=t,this.mutation=n}return Object(d.a)(e,[{key:"getKey",value:function(){return this.mutation.key}},{key:"isEqual",value:function(e){return null!==e&&this.mutation===e.mutation}},{key:"toString",value:function(){return"Overlay{\n      largestBatchId: ".concat(this.largestBatchId,",\n      mutation: ").concat(this.mutation.toString(),"\n    }")}}]),e}(),Xr=function e(t,n){Object(h.a)(this,e),this.count=t,this.unchangedNames=n};function Yr(e){switch(e){default:return R();case L.CANCELLED:case L.UNKNOWN:case L.DEADLINE_EXCEEDED:case L.RESOURCE_EXHAUSTED:case L.INTERNAL:case L.UNAVAILABLE:case L.UNAUTHENTICATED:return!1;case L.INVALID_ARGUMENT:case L.NOT_FOUND:case L.ALREADY_EXISTS:case L.PERMISSION_DENIED:case L.FAILED_PRECONDITION:case L.ABORTED:case L.OUT_OF_RANGE:case L.UNIMPLEMENTED:case L.DATA_LOSS:return!0}}function Jr(e){if(void 0===e)return A("GRPC error has no .code"),L.UNKNOWN;switch(e){case Br.OK:return L.OK;case Br.CANCELLED:return L.CANCELLED;case Br.UNKNOWN:return L.UNKNOWN;case Br.DEADLINE_EXCEEDED:return L.DEADLINE_EXCEEDED;case Br.RESOURCE_EXHAUSTED:return L.RESOURCE_EXHAUSTED;case Br.INTERNAL:return L.INTERNAL;case Br.UNAVAILABLE:return L.UNAVAILABLE;case Br.UNAUTHENTICATED:return L.UNAUTHENTICATED;case Br.INVALID_ARGUMENT:return L.INVALID_ARGUMENT;case Br.NOT_FOUND:return L.NOT_FOUND;case Br.ALREADY_EXISTS:return L.ALREADY_EXISTS;case Br.PERMISSION_DENIED:return L.PERMISSION_DENIED;case Br.FAILED_PRECONDITION:return L.FAILED_PRECONDITION;case Br.ABORTED:return L.ABORTED;case Br.OUT_OF_RANGE:return L.OUT_OF_RANGE;case Br.UNIMPLEMENTED:return L.UNIMPLEMENTED;case Br.DATA_LOSS:return L.DATA_LOSS;default:return R()}}(Kr=Br||(Br={}))[Kr.OK=0]="OK",Kr[Kr.CANCELLED=1]="CANCELLED",Kr[Kr.UNKNOWN=2]="UNKNOWN",Kr[Kr.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Kr[Kr.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Kr[Kr.NOT_FOUND=5]="NOT_FOUND",Kr[Kr.ALREADY_EXISTS=6]="ALREADY_EXISTS",Kr[Kr.PERMISSION_DENIED=7]="PERMISSION_DENIED",Kr[Kr.UNAUTHENTICATED=16]="UNAUTHENTICATED",Kr[Kr.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Kr[Kr.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Kr[Kr.ABORTED=10]="ABORTED",Kr[Kr.OUT_OF_RANGE=11]="OUT_OF_RANGE",Kr[Kr.UNIMPLEMENTED=12]="UNIMPLEMENTED",Kr[Kr.INTERNAL=13]="INTERNAL",Kr[Kr.UNAVAILABLE=14]="UNAVAILABLE",Kr[Kr.DATA_LOSS=15]="DATA_LOSS";var $r=function(){function e(){Object(h.a)(this,e),this.onExistenceFilterMismatchCallbacks=new Map}return Object(d.a)(e,[{key:"onExistenceFilterMismatch",value:function(e){var t=this,n=Symbol();return this.onExistenceFilterMismatchCallbacks.set(n,e),function(){return t.onExistenceFilterMismatchCallbacks.delete(n)}}},{key:"notifyOnExistenceFilterMismatch",value:function(e){this.onExistenceFilterMismatchCallbacks.forEach((function(t){return t(e)}))}}],[{key:"instance",get:function(){return Zr}},{key:"getOrCreateInstance",value:function(){return null===Zr&&(Zr=new e),Zr}}]),e}(),Zr=null;function ei(){return new TextEncoder}var ti=new b.e([4294967295,4294967295],0);function ni(e){var t=ei().encode(e),n=new b.f;return n.update(t),new Uint8Array(n.digest())}function ri(e){var t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),a=t.getUint32(12,!0);return[new b.e([n,r],0),new b.e([i,a],0)]}var ii=function(){function e(t,n,r){if(Object(h.a)(this,e),this.bitmap=t,this.padding=n,this.hashCount=r,n<0||n>=8)throw new ai("Invalid padding: ".concat(n));if(r<0)throw new ai("Invalid hash count: ".concat(r));if(t.length>0&&0===this.hashCount)throw new ai("Invalid hash count: ".concat(r));if(0===t.length&&0!==n)throw new ai("Invalid padding when bitmap length is 0: ".concat(n));this.yt=8*t.length-n,this.It=b.e.fromNumber(this.yt)}return Object(d.a)(e,[{key:"Tt",value:function(e,t,n){var r=e.add(t.multiply(b.e.fromNumber(n)));return 1===r.compare(ti)&&(r=new b.e([r.getBits(0),r.getBits(1)],0)),r.modulo(this.It).toNumber()}},{key:"Et",value:function(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}},{key:"At",value:function(e){if(0===this.yt)return!1;for(var t=ri(ni(e)),n=Object(a.a)(t,2),r=n[0],i=n[1],u=0;u<this.hashCount;u++){var o=this.Tt(r,i,u);if(!this.Et(o))return!1}return!0}},{key:"insert",value:function(e){if(0!==this.yt)for(var t=ri(ni(e)),n=Object(a.a)(t,2),r=n[0],i=n[1],u=0;u<this.hashCount;u++){var o=this.Tt(r,i,u);this.Rt(o)}}},{key:"Rt",value:function(e){var t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}],[{key:"create",value:function(t,n,r){var i=t%8==0?0:8-t%8,a=new e(new Uint8Array(Math.ceil(t/8)),i,n);return r.forEach((function(e){return a.insert(e)})),a}}]),e}(),ai=function(e){Object(s.a)(n,e);var t=I(n);function n(){var e;return Object(h.a)(this,n),(e=t.apply(this,arguments)).name="BloomFilterError",e}return n}(Object(u.a)(Error)),ui=function(){function e(t,n,r,i,a){Object(h.a)(this,e),this.snapshotVersion=t,this.targetChanges=n,this.targetMismatches=r,this.documentUpdates=i,this.resolvedLimboDocuments=a}return Object(d.a)(e,null,[{key:"createSynthesizedRemoteEventForCurrentChange",value:function(t,n,r){var i=new Map;return i.set(t,oi.createSynthesizedTargetChangeForCurrentChange(t,n,r)),new e(te.min(),i,new vt(J),er(),cr())}}]),e}(),oi=function(){function e(t,n,r,i,a){Object(h.a)(this,e),this.resumeToken=t,this.current=n,this.addedDocuments=r,this.modifiedDocuments=i,this.removedDocuments=a}return Object(d.a)(e,null,[{key:"createSynthesizedTargetChangeForCurrentChange",value:function(t,n,r){return new e(r,n,cr(),cr(),cr())}}]),e}(),si=function e(t,n,r,i){Object(h.a)(this,e),this.vt=t,this.removedTargetIds=n,this.key=r,this.Pt=i},ci=function e(t,n){Object(h.a)(this,e),this.targetId=t,this.bt=n},li=function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:It.EMPTY_BYTE_STRING,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;Object(h.a)(this,e),this.state=t,this.targetIds=n,this.resumeToken=r,this.cause=i},fi=function(){function e(){Object(h.a)(this,e),this.Vt=0,this.St=vi(),this.Dt=It.EMPTY_BYTE_STRING,this.Ct=!1,this.xt=!0}return Object(d.a)(e,[{key:"current",get:function(){return this.Ct}},{key:"resumeToken",get:function(){return this.Dt}},{key:"Nt",get:function(){return 0!==this.Vt}},{key:"kt",get:function(){return this.xt}},{key:"Mt",value:function(e){e.approximateByteSize()>0&&(this.xt=!0,this.Dt=e)}},{key:"Ot",value:function(){var e=cr(),t=cr(),n=cr();return this.St.forEach((function(r,i){switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:R()}})),new oi(this.Dt,this.Ct,e,t,n)}},{key:"$t",value:function(){this.xt=!1,this.St=vi()}},{key:"Ft",value:function(e,t){this.xt=!0,this.St=this.St.insert(e,t)}},{key:"Bt",value:function(e){this.xt=!0,this.St=this.St.remove(e)}},{key:"Lt",value:function(){this.Vt+=1}},{key:"qt",value:function(){this.Vt-=1}},{key:"Ut",value:function(){this.xt=!0,this.Ct=!0}}]),e}(),hi=function(){function e(t){Object(h.a)(this,e),this.Kt=t,this.Gt=new Map,this.Qt=er(),this.jt=di(),this.zt=new vt(J)}return Object(d.a)(e,[{key:"Wt",value:function(e){var t,n=w(e.vt);try{for(n.s();!(t=n.n()).done;){var r=t.value;e.Pt&&e.Pt.isFoundDocument()?this.Ht(r,e.Pt):this.Jt(r,e.key,e.Pt)}}catch(o){n.e(o)}finally{n.f()}var i,a=w(e.removedTargetIds);try{for(a.s();!(i=a.n()).done;){var u=i.value;this.Jt(u,e.key,e.Pt)}}catch(o){a.e(o)}finally{a.f()}}},{key:"Yt",value:function(e){var t=this;this.forEachTarget(e,(function(n){var r=t.Xt(n);switch(e.state){case 0:t.Zt(n)&&r.Mt(e.resumeToken);break;case 1:r.qt(),r.Nt||r.$t(),r.Mt(e.resumeToken);break;case 2:r.qt(),r.Nt||t.removeTarget(n);break;case 3:t.Zt(n)&&(r.Ut(),r.Mt(e.resumeToken));break;case 4:t.Zt(n)&&(t.te(n),r.Mt(e.resumeToken));break;default:R()}}))}},{key:"forEachTarget",value:function(e,t){var n=this;e.targetIds.length>0?e.targetIds.forEach(t):this.Gt.forEach((function(e,r){n.Zt(r)&&t(r)}))}},{key:"ee",value:function(e){var t,n=e.targetId,r=e.bt.count,i=this.ne(n);if(i){var a=i.target;if(Dn(a))if(0===r){var u=new ue(a.path);this.Jt(n,u,tn.newNoDocument(u,te.min()))}else F(1===r);else{var o=this.se(n);if(o!==r){var s=this.ie(e,o);if(0!==s){this.te(n);var c=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.zt=this.zt.insert(n,c)}null===(t=$r.instance)||void 0===t||t.notifyOnExistenceFilterMismatch(function(e,t,n){var r,i,a,u,o,s,c={localCacheCount:t,existenceFilterCount:n.count},l=n.unchangedNames;return l&&(c.bloomFilter={applied:0===e,hashCount:null!==(r=null==l?void 0:l.hashCount)&&void 0!==r?r:0,bitmapLength:null!==(u=null===(a=null===(i=null==l?void 0:l.bits)||void 0===i?void 0:i.bitmap)||void 0===a?void 0:a.length)&&void 0!==u?u:0,padding:null!==(s=null===(o=null==l?void 0:l.bits)||void 0===o?void 0:o.padding)&&void 0!==s?s:0}),c}(s,o,e.bt))}}}}},{key:"ie",value:function(e,t){var n=e.bt,r=n.unchangedNames,i=n.count;if(!r||!r.bits)return 1;var a,u,o=r.bits,s=o.bitmap,c=void 0===s?"":s,l=o.padding,f=void 0===l?0:l,h=r.hashCount,d=void 0===h?0:h;try{a=St(c).toUint8Array()}catch(e){if(e instanceof wt)return C("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),1;throw e}try{u=new ii(a,f,d)}catch(e){return C(e instanceof ai?"BloomFilter error: ":"Applying bloom filter failed: ",e),1}return 0===u.yt?1:i!==t-this.re(e.targetId,u)?2:0}},{key:"re",value:function(e,t){var n=this,r=this.Kt.getRemoteKeysForTarget(e),i=0;return r.forEach((function(r){var a=n.Kt.oe(),u="projects/".concat(a.projectId,"/databases/").concat(a.database,"/documents/").concat(r.path.canonicalString());t.At(u)||(n.Jt(e,r,null),i++)})),i}},{key:"ue",value:function(e){var t=this,n=new Map;this.Gt.forEach((function(r,i){var a=t.ne(i);if(a){if(r.current&&Dn(a.target)){var u=new ue(a.target.path);null!==t.Qt.get(u)||t.ce(i,u)||t.Jt(i,u,tn.newNoDocument(u,e))}r.kt&&(n.set(i,r.Ot()),r.$t())}}));var r=cr();this.jt.forEach((function(e,n){var i=!0;n.forEachWhile((function(e){var n=t.ne(e);return!n||"TargetPurposeLimboResolution"===n.purpose||(i=!1,!1)})),i&&(r=r.add(e))})),this.Qt.forEach((function(t,n){return n.setReadTime(e)}));var i=new ui(e,n,this.zt,this.Qt,r);return this.Qt=er(),this.jt=di(),this.zt=new vt(J),i}},{key:"Ht",value:function(e,t){if(this.Zt(e)){var n=this.ce(e,t.key)?2:0;this.Xt(e).Ft(t.key,n),this.Qt=this.Qt.insert(t.key,t),this.jt=this.jt.insert(t.key,this.ae(t.key).add(e))}}},{key:"Jt",value:function(e,t,n){if(this.Zt(e)){var r=this.Xt(e);this.ce(e,t)?r.Ft(t,1):r.Bt(t),this.jt=this.jt.insert(t,this.ae(t).delete(e)),n&&(this.Qt=this.Qt.insert(t,n))}}},{key:"removeTarget",value:function(e){this.Gt.delete(e)}},{key:"se",value:function(e){var t=this.Xt(e).Ot();return this.Kt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}},{key:"Lt",value:function(e){this.Xt(e).Lt()}},{key:"Xt",value:function(e){var t=this.Gt.get(e);return t||(t=new fi,this.Gt.set(e,t)),t}},{key:"ae",value:function(e){var t=this.jt.get(e);return t||(t=new mt(J),this.jt=this.jt.insert(e,t)),t}},{key:"Zt",value:function(e){var t=null!==this.ne(e);return t||D("WatchChangeAggregator","Detected inactive target",e),t}},{key:"ne",value:function(e){var t=this.Gt.get(e);return t&&t.Nt?null:this.Kt.he(e)}},{key:"te",value:function(e){var t=this;this.Gt.set(e,new fi),this.Kt.getRemoteKeysForTarget(e).forEach((function(n){t.Jt(e,n,null)}))}},{key:"ce",value:function(e,t){return this.Kt.getRemoteKeysForTarget(e).has(t)}}]),e}();function di(){return new vt(ue.comparator)}function vi(){return new vt(ue.comparator)}var yi={asc:"ASCENDING",desc:"DESCENDING"},pi={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},mi={and:"AND",or:"OR"},gi=function e(t,n){Object(h.a)(this,e),this.databaseId=t,this.useProto3Json=n};function ki(e,t){return e.useProto3Json||Ne(t)?t:{value:t}}function bi(e,t){return e.useProto3Json?"".concat(new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z",""),".").concat(("000000000"+t.nanoseconds).slice(-9),"Z"):{seconds:""+t.seconds,nanos:t.nanoseconds}}function wi(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function xi(e,t){return bi(e,t.toTimestamp())}function Ii(e){return F(!!e),te.fromTimestamp(function(e){var t=Et(e);return new ee(t.seconds,t.nanos)}(e))}function Oi(e,t){return function(e){return new re(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function Ei(e){var t=re.fromString(e);return F(Qi(t)),t}function Ti(e,t){return Oi(e.databaseId,t.path)}function Si(e,t){var n=Ei(t);if(n.get(1)!==e.databaseId.projectId)throw new P(L.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new P(L.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new ue(Ai(n))}function _i(e,t){return Oi(e.databaseId,t)}function ji(e){var t=Ei(e);return 4===t.length?re.emptyPath():Ai(t)}function Di(e){return new re(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function Ai(e){return F(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function Ci(e,t,n){return{name:Ti(e,t),fields:n.value.mapValue.fields}}function Ni(e,t,n){var r=Si(e,t.name),i=Ii(t.updateTime),a=t.createTime?Ii(t.createTime):te.min(),u=new Zt({mapValue:{fields:t.fields}}),o=tn.newFoundDocument(r,i,a,u);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function Ri(e,t){return"found"in t?function(e,t){F(!!t.found),t.found.name,t.found.updateTime;var n=Si(e,t.found.name),r=Ii(t.found.updateTime),i=t.found.createTime?Ii(t.found.createTime):te.min(),a=new Zt({mapValue:{fields:t.found.fields}});return tn.newFoundDocument(n,r,i,a)}(e,t):"missing"in t?function(e,t){F(!!t.missing),F(!!t.readTime);var n=Si(e,t.missing),r=Ii(t.readTime);return tn.newNoDocument(n,r)}(e,t):R()}function Fi(e,t){var n;if(t instanceof Vr)n={update:Ci(e,t.key,t.value)};else if(t instanceof zr)n={delete:Ti(e,t.key)};else if(t instanceof Lr)n={update:Ci(e,t.key,t.data),updateMask:Gi(t.fieldMask)};else{if(!(t instanceof Gr))return R();n={verify:Ti(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((function(e){return function(e,t){var n=t.transform;if(n instanceof kr)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof br)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof xr)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Or)return{fieldPath:t.field.canonicalString(),increment:n.wt};throw R()}(0,e)}))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:xi(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:R()}(e,t.precondition)),n}function Mi(e,t){var n=t.currentDocument?function(e){return void 0!==e.updateTime?jr.updateTime(Ii(e.updateTime)):void 0!==e.exists?jr.exists(e.exists):jr.none()}(t.currentDocument):jr.none(),r=t.updateTransforms?t.updateTransforms.map((function(t){return function(e,t){var n=null;if("setToServerValue"in t)F("REQUEST_TIME"===t.setToServerValue),n=new kr;else if("appendMissingElements"in t){var r=t.appendMissingElements.values||[];n=new br(r)}else if("removeAllFromArray"in t){var i=t.removeAllFromArray.values||[];n=new xr(i)}else"increment"in t?n=new Or(e,t.increment):R();var a=ae.fromServerFormat(t.fieldPath);return new Sr(a,n)}(e,t)})):[];if(t.update){t.update.name;var i=Si(e,t.update.name),a=new Zt({mapValue:{fields:t.update.fields}});if(t.updateMask){var u=function(e){var t=e.fieldPaths||[];return new bt(t.map((function(e){return ae.fromServerFormat(e)})))}(t.updateMask);return new Lr(i,a,u,n,r)}return new Vr(i,a,n,r)}if(t.delete){var o=Si(e,t.delete);return new zr(o,n)}if(t.verify){var s=Si(e,t.verify);return new Gr(s,n)}return R()}function Vi(e,t){return{documents:[_i(e,t.path)]}}function Li(e,t){var n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=_i(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=_i(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var i=function(e){if(0!==e.length)return function e(t){return t instanceof cn?function(e){if("=="===e.op){if(Gt(e.value))return{unaryFilter:{field:Ki(e.field),op:"IS_NAN"}};if(zt(e.value))return{unaryFilter:{field:Ki(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Gt(e.value))return{unaryFilter:{field:Ki(e.field),op:"IS_NOT_NAN"}};if(zt(e.value))return{unaryFilter:{field:Ki(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Ki(e.field),op:Ui(e.op),value:e.value}}}(t):t instanceof ln?function(t){var n=t.getFilters().map((function(t){return e(t)}));return 1===n.length?n[0]:{compositeFilter:{op:Bi(t.op),filters:n}}}(t):R()}(ln.create(e,"and"))}(t.filters);i&&(n.structuredQuery.where=i);var a=function(e){if(0!==e.length)return e.map((function(e){return function(e){return{field:Ki(e.field),direction:qi(e.dir)}}(e)}))}(t.orderBy);a&&(n.structuredQuery.orderBy=a);var u,o=ki(e,t.limit);return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt={before:(u=t.startAt).inclusive,values:u.position}),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),n}function Pi(e){var t=ji(e.parent),n=e.structuredQuery,r=n.from?n.from.length:0,i=null;if(r>0){F(1===r);var a=n.from[0];a.allDescendants?i=a.collectionId:t=t.child(a.collectionId)}var u=[];n.where&&(u=function(e){var t=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":var t=zi(e.unaryFilter.field);return cn.create(t,"==",{doubleValue:NaN});case"IS_NULL":var n=zi(e.unaryFilter.field);return cn.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":var r=zi(e.unaryFilter.field);return cn.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":var i=zi(e.unaryFilter.field);return cn.create(i,"!=",{nullValue:"NULL_VALUE"});default:return R()}}(t):void 0!==t.fieldFilter?function(e){return cn.create(zi(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return R()}}(e.fieldFilter.op),e.fieldFilter.value)}(t):void 0!==t.compositeFilter?function(t){return ln.create(t.compositeFilter.filters.map((function(t){return e(t)})),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return R()}}(t.compositeFilter.op))}(t):R()}(e);return t instanceof ln&&dn(t)?t.getFilters():[t]}(n.where));var o=[];n.orderBy&&(o=n.orderBy.map((function(e){return function(e){return new un(zi(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e)})));var s=null;n.limit&&(s=function(e){var t;return Ne(t="object"==typeof e?e.value:e)?null:t}(n.limit));var c=null;n.startAt&&(c=function(e){var t=!!e.before,n=e.values||[];return new nn(n,t)}(n.startAt));var l=null;return n.endAt&&(l=function(e){var t=!e.before,n=e.values||[];return new nn(n,t)}(n.endAt)),Fn(t,i,o,u,s,"F",c,l)}function qi(e){return yi[e]}function Ui(e){return pi[e]}function Bi(e){return mi[e]}function Ki(e){return{fieldPath:e.canonicalString()}}function zi(e){return ae.fromServerFormat(e.fieldPath)}function Gi(e){var t=[];return e.fields.forEach((function(e){return t.push(e.canonicalString())})),{fieldPaths:t}}function Qi(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}var Wi=function(){function e(t,n,r,i){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:te.min(),u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:te.min(),o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:It.EMPTY_BYTE_STRING,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;Object(h.a)(this,e),this.target=t,this.targetId=n,this.purpose=r,this.sequenceNumber=i,this.snapshotVersion=a,this.lastLimboFreeSnapshotVersion=u,this.resumeToken=o,this.expectedCount=s}return Object(d.a)(e,[{key:"withSequenceNumber",value:function(t){return new e(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}},{key:"withResumeToken",value:function(t,n){return new e(this.target,this.targetId,this.purpose,this.sequenceNumber,n,this.lastLimboFreeSnapshotVersion,t,null)}},{key:"withExpectedCount",value:function(t){return new e(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}},{key:"withLastLimboFreeSnapshotVersion",value:function(t){return new e(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}}]),e}(),Hi=function e(t){Object(h.a)(this,e),this.le=t};function Xi(e,t){var n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Yi(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function(e,t){return{name:Ti(e,t.key),fields:t.data.value.mapValue.fields,updateTime:bi(e,t.version.toTimestamp()),createTime:bi(e,t.createTime.toTimestamp())}}(e.le,t);else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Ji(t.version)};else{if(!t.isUnknownDocument())return R();r.unknownDocument={path:n.path.toArray(),version:Ji(t.version)}}return r}function Yi(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Ji(e){var t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function $i(e){var t=new ee(e.seconds,e.nanoseconds);return te.fromTimestamp(t)}function Zi(e,t){for(var n=(t.baseMutations||[]).map((function(t){return Mi(e.le,t)})),r=0;r<t.mutations.length-1;++r){var i=t.mutations[r];if(r+1<t.mutations.length&&void 0!==t.mutations[r+1].transform){var a=t.mutations[r+1];i.updateTransforms=a.transform.fieldTransforms,t.mutations.splice(r+1,1),++r}}var u=t.mutations.map((function(t){return Mi(e.le,t)})),o=ee.fromMillis(t.localWriteTimeMs);return new Qr(t.batchId,o,n,u)}function ea(e){var t,n,r=$i(e.readTime),i=void 0!==e.lastLimboFreeSnapshotVersion?$i(e.lastLimboFreeSnapshotVersion):te.min();return void 0!==e.query.documents?(F(1===(n=e.query).documents.length),t=Bn(Mn(ji(n.documents[0])))):t=function(e){return Bn(Pi(e))}(e.query),new Wi(t,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,r,i,It.fromBase64String(e.resumeToken))}function ta(e,t){var n,r=Ji(t.snapshotVersion),i=Ji(t.lastLimboFreeSnapshotVersion);n=Dn(t.target)?Vi(e.le,t.target):Li(e.le,t.target);var a=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:_n(t.target),readTime:r,resumeToken:a,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:n}}function na(e){var t=Pi({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?zn(t,t.limit,"L"):t}function ra(e,t){return new Hr(t.largestBatchId,Mi(e.le,t.overlayMutation))}function ia(e,t){var n=t.path.lastSegment();return[e,Me(t.path.popLast()),n]}function aa(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:Ji(r.readTime),documentKey:Me(r.documentKey.path),largestBatchId:r.largestBatchId}}var ua=function(){function e(){Object(h.a)(this,e)}return Object(d.a)(e,[{key:"getBundleMetadata",value:function(e,t){return oa(e).get(t).next((function(e){if(e)return{id:(t=e).bundleId,createTime:$i(t.createTime),version:t.version};var t}))}},{key:"saveBundleMetadata",value:function(e,t){return oa(e).put({bundleId:(n=t).id,createTime:Ji(Ii(n.createTime)),version:n.version});var n}},{key:"getNamedQuery",value:function(e,t){return sa(e).get(t).next((function(e){if(e)return{name:(t=e).name,query:na(t.bundledQuery),readTime:$i(t.readTime)};var t}))}},{key:"saveNamedQuery",value:function(e,t){return sa(e).put(function(e){return{name:e.name,readTime:Ji(Ii(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}]),e}();function oa(e){return lt(e,"bundles")}function sa(e){return lt(e,"namedQueries")}var ca=function(){function e(t,n){Object(h.a)(this,e),this.serializer=t,this.userId=n}return Object(d.a)(e,[{key:"getOverlay",value:function(e,t){var n=this;return la(e).get(ia(this.userId,t)).next((function(e){return e?ra(n.serializer,e):null}))}},{key:"getOverlays",value:function(e,t){var n=this,r=ir();return be.forEach(t,(function(t){return n.getOverlay(e,t).next((function(e){null!==e&&r.set(t,e)}))})).next((function(){return r}))}},{key:"saveOverlays",value:function(e,t,n){var r=this,i=[];return n.forEach((function(n,a){var u=new Hr(t,a);i.push(r.de(e,u))})),be.waitFor(i)}},{key:"removeOverlaysForBatchId",value:function(e,t,n){var r=this,i=new Set;t.forEach((function(e){return i.add(Me(e.getCollectionPath()))}));var a=[];return i.forEach((function(t){var i=IDBKeyRange.bound([r.userId,t,n],[r.userId,t,n+1],!1,!0);a.push(la(e).J("collectionPathOverlayIndex",i))})),be.waitFor(a)}},{key:"getOverlaysForCollection",value:function(e,t,n){var r=this,i=ir(),a=Me(t),u=IDBKeyRange.bound([this.userId,a,n],[this.userId,a,Number.POSITIVE_INFINITY],!0);return la(e).j("collectionPathOverlayIndex",u).next((function(e){var t,n=w(e);try{for(n.s();!(t=n.n()).done;){var a=t.value,u=ra(r.serializer,a);i.set(u.getKey(),u)}}catch(o){n.e(o)}finally{n.f()}return i}))}},{key:"getOverlaysForCollectionGroup",value:function(e,t,n,r){var i,a=this,u=ir(),o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return la(e).X({index:"collectionGroupOverlayIndex",range:o},(function(e,t,n){var o=ra(a.serializer,t);u.size()<r||o.largestBatchId===i?(u.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((function(){return u}))}},{key:"de",value:function(e,t){return la(e).put(function(e,t,n){var r=ia(t,n.mutation.key),i=Object(a.a)(r,3);i[0];return{userId:t,collectionPath:i[1],documentId:i[2],collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Fi(e.le,n.mutation)}}(this.serializer,this.userId,t))}}],[{key:"fe",value:function(t,n){return new e(t,n.uid||"")}}]),e}();function la(e){return lt(e,"documentOverlays")}var fa=function(){function e(){Object(h.a)(this,e)}return Object(d.a)(e,[{key:"_e",value:function(e,t){this.we(e,t),t.me()}},{key:"we",value:function(e,t){if("nullValue"in e)this.ge(t,5);else if("booleanValue"in e)this.ge(t,10),t.ye(e.booleanValue?1:0);else if("integerValue"in e)this.ge(t,15),t.ye(Tt(e.integerValue));else if("doubleValue"in e){var n=Tt(e.doubleValue);isNaN(n)?this.ge(t,13):(this.ge(t,15),Re(n)?t.ye(0):t.ye(n))}else if("timestampValue"in e){var r=e.timestampValue;this.ge(t,20),"string"==typeof r?t.pe(r):(t.pe("".concat(r.seconds||"")),t.ye(r.nanos||0))}else if("stringValue"in e)this.Ie(e.stringValue,t),this.Te(t);else if("bytesValue"in e)this.ge(t,30),t.Ee(St(e.bytesValue)),this.Te(t);else if("referenceValue"in e)this.Ae(e.referenceValue,t);else if("geoPointValue"in e){var i=e.geoPointValue;this.ge(t,45),t.ye(i.latitude||0),t.ye(i.longitude||0)}else"mapValue"in e?Ht(e)?this.ge(t,Number.MAX_SAFE_INTEGER):(this.Re(e.mapValue,t),this.Te(t)):"arrayValue"in e?(this.ve(e.arrayValue,t),this.Te(t)):R()}},{key:"Ie",value:function(e,t){this.ge(t,25),this.Pe(e,t)}},{key:"Pe",value:function(e,t){t.pe(e)}},{key:"Re",value:function(e,t){var n=e.fields||{};this.ge(t,55);for(var r=0,i=Object.keys(n);r<i.length;r++){var a=i[r];this.Ie(a,t),this.we(n[a],t)}}},{key:"ve",value:function(e,t){var n=e.values||[];this.ge(t,50);var r,i=w(n);try{for(i.s();!(r=i.n()).done;){var a=r.value;this.we(a,t)}}catch(u){i.e(u)}finally{i.f()}}},{key:"Ae",value:function(e,t){var n=this;this.ge(t,37),ue.fromName(e).path.forEach((function(e){n.ge(t,60),n.Pe(e,t)}))}},{key:"ge",value:function(e,t){e.ye(t)}},{key:"Te",value:function(e){e.ye(2)}}]),e}();function ha(e){if(0===e)return 8;var t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}function da(e){var t=64-function(e){for(var t=0,n=0;n<8;++n){var r=ha(255&e[n]);if(t+=r,8!==r)break}return t}(e);return Math.ceil(t/8)}fa.be=new fa;var va=function(){function e(){Object(h.a)(this,e),this.buffer=new Uint8Array(1024),this.position=0}return Object(d.a)(e,[{key:"Ve",value:function(e){for(var t=e[Symbol.iterator](),n=t.next();!n.done;)this.Se(n.value),n=t.next();this.De()}},{key:"Ce",value:function(e){for(var t=e[Symbol.iterator](),n=t.next();!n.done;)this.xe(n.value),n=t.next();this.Ne()}},{key:"ke",value:function(e){var t,n=w(e);try{for(n.s();!(t=n.n()).done;){var r=t.value,i=r.charCodeAt(0);if(i<128)this.Se(i);else if(i<2048)this.Se(960|i>>>6),this.Se(128|63&i);else if(r<"\ud800"||"\udbff"<r)this.Se(480|i>>>12),this.Se(128|63&i>>>6),this.Se(128|63&i);else{var a=r.codePointAt(0);this.Se(240|a>>>18),this.Se(128|63&a>>>12),this.Se(128|63&a>>>6),this.Se(128|63&a)}}}catch(u){n.e(u)}finally{n.f()}this.De()}},{key:"Me",value:function(e){var t,n=w(e);try{for(n.s();!(t=n.n()).done;){var r=t.value,i=r.charCodeAt(0);if(i<128)this.xe(i);else if(i<2048)this.xe(960|i>>>6),this.xe(128|63&i);else if(r<"\ud800"||"\udbff"<r)this.xe(480|i>>>12),this.xe(128|63&i>>>6),this.xe(128|63&i);else{var a=r.codePointAt(0);this.xe(240|a>>>18),this.xe(128|63&a>>>12),this.xe(128|63&a>>>6),this.xe(128|63&a)}}}catch(u){n.e(u)}finally{n.f()}this.Ne()}},{key:"Oe",value:function(e){var t=this.$e(e),n=da(t);this.Fe(1+n),this.buffer[this.position++]=255&n;for(var r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}},{key:"Be",value:function(e){var t=this.$e(e),n=da(t);this.Fe(1+n),this.buffer[this.position++]=~(255&n);for(var r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}},{key:"Le",value:function(){this.qe(255),this.qe(255)}},{key:"Ue",value:function(){this.Ke(255),this.Ke(255)}},{key:"reset",value:function(){this.position=0}},{key:"seed",value:function(e){this.Fe(e.length),this.buffer.set(e,this.position),this.position+=e.length}},{key:"Ge",value:function(){return this.buffer.slice(0,this.position)}},{key:"$e",value:function(e){var t=function(e){var t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(var r=1;r<t.length;++r)t[r]^=n?255:0;return t}},{key:"Se",value:function(e){var t=255&e;0===t?(this.qe(0),this.qe(255)):255===t?(this.qe(255),this.qe(0)):this.qe(t)}},{key:"xe",value:function(e){var t=255&e;0===t?(this.Ke(0),this.Ke(255)):255===t?(this.Ke(255),this.Ke(0)):this.Ke(e)}},{key:"De",value:function(){this.qe(0),this.qe(1)}},{key:"Ne",value:function(){this.Ke(0),this.Ke(1)}},{key:"qe",value:function(e){this.Fe(1),this.buffer[this.position++]=e}},{key:"Ke",value:function(e){this.Fe(1),this.buffer[this.position++]=~e}},{key:"Fe",value:function(e){var t=e+this.position;if(!(t<=this.buffer.length)){var n=2*this.buffer.length;n<t&&(n=t);var r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}}]),e}(),ya=function(){function e(t){Object(h.a)(this,e),this.Qe=t}return Object(d.a)(e,[{key:"Ee",value:function(e){this.Qe.Ve(e)}},{key:"pe",value:function(e){this.Qe.ke(e)}},{key:"ye",value:function(e){this.Qe.Oe(e)}},{key:"me",value:function(){this.Qe.Le()}}]),e}(),pa=function(){function e(t){Object(h.a)(this,e),this.Qe=t}return Object(d.a)(e,[{key:"Ee",value:function(e){this.Qe.Ce(e)}},{key:"pe",value:function(e){this.Qe.Me(e)}},{key:"ye",value:function(e){this.Qe.Be(e)}},{key:"me",value:function(){this.Qe.Ue()}}]),e}(),ma=function(){function e(){Object(h.a)(this,e),this.Qe=new va,this.je=new ya(this.Qe),this.ze=new pa(this.Qe)}return Object(d.a)(e,[{key:"seed",value:function(e){this.Qe.seed(e)}},{key:"We",value:function(e){return 0===e?this.je:this.ze}},{key:"Ge",value:function(){return this.Qe.Ge()}},{key:"reset",value:function(){this.Qe.reset()}}]),e}(),ga=function(){function e(t,n,r,i){Object(h.a)(this,e),this.indexId=t,this.documentKey=n,this.arrayValue=r,this.directionalValue=i}return Object(d.a)(e,[{key:"He",value:function(){var t=this.directionalValue.length,n=0===t||255===this.directionalValue[t-1]?t+1:t,r=new Uint8Array(n);return r.set(this.directionalValue,0),n!==t?r.set([0],this.directionalValue.length):++r[r.length-1],new e(this.indexId,this.documentKey,this.arrayValue,r)}}]),e}();function ka(e,t){var n=e.indexId-t.indexId;return 0!==n?n:0!==(n=ba(e.arrayValue,t.arrayValue))?n:0!==(n=ba(e.directionalValue,t.directionalValue))?n:ue.comparator(e.documentKey,t.documentKey)}function ba(e,t){for(var n=0;n<e.length&&n<t.length;++n){var r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}var wa=function(){function e(t){Object(h.a)(this,e),this.collectionId=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment(),this.Je=t.orderBy,this.Ye=[];var n,r=w(t.filters);try{for(r.s();!(n=r.n()).done;){var i=n.value;i.isInequality()?this.Xe=i:this.Ye.push(i)}}catch(a){r.e(a)}finally{r.f()}}return Object(d.a)(e,[{key:"Ze",value:function(e){F(e.collectionGroup===this.collectionId);var t=se(e);if(void 0!==t&&!this.tn(t))return!1;for(var n=ce(e),r=0,i=0;r<n.length&&this.tn(n[r]);++r);if(r===n.length)return!0;if(void 0!==this.Xe){var a=n[r];if(!this.en(this.Xe,a)||!this.nn(this.Je[i++],a))return!1;++r}for(;r<n.length;++r){var u=n[r];if(i>=this.Je.length||!this.nn(this.Je[i++],u))return!1}return!0}},{key:"tn",value:function(e){var t,n=w(this.Ye);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(this.en(r,e))return!0}}catch(i){n.e(i)}finally{n.f()}return!1}},{key:"en",value:function(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;var n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}},{key:"nn",value:function(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}]),e}();function xa(e){if(0===e.getFilters().length)return[];var t=function e(t){if(F(t instanceof cn||t instanceof ln),t instanceof cn)return t;if(1===t.filters.length)return e(t.filters[0]);var n=t.filters.map((function(t){return e(t)})),r=ln.create(n,t.op);return Ea(r=_a(r))?r:(F(r instanceof ln),F(fn(r)),F(r.filters.length>1),r.filters.reduce((function(e,t){return Ta(e,t)})))}(function e(t){var n,r;if(F(t instanceof cn||t instanceof ln),t instanceof cn){if(t instanceof In){var i=(null===(r=null===(n=t.value.arrayValue)||void 0===n?void 0:n.values)||void 0===r?void 0:r.map((function(e){return cn.create(t.field,"==",e)})))||[];return ln.create(i,"or")}return t}var a=t.filters.map((function(t){return e(t)}));return ln.create(a,t.op)}(e));return F(Ea(t)),Ia(t)||Oa(t)?[t]:t.getFilters()}function Ia(e){return e instanceof cn}function Oa(e){return e instanceof ln&&dn(e)}function Ea(e){return Ia(e)||Oa(e)||function(e){if(e instanceof ln&&hn(e)){var t,n=w(e.getFilters());try{for(n.s();!(t=n.n()).done;){var r=t.value;if(!Ia(r)&&!Oa(r))return!1}}catch(i){n.e(i)}finally{n.f()}return!0}return!1}(e)}function Ta(e,t){return F(e instanceof cn||e instanceof ln),F(t instanceof cn||t instanceof ln),_a(e instanceof cn?t instanceof cn?function(e,t){return ln.create([e,t],"and")}(e,t):Sa(e,t):t instanceof cn?Sa(t,e):function(e,t){if(F(e.filters.length>0&&t.filters.length>0),fn(e)&&fn(t))return pn(e,t.getFilters());var n=hn(e)?e:t,r=hn(e)?t:e,i=n.filters.map((function(e){return Ta(e,r)}));return ln.create(i,"or")}(e,t))}function Sa(e,t){if(fn(t))return pn(t,e.getFilters());var n=t.filters.map((function(t){return Ta(e,t)}));return ln.create(n,"or")}function _a(e){if(F(e instanceof cn||e instanceof ln),e instanceof cn)return e;var t=e.getFilters();if(1===t.length)return _a(t[0]);if(vn(e))return e;var n=t.map((function(e){return _a(e)})),r=[];return n.forEach((function(t){t instanceof cn?r.push(t):t instanceof ln&&(t.op===e.op?r.push.apply(r,Object(f.a)(t.filters)):r.push(t))})),1===r.length?r[0]:ln.create(r,e.op)}var ja=function(){function e(){Object(h.a)(this,e),this.sn=new Da}return Object(d.a)(e,[{key:"addToCollectionParentIndex",value:function(e,t){return this.sn.add(t),be.resolve()}},{key:"getCollectionParents",value:function(e,t){return be.resolve(this.sn.getEntries(t))}},{key:"addFieldIndex",value:function(e,t){return be.resolve()}},{key:"deleteFieldIndex",value:function(e,t){return be.resolve()}},{key:"getDocumentsMatchingTarget",value:function(e,t){return be.resolve(null)}},{key:"getIndexType",value:function(e,t){return be.resolve(0)}},{key:"getFieldIndexes",value:function(e,t){return be.resolve([])}},{key:"getNextCollectionGroupToUpdate",value:function(e){return be.resolve(null)}},{key:"getMinOffset",value:function(e,t){return be.resolve(ve.min())}},{key:"getMinOffsetFromCollectionGroup",value:function(e,t){return be.resolve(ve.min())}},{key:"updateCollectionGroup",value:function(e,t,n){return be.resolve()}},{key:"updateIndexEntries",value:function(e,t){return be.resolve()}}]),e}(),Da=function(){function e(){Object(h.a)(this,e),this.index={}}return Object(d.a)(e,[{key:"add",value:function(e){var t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new mt(re.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}},{key:"has",value:function(e){var t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}},{key:"getEntries",value:function(e){return(this.index[e]||new mt(re.comparator)).toArray()}}]),e}(),Aa=new Uint8Array(0),Ca=function(){function e(t,n){Object(h.a)(this,e),this.user=t,this.databaseId=n,this.rn=new Da,this.on=new $n((function(e){return _n(e)}),(function(e,t){return jn(e,t)})),this.uid=t.uid||""}return Object(d.a)(e,[{key:"addToCollectionParentIndex",value:function(e,t){var n=this;if(!this.rn.has(t)){var r=t.lastSegment(),i=t.popLast();e.addOnCommittedListener((function(){n.rn.add(t)}));var a={collectionId:r,parent:Me(i)};return Na(e).put(a)}return be.resolve()}},{key:"getCollectionParents",value:function(e,t){var n=[],r=IDBKeyRange.bound([t,""],[Z(t),""],!1,!0);return Na(e).j(r).next((function(e){var r,i=w(e);try{for(i.s();!(r=i.n()).done;){var a=r.value;if(a.collectionId!==t)break;n.push(Pe(a.parent))}}catch(u){i.e(u)}finally{i.f()}return n}))}},{key:"addFieldIndex",value:function(e,t){var n=this,r=Fa(e),i=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map((function(e){return[e.fieldPath.canonicalString(),e.kind]}))}}(t);delete i.indexId;var a=r.add(i);if(t.indexState){var u=Ma(e);return a.next((function(e){u.put(aa(e,n.user,t.indexState.sequenceNumber,t.indexState.offset))}))}return a.next()}},{key:"deleteFieldIndex",value:function(e,t){var n=Fa(e),r=Ma(e),i=Ra(e);return n.delete(t.indexId).next((function(){return r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))})).next((function(){return i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))}))}},{key:"getDocumentsMatchingTarget",value:function(e,t){var n=this,r=Ra(e),i=!0,a=new Map;return be.forEach(this.un(t),(function(t){return n.cn(e,t).next((function(e){i&&(i=!!e),a.set(t,e)}))})).next((function(){if(i){var e=cr(),u=[];return be.forEach(a,(function(i,a){var o;D("IndexedDbIndexManager","Using index ".concat((o=i,"id=".concat(o.indexId,"|cg=").concat(o.collectionGroup,"|f=").concat(o.fields.map((function(e){return"".concat(e.fieldPath,":").concat(e.kind)})).join(",")))," to execute ").concat(_n(t)));var s=function(e,t){var n=se(t);if(void 0===n)return null;var r,i=w(An(e,n.fieldPath));try{for(i.s();!(r=i.n()).done;){var a=r.value;switch(a.op){case"array-contains-any":return a.value.arrayValue.values||[];case"array-contains":return[a.value]}}}catch(u){i.e(u)}finally{i.f()}return null}(a,i),c=function(e,t){var n,r=new Map,i=w(ce(t));try{for(i.s();!(n=i.n()).done;){var a,u=n.value,o=w(An(e,u.fieldPath));try{for(o.s();!(a=o.n()).done;){var s=a.value;switch(s.op){case"==":case"in":r.set(u.fieldPath.canonicalString(),s.value);break;case"not-in":case"!=":return r.set(u.fieldPath.canonicalString(),s.value),Array.from(r.values())}}}catch(c){o.e(c)}finally{o.f()}}}catch(c){i.e(c)}finally{i.f()}return null}(a,i),l=function(e,t){var n,r=[],i=!0,a=w(ce(t));try{for(a.s();!(n=a.n()).done;){var u=n.value,o=0===u.kind?Cn(e,u.fieldPath,e.startAt):Nn(e,u.fieldPath,e.startAt);r.push(o.value),i&&(i=o.inclusive)}}catch(s){a.e(s)}finally{a.f()}return new nn(r,i)}(a,i),f=function(e,t){var n,r=[],i=!0,a=w(ce(t));try{for(a.s();!(n=a.n()).done;){var u=n.value,o=0===u.kind?Nn(e,u.fieldPath,e.endAt):Cn(e,u.fieldPath,e.endAt);r.push(o.value),i&&(i=o.inclusive)}}catch(s){a.e(s)}finally{a.f()}return new nn(r,i)}(a,i),h=n.an(i,a,l),d=n.an(i,a,f),v=n.hn(i,a,c),y=n.ln(i.indexId,s,h,l.inclusive,d,f.inclusive,v);return be.forEach(y,(function(n){return r.H(n,t.limit).next((function(t){t.forEach((function(t){var n=ue.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),u.push(n))}))}))}))})).next((function(){return u}))}return be.resolve(null)}))}},{key:"un",value:function(e){var t=this.on.get(e);return t||(t=0===e.filters.length?[e]:xa(ln.create(e.filters,"and")).map((function(t){return Sn(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)})),this.on.set(e,t),t)}},{key:"ln",value:function(e,t,n,r,i,a,u){for(var o=this,s=(null!=t?t.length:1)*Math.max(n.length,i.length),c=s/(null!=t?t.length:1),l=[],h=function(s){var h=t?o.fn(t[s/c]):Aa,d=o.dn(e,h,n[s%c],r),v=o._n(e,h,i[s%c],a),y=u.map((function(t){return o.dn(e,h,t,!0)}));l.push.apply(l,Object(f.a)(o.createRange(d,v,y)))},d=0;d<s;++d)h(d);return l}},{key:"dn",value:function(e,t,n,r){var i=new ga(e,ue.empty(),t,n);return r?i:i.He()}},{key:"_n",value:function(e,t,n,r){var i=new ga(e,ue.empty(),t,n);return r?i.He():i}},{key:"cn",value:function(e,t){var n=new wa(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next((function(e){var t,r=null,i=w(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;n.Ze(a)&&(!r||a.fields.length>r.fields.length)&&(r=a)}}catch(u){i.e(u)}finally{i.f()}return r}))}},{key:"getIndexType",value:function(e,t){var n=this,r=2,i=this.un(t);return be.forEach(i,(function(t){return n.cn(e,t).next((function(e){e?0!==r&&e.fields.length<function(e){var t,n=new mt(ae.comparator),r=!1,i=w(e.filters);try{for(i.s();!(t=i.n()).done;){var a,u=w(t.value.getFlattenedFilters());try{for(u.s();!(a=u.n()).done;){var o=a.value;o.field.isKeyField()||("array-contains"===o.op||"array-contains-any"===o.op?r=!0:n=n.add(o.field))}}catch(f){u.e(f)}finally{u.f()}}}catch(f){i.e(f)}finally{i.f()}var s,c=w(e.orderBy);try{for(c.s();!(s=c.n()).done;){var l=s.value;l.field.isKeyField()||(n=n.add(l.field))}}catch(f){c.e(f)}finally{c.f()}return n.size+(r?1:0)}(t)&&(r=1):r=0}))})).next((function(){return function(e){return null!==e.limit}(t)&&i.length>1&&2===r?1:r}))}},{key:"wn",value:function(e,t){var n,r=new ma,i=w(ce(e));try{for(i.s();!(n=i.n()).done;){var a=n.value,u=t.data.field(a.fieldPath);if(null==u)return null;var o=r.We(a.kind);fa.be._e(u,o)}}catch(s){i.e(s)}finally{i.f()}return r.Ge()}},{key:"fn",value:function(e){var t=new ma;return fa.be._e(e,t.We(0)),t.Ge()}},{key:"mn",value:function(e,t){var n=new ma;return fa.be._e(Ut(this.databaseId,t),n.We(function(e){var t=ce(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Ge()}},{key:"hn",value:function(e,t,n){if(null===n)return[];var r=[];r.push(new ma);var i,a=0,u=w(ce(e));try{for(u.s();!(i=u.n()).done;){var o,s=i.value,c=n[a++],l=w(r);try{for(l.s();!(o=l.n()).done;){var f=o.value;if(this.gn(t,s.fieldPath)&&Kt(c))r=this.yn(r,s,c);else{var h=f.We(s.kind);fa.be._e(c,h)}}}catch(d){l.e(d)}finally{l.f()}}}catch(d){u.e(d)}finally{u.f()}return this.pn(r)}},{key:"an",value:function(e,t,n){return this.hn(e,t,n.position)}},{key:"pn",value:function(e){for(var t=[],n=0;n<e.length;++n)t[n]=e[n].Ge();return t}},{key:"yn",value:function(e,t,n){var r,i=Object(f.a)(e),a=[],u=w(n.arrayValue.values||[]);try{for(u.s();!(r=u.n()).done;){var o,s=r.value,c=w(i);try{for(c.s();!(o=c.n()).done;){var l=o.value,h=new ma;h.seed(l.Ge()),fa.be._e(s,h.We(t.kind)),a.push(h)}}catch(d){c.e(d)}finally{c.f()}}}catch(d){u.e(d)}finally{u.f()}return a}},{key:"gn",value:function(e,t){return!!e.filters.find((function(e){return e instanceof cn&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)}))}},{key:"getFieldIndexes",value:function(e,t){var n=this,r=Fa(e),i=Ma(e);return(t?r.j("collectionGroupIndex",IDBKeyRange.bound(t,t)):r.j()).next((function(e){var t=[];return be.forEach(e,(function(e){return i.get([e.indexId,n.uid]).next((function(n){t.push(function(e,t){var n=t?new fe(t.sequenceNumber,new ve($i(t.readTime),new ue(Pe(t.documentKey)),t.largestBatchId)):fe.empty(),r=e.fields.map((function(e){var t=Object(a.a)(e,2),n=t[0],r=t[1];return new le(ae.fromServerFormat(n),r)}));return new oe(e.indexId,e.collectionGroup,r,n)}(e,n))}))})).next((function(){return t}))}))}},{key:"getNextCollectionGroupToUpdate",value:function(e){return this.getFieldIndexes(e).next((function(e){return 0===e.length?null:(e.sort((function(e,t){var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:J(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)}))}},{key:"updateCollectionGroup",value:function(e,t,n){var r=this,i=Fa(e),a=Ma(e);return this.In(e).next((function(e){return i.j("collectionGroupIndex",IDBKeyRange.bound(t,t)).next((function(t){return be.forEach(t,(function(t){return a.put(aa(t.indexId,r.user,e,n))}))}))}))}},{key:"updateIndexEntries",value:function(e,t){var n=this,r=new Map;return be.forEach(t,(function(t,i){var a=r.get(t.collectionGroup);return(a?be.resolve(a):n.getFieldIndexes(e,t.collectionGroup)).next((function(a){return r.set(t.collectionGroup,a),be.forEach(a,(function(r){return n.Tn(e,t,r).next((function(t){var a=n.En(i,r);return t.isEqual(a)?be.resolve():n.An(e,i,r,t,a)}))}))}))}))}},{key:"Rn",value:function(e,t,n,r){return Ra(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.mn(n,t.key),documentKey:t.key.path.toArray()})}},{key:"vn",value:function(e,t,n,r){return Ra(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.mn(n,t.key),t.key.path.toArray()])}},{key:"Tn",value:function(e,t,n){var r=Ra(e),i=new mt(ka);return r.X({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.mn(n,t)])},(function(e,r){i=i.add(new ga(n.indexId,t,r.arrayValue,r.directionalValue))})).next((function(){return i}))}},{key:"En",value:function(e,t){var n=new mt(ka),r=this.wn(t,e);if(null==r)return n;var i=se(t);if(null!=i){var a=e.data.field(i.fieldPath);if(Kt(a)){var u,o=w(a.arrayValue.values||[]);try{for(o.s();!(u=o.n()).done;){var s=u.value;n=n.add(new ga(t.indexId,e.key,this.fn(s),r))}}catch(c){o.e(c)}finally{o.f()}}}else n=n.add(new ga(t.indexId,e.key,Aa,r));return n}},{key:"An",value:function(e,t,n,r,i){var a=this;D("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);var u=[];return function(e,t,n,r,i){for(var a=e.getIterator(),u=t.getIterator(),o=kt(a),s=kt(u);o||s;){var c=!1,l=!1;if(o&&s){var f=n(o,s);f<0?l=!0:f>0&&(c=!0)}else null!=o?l=!0:c=!0;c?(r(s),s=kt(u)):l?(i(o),o=kt(a)):(o=kt(a),s=kt(u))}}(r,i,ka,(function(r){u.push(a.Rn(e,t,n,r))}),(function(r){u.push(a.vn(e,t,n,r))})),be.waitFor(u)}},{key:"In",value:function(e){var t=1;return Ma(e).X({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(function(e,n,r){r.done(),t=n.sequenceNumber+1})).next((function(){return t}))}},{key:"createRange",value:function(e,t,n){n=n.sort((function(e,t){return ka(e,t)})).filter((function(e,t,n){return!t||0!==ka(e,n[t-1])}));var r=[];r.push(e);var i,a=w(n);try{for(a.s();!(i=a.n()).done;){var u=i.value,o=ka(u,e),s=ka(u,t);if(0===o)r[0]=e.He();else if(o>0&&s<0)r.push(u),r.push(u.He());else if(s>0)break}}catch(d){a.e(d)}finally{a.f()}r.push(t);for(var c=[],l=0;l<r.length;l+=2){if(this.Pn(r[l],r[l+1]))return[];var f=[r[l].indexId,this.uid,r[l].arrayValue,r[l].directionalValue,Aa,[]],h=[r[l+1].indexId,this.uid,r[l+1].arrayValue,r[l+1].directionalValue,Aa,[]];c.push(IDBKeyRange.bound(f,h))}return c}},{key:"Pn",value:function(e,t){return ka(e,t)>0}},{key:"getMinOffsetFromCollectionGroup",value:function(e,t){return this.getFieldIndexes(e,t).next(Va)}},{key:"getMinOffset",value:function(e,t){var n=this;return be.mapArray(this.un(t),(function(t){return n.cn(e,t).next((function(e){return e||R()}))})).next(Va)}}]),e}();function Na(e){return lt(e,"collectionParents")}function Ra(e){return lt(e,"indexEntries")}function Fa(e){return lt(e,"indexConfiguration")}function Ma(e){return lt(e,"indexState")}function Va(e){F(0!==e.length);for(var t=e[0].indexState.offset,n=t.largestBatchId,r=1;r<e.length;r++){var i=e[r].indexState.offset;ye(i,t)<0&&(t=i),n<i.largestBatchId&&(n=i.largestBatchId)}return new ve(t.readTime,t.documentKey,n)}var La={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},Pa=function(){function e(t,n,r){Object(h.a)(this,e),this.cacheSizeCollectionThreshold=t,this.percentileToCollect=n,this.maximumSequenceNumbersToCollect=r}return Object(d.a)(e,null,[{key:"withCacheSize",value:function(t){return new e(t,e.DEFAULT_COLLECTION_PERCENTILE,e.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}]),e}();function qa(e,t,n){var r=e.store("mutations"),i=e.store("documentMutations"),a=[],u=IDBKeyRange.only(n.batchId),o=0,s=r.X({range:u},(function(e,t,n){return o++,n.delete()}));a.push(s.next((function(){F(1===o)})));var c,l=[],f=w(n.mutations);try{for(f.s();!(c=f.n()).done;){var h=c.value,d=Be(t,h.key.path,n.batchId);a.push(i.delete(d)),l.push(h.key)}}catch(v){f.e(v)}finally{f.f()}return be.waitFor(a).next((function(){return l}))}function Ua(e){if(!e)return 0;var t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw R();t=e.noDocument}return JSON.stringify(t).length}Pa.DEFAULT_COLLECTION_PERCENTILE=10,Pa.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Pa.DEFAULT=new Pa(41943040,Pa.DEFAULT_COLLECTION_PERCENTILE,Pa.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Pa.DISABLED=new Pa(-1,0,0);var Ba=function(){function e(t,n,r,i){Object(h.a)(this,e),this.userId=t,this.serializer=n,this.indexManager=r,this.referenceDelegate=i,this.bn={}}return Object(d.a)(e,[{key:"checkEmpty",value:function(e){var t=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return za(e).X({index:"userMutationsIndex",range:n},(function(e,n,r){t=!1,r.done()})).next((function(){return t}))}},{key:"addMutationBatch",value:function(e,t,n,r){var i=this,a=Ga(e),u=za(e);return u.add({}).next((function(o){F("number"==typeof o);var s,c=new Qr(o,t,n,r),l=function(e,t,n){var r=n.baseMutations.map((function(t){return Fi(e.le,t)})),i=n.mutations.map((function(t){return Fi(e.le,t)}));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:i}}(i.serializer,i.userId,c),f=[],h=new mt((function(e,t){return J(e.canonicalString(),t.canonicalString())})),d=w(r);try{for(d.s();!(s=d.n()).done;){var v=s.value,y=Be(i.userId,v.key.path,o);h=h.add(v.key.path.popLast()),f.push(u.put(l)),f.push(a.put(y,Ke))}}catch(p){d.e(p)}finally{d.f()}return h.forEach((function(t){f.push(i.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((function(){i.bn[o]=c.keys()})),be.waitFor(f).next((function(){return c}))}))}},{key:"lookupMutationBatch",value:function(e,t){var n=this;return za(e).get(t).next((function(e){return e?(F(e.userId===n.userId),Zi(n.serializer,e)):null}))}},{key:"Vn",value:function(e,t){var n=this;return this.bn[t]?be.resolve(this.bn[t]):this.lookupMutationBatch(e,t).next((function(e){if(e){var r=e.keys();return n.bn[t]=r,r}return null}))}},{key:"getNextMutationBatchAfterBatchId",value:function(e,t){var n=this,r=t+1,i=IDBKeyRange.lowerBound([this.userId,r]),a=null;return za(e).X({index:"userMutationsIndex",range:i},(function(e,t,i){t.userId===n.userId&&(F(t.batchId>=r),a=Zi(n.serializer,t)),i.done()})).next((function(){return a}))}},{key:"getHighestUnacknowledgedBatchId",value:function(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return za(e).X({index:"userMutationsIndex",range:t,reverse:!0},(function(e,t,r){n=t.batchId,r.done()})).next((function(){return n}))}},{key:"getAllMutationBatches",value:function(e){var t=this,n=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return za(e).j("userMutationsIndex",n).next((function(e){return e.map((function(e){return Zi(t.serializer,e)}))}))}},{key:"getAllMutationBatchesAffectingDocumentKey",value:function(e,t){var n=this,r=Ue(this.userId,t.path),i=IDBKeyRange.lowerBound(r),u=[];return Ga(e).X({range:i},(function(r,i,o){var s=Object(a.a)(r,3),c=s[0],l=s[1],f=s[2],h=Pe(l);if(c===n.userId&&t.path.isEqual(h))return za(e).get(f).next((function(e){if(!e)throw R();F(e.userId===n.userId),u.push(Zi(n.serializer,e))}));o.done()})).next((function(){return u}))}},{key:"getAllMutationBatchesAffectingDocumentKeys",value:function(e,t){var n=this,r=new mt(J),i=[];return t.forEach((function(t){var u=Ue(n.userId,t.path),o=IDBKeyRange.lowerBound(u),s=Ga(e).X({range:o},(function(e,i,u){var o=Object(a.a)(e,3),s=o[0],c=o[1],l=o[2],f=Pe(c);s===n.userId&&t.path.isEqual(f)?r=r.add(l):u.done()}));i.push(s)})),be.waitFor(i).next((function(){return n.Sn(e,r)}))}},{key:"getAllMutationBatchesAffectingQuery",value:function(e,t){var n=this,r=t.path,i=r.length+1,u=Ue(this.userId,r),o=IDBKeyRange.lowerBound(u),s=new mt(J);return Ga(e).X({range:o},(function(e,t,u){var o=Object(a.a)(e,3),c=o[0],l=o[1],f=o[2],h=Pe(l);c===n.userId&&r.isPrefixOf(h)?h.length===i&&(s=s.add(f)):u.done()})).next((function(){return n.Sn(e,s)}))}},{key:"Sn",value:function(e,t){var n=this,r=[],i=[];return t.forEach((function(t){i.push(za(e).get(t).next((function(e){if(null===e)throw R();F(e.userId===n.userId),r.push(Zi(n.serializer,e))})))})),be.waitFor(i).next((function(){return r}))}},{key:"removeMutationBatch",value:function(e,t){var n=this;return qa(e.at,this.userId,t).next((function(r){return e.addOnCommittedListener((function(){n.Dn(t.batchId)})),be.forEach(r,(function(t){return n.referenceDelegate.markPotentiallyOrphaned(e,t)}))}))}},{key:"Dn",value:function(e){delete this.bn[e]}},{key:"performConsistencyCheck",value:function(e){var t=this;return this.checkEmpty(e).next((function(n){if(!n)return be.resolve();var r=IDBKeyRange.lowerBound([t.userId]),i=[];return Ga(e).X({range:r},(function(e,n,r){if(e[0]===t.userId){var a=Pe(e[1]);i.push(a)}else r.done()})).next((function(){F(0===i.length)}))}))}},{key:"containsKey",value:function(e,t){return Ka(e,this.userId,t)}},{key:"Cn",value:function(e){var t=this;return Qa(e).get(this.userId).next((function(e){return e||{userId:t.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}}))}}],[{key:"fe",value:function(t,n,r,i){return F(""!==t.uid),new e(t.isAuthenticated()?t.uid:"",n,r,i)}}]),e}();function Ka(e,t,n){var r=Ue(t,n.path),i=r[1],u=IDBKeyRange.lowerBound(r),o=!1;return Ga(e).X({range:u,Y:!0},(function(e,n,r){var u=Object(a.a)(e,3),s=u[0],c=u[1];u[2];s===t&&c===i&&(o=!0),r.done()})).next((function(){return o}))}function za(e){return lt(e,"mutations")}function Ga(e){return lt(e,"documentMutations")}function Qa(e){return lt(e,"mutationQueues")}var Wa=function(){function e(t){Object(h.a)(this,e),this.xn=t}return Object(d.a)(e,[{key:"next",value:function(){return this.xn+=2,this.xn}}],[{key:"Nn",value:function(){return new e(0)}},{key:"kn",value:function(){return new e(-1)}}]),e}(),Ha=function(){function e(t,n){Object(h.a)(this,e),this.referenceDelegate=t,this.serializer=n}return Object(d.a)(e,[{key:"allocateTargetId",value:function(e){var t=this;return this.Mn(e).next((function(n){var r=new Wa(n.highestTargetId);return n.highestTargetId=r.next(),t.On(e,n).next((function(){return n.highestTargetId}))}))}},{key:"getLastRemoteSnapshotVersion",value:function(e){return this.Mn(e).next((function(e){return te.fromTimestamp(new ee(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))}))}},{key:"getHighestSequenceNumber",value:function(e){return this.Mn(e).next((function(e){return e.highestListenSequenceNumber}))}},{key:"setTargetsMetadata",value:function(e,t,n){var r=this;return this.Mn(e).next((function(i){return i.highestListenSequenceNumber=t,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),t>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=t),r.On(e,i)}))}},{key:"addTargetData",value:function(e,t){var n=this;return this.$n(e,t).next((function(){return n.Mn(e).next((function(r){return r.targetCount+=1,n.Fn(t,r),n.On(e,r)}))}))}},{key:"updateTargetData",value:function(e,t){return this.$n(e,t)}},{key:"removeTargetData",value:function(e,t){var n=this;return this.removeMatchingKeysForTargetId(e,t.targetId).next((function(){return Xa(e).delete(t.targetId)})).next((function(){return n.Mn(e)})).next((function(t){return F(t.targetCount>0),t.targetCount-=1,n.On(e,t)}))}},{key:"removeTargets",value:function(e,t,n){var r=this,i=0,a=[];return Xa(e).X((function(u,o){var s=ea(o);s.sequenceNumber<=t&&null===n.get(s.targetId)&&(i++,a.push(r.removeTargetData(e,s)))})).next((function(){return be.waitFor(a)})).next((function(){return i}))}},{key:"forEachTarget",value:function(e,t){return Xa(e).X((function(e,n){var r=ea(n);t(r)}))}},{key:"Mn",value:function(e){return Ya(e).get("targetGlobalKey").next((function(e){return F(null!==e),e}))}},{key:"On",value:function(e,t){return Ya(e).put("targetGlobalKey",t)}},{key:"$n",value:function(e,t){return Xa(e).put(ta(this.serializer,t))}},{key:"Fn",value:function(e,t){var n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}},{key:"getTargetCount",value:function(e){return this.Mn(e).next((function(e){return e.targetCount}))}},{key:"getTargetData",value:function(e,t){var n=_n(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]),i=null;return Xa(e).X({range:r,index:"queryTargetsIndex"},(function(e,n,r){var a=ea(n);jn(t,a.target)&&(i=a,r.done())})).next((function(){return i}))}},{key:"addMatchingKeys",value:function(e,t,n){var r=this,i=[],a=Ja(e);return t.forEach((function(t){var u=Me(t.path);i.push(a.put({targetId:n,path:u})),i.push(r.referenceDelegate.addReference(e,n,t))})),be.waitFor(i)}},{key:"removeMatchingKeys",value:function(e,t,n){var r=this,i=Ja(e);return be.forEach(t,(function(t){var a=Me(t.path);return be.waitFor([i.delete([n,a]),r.referenceDelegate.removeReference(e,n,t)])}))}},{key:"removeMatchingKeysForTargetId",value:function(e,t){var n=Ja(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}},{key:"getMatchingKeysForTargetId",value:function(e,t){var n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Ja(e),i=cr();return r.X({range:n,Y:!0},(function(e,t,n){var r=Pe(e[1]),a=new ue(r);i=i.add(a)})).next((function(){return i}))}},{key:"containsKey",value:function(e,t){var n=Me(t.path),r=IDBKeyRange.bound([n],[Z(n)],!1,!0),i=0;return Ja(e).X({index:"documentTargetsIndex",Y:!0,range:r},(function(e,t,n){var r=Object(a.a)(e,2),u=r[0];r[1];0!==u&&(i++,n.done())})).next((function(){return i>0}))}},{key:"he",value:function(e,t){return Xa(e).get(t).next((function(e){return e?ea(e):null}))}}]),e}();function Xa(e){return lt(e,"targets")}function Ya(e){return lt(e,"targetGlobal")}function Ja(e){return lt(e,"targetDocuments")}function $a(e,t){var n=Object(a.a)(e,2),r=n[0],i=n[1],u=Object(a.a)(t,2),o=u[0],s=u[1],c=J(r,o);return 0===c?J(i,s):c}var Za=function(){function e(t){Object(h.a)(this,e),this.Bn=t,this.buffer=new mt($a),this.Ln=0}return Object(d.a)(e,[{key:"qn",value:function(){return++this.Ln}},{key:"Un",value:function(e){var t=[e,this.qn()];if(this.buffer.size<this.Bn)this.buffer=this.buffer.add(t);else{var n=this.buffer.last();$a(t,n)<0&&(this.buffer=this.buffer.delete(n).add(t))}}},{key:"maxValue",get:function(){return this.buffer.last()[0]}}]),e}(),eu=function(){function e(t,n,r){Object(h.a)(this,e),this.garbageCollector=t,this.asyncQueue=n,this.localStore=r,this.Kn=null}return Object(d.a)(e,[{key:"start",value:function(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Gn(6e4)}},{key:"stop",value:function(){this.Kn&&(this.Kn.cancel(),this.Kn=null)}},{key:"started",get:function(){return null!==this.Kn}},{key:"Gn",value:function(e){var t=this;D("LruGarbageCollector","Garbage collection scheduled in ".concat(e,"ms")),this.Kn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,Object(o.a)(y.a.mark((function e(){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.Kn=null,e.prev=1,e.next=4,t.localStore.collectGarbage(t.garbageCollector);case 4:e.next=14;break;case 6:if(e.prev=6,e.t0=e.catch(1),!Ee(e.t0)){e.next=12;break}D("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e.t0),e.next=14;break;case 12:return e.next=14,ge(e.t0);case 14:return e.next=16,t.Gn(3e5);case 16:case"end":return e.stop()}}),e,null,[[1,6]])}))))}}]),e}(),tu=function(){function e(t,n){Object(h.a)(this,e),this.Qn=t,this.params=n}return Object(d.a)(e,[{key:"calculateTargetCount",value:function(e,t){return this.Qn.jn(e).next((function(e){return Math.floor(t/100*e)}))}},{key:"nthSequenceNumber",value:function(e,t){var n=this;if(0===t)return be.resolve(Ce.ct);var r=new Za(t);return this.Qn.forEachTarget(e,(function(e){return r.Un(e.sequenceNumber)})).next((function(){return n.Qn.zn(e,(function(e){return r.Un(e)}))})).next((function(){return r.maxValue}))}},{key:"removeTargets",value:function(e,t,n){return this.Qn.removeTargets(e,t,n)}},{key:"removeOrphanedDocuments",value:function(e,t){return this.Qn.removeOrphanedDocuments(e,t)}},{key:"collect",value:function(e,t){var n=this;return-1===this.params.cacheSizeCollectionThreshold?(D("LruGarbageCollector","Garbage collection skipped; disabled"),be.resolve(La)):this.getCacheSize(e).next((function(r){return r<n.params.cacheSizeCollectionThreshold?(D("LruGarbageCollector","Garbage collection skipped; Cache size ".concat(r," is lower than threshold ").concat(n.params.cacheSizeCollectionThreshold)),La):n.Wn(e,t)}))}},{key:"getCacheSize",value:function(e){return this.Qn.getCacheSize(e)}},{key:"Wn",value:function(e,t){var n,r,i,a,u,o,s,c=this,l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((function(t){return t>c.params.maximumSequenceNumbersToCollect?(D("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of ".concat(c.params.maximumSequenceNumbersToCollect," from ").concat(t)),r=c.params.maximumSequenceNumbersToCollect):r=t,a=Date.now(),c.nthSequenceNumber(e,r)})).next((function(r){return n=r,u=Date.now(),c.removeTargets(e,n,t)})).next((function(t){return i=t,o=Date.now(),c.removeOrphanedDocuments(e,n)})).next((function(e){return s=Date.now(),_()<=g.a.DEBUG&&D("LruGarbageCollector","LRU Garbage Collection\n\tCounted targets in ".concat(a-l,"ms\n\tDetermined least recently used ").concat(r," in ")+(u-a)+"ms\n"+"\tRemoved ".concat(i," targets in ")+(o-u)+"ms\n"+"\tRemoved ".concat(e," documents in ")+(s-o)+"ms\n"+"Total Duration: ".concat(s-l,"ms")),be.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:e})}))}}]),e}();function nu(e,t){return new tu(e,t)}var ru=function(){function e(t,n){Object(h.a)(this,e),this.db=t,this.garbageCollector=nu(this,n)}return Object(d.a)(e,[{key:"jn",value:function(e){var t=this.Hn(e);return this.db.getTargetCache().getTargetCount(e).next((function(e){return t.next((function(t){return e+t}))}))}},{key:"Hn",value:function(e){var t=0;return this.zn(e,(function(e){t++})).next((function(){return t}))}},{key:"forEachTarget",value:function(e,t){return this.db.getTargetCache().forEachTarget(e,t)}},{key:"zn",value:function(e,t){return this.Jn(e,(function(e,n){return t(n)}))}},{key:"addReference",value:function(e,t,n){return iu(e,n)}},{key:"removeReference",value:function(e,t,n){return iu(e,n)}},{key:"removeTargets",value:function(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}},{key:"markPotentiallyOrphaned",value:function(e,t){return iu(e,t)}},{key:"Yn",value:function(e,t){return function(e,t){var n=!1;return Qa(e).Z((function(r){return Ka(e,r,t).next((function(e){return e&&(n=!0),be.resolve(!e)}))})).next((function(){return n}))}(e,t)}},{key:"removeOrphanedDocuments",value:function(e,t){var n=this,r=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],a=0;return this.Jn(e,(function(u,o){if(o<=t){var s=n.Yn(e,u).next((function(t){if(!t)return a++,r.getEntry(e,u).next((function(){return r.removeEntry(u,te.min()),Ja(e).delete([0,Me(u.path)])}))}));i.push(s)}})).next((function(){return be.waitFor(i)})).next((function(){return r.apply(e)})).next((function(){return a}))}},{key:"removeTarget",value:function(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}},{key:"updateLimboDocument",value:function(e,t){return iu(e,t)}},{key:"Jn",value:function(e,t){var n,r=Ja(e),i=Ce.ct;return r.X({index:"documentTargetsIndex"},(function(e,r){var u=Object(a.a)(e,2),o=u[0],s=(u[1],r.path),c=r.sequenceNumber;0===o?(i!==Ce.ct&&t(new ue(Pe(n)),i),i=c,n=s):i=Ce.ct})).next((function(){i!==Ce.ct&&t(new ue(Pe(n)),i)}))}},{key:"getCacheSize",value:function(e){return this.db.getRemoteDocumentCache().getSize(e)}}]),e}();function iu(e,t){return Ja(e).put(function(e,t){return{targetId:0,path:Me(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}var au=function(){function e(){Object(h.a)(this,e),this.changes=new $n((function(e){return e.toString()}),(function(e,t){return e.isEqual(t)})),this.changesApplied=!1}return Object(d.a)(e,[{key:"addEntry",value:function(e){this.assertNotApplied(),this.changes.set(e.key,e)}},{key:"removeEntry",value:function(e,t){this.assertNotApplied(),this.changes.set(e,tn.newInvalidDocument(e).setReadTime(t))}},{key:"getEntry",value:function(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?be.resolve(n):this.getFromCache(e,t)}},{key:"getEntries",value:function(e,t){return this.getAllFromCache(e,t)}},{key:"apply",value:function(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}},{key:"assertNotApplied",value:function(){}}]),e}(),uu=function(){function e(t){Object(h.a)(this,e),this.serializer=t}return Object(d.a)(e,[{key:"setIndexManager",value:function(e){this.indexManager=e}},{key:"addEntry",value:function(e,t,n){return lu(e).put(n)}},{key:"removeEntry",value:function(e,t,n){return lu(e).delete(function(e,t){var n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Yi(t),n[n.length-1]]}(t,n))}},{key:"updateMetadata",value:function(e,t){var n=this;return this.getMetadata(e).next((function(r){return r.byteSize+=t,n.Xn(e,r)}))}},{key:"getEntry",value:function(e,t){var n=this,r=tn.newInvalidDocument(t);return lu(e).X({index:"documentKeyIndex",range:IDBKeyRange.only(fu(t))},(function(e,i){r=n.Zn(t,i)})).next((function(){return r}))}},{key:"ts",value:function(e,t){var n=this,r={size:0,document:tn.newInvalidDocument(t)};return lu(e).X({index:"documentKeyIndex",range:IDBKeyRange.only(fu(t))},(function(e,i){r={document:n.Zn(t,i),size:Ua(i)}})).next((function(){return r}))}},{key:"getEntries",value:function(e,t){var n=this,r=er();return this.es(e,t,(function(e,t){var i=n.Zn(e,t);r=r.insert(e,i)})).next((function(){return r}))}},{key:"ns",value:function(e,t){var n=this,r=er(),i=new vt(ue.comparator);return this.es(e,t,(function(e,t){var a=n.Zn(e,t);r=r.insert(e,a),i=i.insert(e,Ua(t))})).next((function(){return{documents:r,ss:i}}))}},{key:"es",value:function(e,t,n){if(t.isEmpty())return be.resolve();var r=new mt(du);t.forEach((function(e){return r=r.add(e)}));var i=IDBKeyRange.bound(fu(r.first()),fu(r.last())),a=r.getIterator(),u=a.getNext();return lu(e).X({index:"documentKeyIndex",range:i},(function(e,t,r){for(var i=ue.fromSegments([].concat(Object(f.a)(t.prefixPath),[t.collectionGroup,t.documentId]));u&&du(u,i)<0;)n(u,null),u=a.getNext();u&&u.isEqual(i)&&(n(u,t),u=a.hasNext()?a.getNext():null),u?r.G(fu(u)):r.done()})).next((function(){for(;u;)n(u,null),u=a.hasNext()?a.getNext():null}))}},{key:"getDocumentsMatchingQuery",value:function(e,t,n,r){var i=this,a=t.path,u=[a.popLast().toArray(),a.lastSegment(),Yi(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[a.popLast().toArray(),a.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return lu(e).j(IDBKeyRange.bound(u,o,!0)).next((function(e){var n,a=er(),u=w(e);try{for(u.s();!(n=u.n()).done;){var o=n.value,s=i.Zn(ue.fromSegments(o.prefixPath.concat(o.collectionGroup,o.documentId)),o);s.isFoundDocument()&&(Hn(t,s)||r.has(s.key))&&(a=a.insert(s.key,s))}}catch(c){u.e(c)}finally{u.f()}return a}))}},{key:"getAllFromCollectionGroup",value:function(e,t,n,r){var i=this,a=er(),u=hu(t,n),o=hu(t,ve.max());return lu(e).X({index:"collectionGroupIndex",range:IDBKeyRange.bound(u,o,!0)},(function(e,t,n){var u=i.Zn(ue.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(a=a.insert(u.key,u)).size===r&&n.done()})).next((function(){return a}))}},{key:"newChangeBuffer",value:function(e){return new su(this,!!e&&e.trackRemovals)}},{key:"getSize",value:function(e){return this.getMetadata(e).next((function(e){return e.byteSize}))}},{key:"getMetadata",value:function(e){return cu(e).get("remoteDocumentGlobalKey").next((function(e){return F(!!e),e}))}},{key:"Xn",value:function(e,t){return cu(e).put("remoteDocumentGlobalKey",t)}},{key:"Zn",value:function(e,t){if(t){var n=function(e,t){var n;if(t.document)n=Ni(e.le,t.document,!!t.hasCommittedMutations);else if(t.noDocument){var r=ue.fromSegments(t.noDocument.path),i=$i(t.noDocument.readTime);n=tn.newNoDocument(r,i),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return R();var a=ue.fromSegments(t.unknownDocument.path),u=$i(t.unknownDocument.version);n=tn.newUnknownDocument(a,u)}return t.readTime&&n.setReadTime(function(e){var t=new ee(e[0],e[1]);return te.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!n.isNoDocument()||!n.version.isEqual(te.min()))return n}return tn.newInvalidDocument(e)}}]),e}();function ou(e){return new uu(e)}var su=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this)).rs=e,i.trackRemovals=r,i.os=new $n((function(e){return e.toString()}),(function(e,t){return e.isEqual(t)})),i}return Object(d.a)(n,[{key:"applyChanges",value:function(e){var t=this,n=[],r=0,i=new mt((function(e,t){return J(e.canonicalString(),t.canonicalString())}));return this.changes.forEach((function(a,u){var o=t.os.get(a);if(n.push(t.rs.removeEntry(e,a,o.readTime)),u.isValidDocument()){var s=Xi(t.rs.serializer,u);i=i.add(a.path.popLast());var c=Ua(s);r+=c-o.size,n.push(t.rs.addEntry(e,a,s))}else if(r-=o.size,t.trackRemovals){var l=Xi(t.rs.serializer,u.convertToNoDocument(te.min()));n.push(t.rs.addEntry(e,a,l))}})),i.forEach((function(r){n.push(t.rs.indexManager.addToCollectionParentIndex(e,r))})),n.push(this.rs.updateMetadata(e,r)),be.waitFor(n)}},{key:"getFromCache",value:function(e,t){var n=this;return this.rs.ts(e,t).next((function(e){return n.os.set(t,{size:e.size,readTime:e.document.readTime}),e.document}))}},{key:"getAllFromCache",value:function(e,t){var n=this;return this.rs.ns(e,t).next((function(e){var t=e.documents;return e.ss.forEach((function(e,r){n.os.set(e,{size:r,readTime:t.get(e).readTime})})),t}))}}]),n}(au);function cu(e){return lt(e,"remoteDocumentGlobal")}function lu(e){return lt(e,"remoteDocumentsV14")}function fu(e){var t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function hu(e,t){var n=t.documentKey.path.toArray();return[e,Yi(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function du(e,t){for(var n=e.path.toArray(),r=t.path.toArray(),i=0,a=0;a<n.length-2&&a<r.length-2;++a)if(i=J(n[a],r[a]))return i;return(i=J(n.length,r.length))||((i=J(n[n.length-2],r[r.length-2]))||J(n[n.length-1],r[r.length-1]))}var vu=function e(t,n){Object(h.a)(this,e),this.overlayedDocument=t,this.mutatedFields=n},yu=function(){function e(t,n,r,i){Object(h.a)(this,e),this.remoteDocumentCache=t,this.mutationQueue=n,this.documentOverlayCache=r,this.indexManager=i}return Object(d.a)(e,[{key:"getDocument",value:function(e,t){var n=this,r=null;return this.documentOverlayCache.getOverlay(e,t).next((function(i){return r=i,n.remoteDocumentCache.getEntry(e,t)})).next((function(e){return null!==r&&Rr(r.mutation,e,bt.empty(),ee.now()),e}))}},{key:"getDocuments",value:function(e,t){var n=this;return this.remoteDocumentCache.getEntries(e,t).next((function(t){return n.getLocalViewOfDocuments(e,t,cr()).next((function(){return t}))}))}},{key:"getLocalViewOfDocuments",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:cr(),i=ir();return this.populateOverlays(e,i,t).next((function(){return n.computeViews(e,t,i,r).next((function(e){var t=nr();return e.forEach((function(e,n){t=t.insert(e,n.overlayedDocument)})),t}))}))}},{key:"getOverlayedDocuments",value:function(e,t){var n=this,r=ir();return this.populateOverlays(e,r,t).next((function(){return n.computeViews(e,t,r,cr())}))}},{key:"populateOverlays",value:function(e,t,n){var r=[];return n.forEach((function(e){t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((function(e){e.forEach((function(e,n){t.set(e,n)}))}))}},{key:"computeViews",value:function(e,t,n,r){var i=er(),a=ur(),u=ur();return t.forEach((function(e,t){var u=n.get(t.key);r.has(t.key)&&(void 0===u||u.mutation instanceof Lr)?i=i.insert(t.key,t):void 0!==u?(a.set(t.key,u.mutation.getFieldMask()),Rr(u.mutation,t,u.mutation.getFieldMask(),ee.now())):a.set(t.key,bt.empty())})),this.recalculateAndSaveOverlays(e,i).next((function(e){return e.forEach((function(e,t){return a.set(e,t)})),t.forEach((function(e,t){var n;return u.set(e,new vu(t,null!==(n=a.get(e))&&void 0!==n?n:null))})),u}))}},{key:"recalculateAndSaveOverlays",value:function(e,t){var n=this,r=ur(),i=new vt((function(e,t){return e-t})),a=cr();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((function(e){var n,a=w(e);try{var u=function(){var e=n.value;e.keys().forEach((function(n){var a=t.get(n);if(null!==a){var u=r.get(n)||bt.empty();u=e.applyToLocalView(a,u),r.set(n,u);var o=(i.get(e.batchId)||cr()).add(n);i=i.insert(e.batchId,o)}}))};for(a.s();!(n=a.n()).done;)u()}catch(o){a.e(o)}finally{a.f()}})).next((function(){for(var u=[],o=i.getReverseIterator(),s=function(){var i=o.getNext(),s=i.key,c=i.value,l=ar();c.forEach((function(e){if(!a.has(e)){var n=Cr(t.get(e),r.get(e));null!==n&&l.set(e,n),a=a.add(e)}})),u.push(n.documentOverlayCache.saveOverlays(e,s,l))};o.hasNext();)s();return be.waitFor(u)})).next((function(){return r}))}},{key:"recalculateAndSaveOverlaysForDocumentKeys",value:function(e,t){var n=this;return this.remoteDocumentCache.getEntries(e,t).next((function(t){return n.recalculateAndSaveOverlays(e,t)}))}},{key:"getDocumentsMatchingQuery",value:function(e,t,n){return function(e){return ue.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):qn(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n)}},{key:"getNextDocuments",value:function(e,t,n,r){var i=this;return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((function(a){var u=r-a.size>0?i.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-a.size):be.resolve(ir()),o=-1,s=a;return u.next((function(t){return be.forEach(t,(function(t,n){return o<n.largestBatchId&&(o=n.largestBatchId),a.get(t)?be.resolve():i.remoteDocumentCache.getEntry(e,t).next((function(e){s=s.insert(t,e)}))})).next((function(){return i.populateOverlays(e,t,a)})).next((function(){return i.computeViews(e,s,t,cr())})).next((function(e){return{batchId:o,changes:rr(e)}}))}))}))}},{key:"getDocumentsMatchingDocumentQuery",value:function(e,t){return this.getDocument(e,new ue(t)).next((function(e){var t=nr();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}},{key:"getDocumentsMatchingCollectionGroupQuery",value:function(e,t,n){var r=this,i=t.collectionGroup,a=nr();return this.indexManager.getCollectionParents(e,i).next((function(u){return be.forEach(u,(function(u){var o=function(e,t){return new Rn(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,u.child(i));return r.getDocumentsMatchingCollectionQuery(e,o,n).next((function(e){e.forEach((function(e,t){a=a.insert(e,t)}))}))})).next((function(){return a}))}))}},{key:"getDocumentsMatchingCollectionQuery",value:function(e,t,n){var r,i=this;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((function(a){return r=a,i.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,r)})).next((function(e){r.forEach((function(t,n){var r=n.getKey();null===e.get(r)&&(e=e.insert(r,tn.newInvalidDocument(r)))}));var n=nr();return e.forEach((function(e,i){var a=r.get(e);void 0!==a&&Rr(a.mutation,i,bt.empty(),ee.now()),Hn(t,i)&&(n=n.insert(e,i))})),n}))}}]),e}(),pu=function(){function e(t){Object(h.a)(this,e),this.serializer=t,this.us=new Map,this.cs=new Map}return Object(d.a)(e,[{key:"getBundleMetadata",value:function(e,t){return be.resolve(this.us.get(t))}},{key:"saveBundleMetadata",value:function(e,t){var n;return this.us.set(t.id,{id:(n=t).id,version:n.version,createTime:Ii(n.createTime)}),be.resolve()}},{key:"getNamedQuery",value:function(e,t){return be.resolve(this.cs.get(t))}},{key:"saveNamedQuery",value:function(e,t){return this.cs.set(t.name,function(e){return{name:e.name,query:na(e.bundledQuery),readTime:Ii(e.readTime)}}(t)),be.resolve()}}]),e}(),mu=function(){function e(){Object(h.a)(this,e),this.overlays=new vt(ue.comparator),this.hs=new Map}return Object(d.a)(e,[{key:"getOverlay",value:function(e,t){return be.resolve(this.overlays.get(t))}},{key:"getOverlays",value:function(e,t){var n=this,r=ir();return be.forEach(t,(function(t){return n.getOverlay(e,t).next((function(e){null!==e&&r.set(t,e)}))})).next((function(){return r}))}},{key:"saveOverlays",value:function(e,t,n){var r=this;return n.forEach((function(n,i){r.de(e,t,i)})),be.resolve()}},{key:"removeOverlaysForBatchId",value:function(e,t,n){var r=this,i=this.hs.get(n);return void 0!==i&&(i.forEach((function(e){return r.overlays=r.overlays.remove(e)})),this.hs.delete(n)),be.resolve()}},{key:"getOverlaysForCollection",value:function(e,t,n){for(var r=ir(),i=t.length+1,a=new ue(t.child("")),u=this.overlays.getIteratorFrom(a);u.hasNext();){var o=u.getNext().value,s=o.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&o.largestBatchId>n&&r.set(o.getKey(),o)}return be.resolve(r)}},{key:"getOverlaysForCollectionGroup",value:function(e,t,n,r){for(var i=new vt((function(e,t){return e-t})),a=this.overlays.getIterator();a.hasNext();){var u=a.getNext().value;if(u.getKey().getCollectionGroup()===t&&u.largestBatchId>n){var o=i.get(u.largestBatchId);null===o&&(o=ir(),i=i.insert(u.largestBatchId,o)),o.set(u.getKey(),u)}}for(var s=ir(),c=i.getIterator();c.hasNext()&&(c.getNext().value.forEach((function(e,t){return s.set(e,t)})),!(s.size()>=r)););return be.resolve(s)}},{key:"de",value:function(e,t,n){var r=this.overlays.get(n.key);if(null!==r){var i=this.hs.get(r.largestBatchId).delete(n.key);this.hs.set(r.largestBatchId,i)}this.overlays=this.overlays.insert(n.key,new Hr(t,n));var a=this.hs.get(t);void 0===a&&(a=cr(),this.hs.set(t,a)),this.hs.set(t,a.add(n.key))}}]),e}(),gu=function(){function e(){Object(h.a)(this,e),this.ls=new mt(ku.fs),this.ds=new mt(ku._s)}return Object(d.a)(e,[{key:"isEmpty",value:function(){return this.ls.isEmpty()}},{key:"addReference",value:function(e,t){var n=new ku(e,t);this.ls=this.ls.add(n),this.ds=this.ds.add(n)}},{key:"ws",value:function(e,t){var n=this;e.forEach((function(e){return n.addReference(e,t)}))}},{key:"removeReference",value:function(e,t){this.gs(new ku(e,t))}},{key:"ys",value:function(e,t){var n=this;e.forEach((function(e){return n.removeReference(e,t)}))}},{key:"ps",value:function(e){var t=this,n=new ue(new re([])),r=new ku(n,e),i=new ku(n,e+1),a=[];return this.ds.forEachInRange([r,i],(function(e){t.gs(e),a.push(e.key)})),a}},{key:"Is",value:function(){var e=this;this.ls.forEach((function(t){return e.gs(t)}))}},{key:"gs",value:function(e){this.ls=this.ls.delete(e),this.ds=this.ds.delete(e)}},{key:"Ts",value:function(e){var t=new ue(new re([])),n=new ku(t,e),r=new ku(t,e+1),i=cr();return this.ds.forEachInRange([n,r],(function(e){i=i.add(e.key)})),i}},{key:"containsKey",value:function(e){var t=new ku(e,0),n=this.ls.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}]),e}(),ku=function(){function e(t,n){Object(h.a)(this,e),this.key=t,this.Es=n}return Object(d.a)(e,null,[{key:"fs",value:function(e,t){return ue.comparator(e.key,t.key)||J(e.Es,t.Es)}},{key:"_s",value:function(e,t){return J(e.Es,t.Es)||ue.comparator(e.key,t.key)}}]),e}(),bu=function(){function e(t,n){Object(h.a)(this,e),this.indexManager=t,this.referenceDelegate=n,this.mutationQueue=[],this.As=1,this.Rs=new mt(ku.fs)}return Object(d.a)(e,[{key:"checkEmpty",value:function(e){return be.resolve(0===this.mutationQueue.length)}},{key:"addMutationBatch",value:function(e,t,n,r){var i=this.As;this.As++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];var a=new Qr(i,t,n,r);this.mutationQueue.push(a);var u,o=w(r);try{for(o.s();!(u=o.n()).done;){var s=u.value;this.Rs=this.Rs.add(new ku(s.key,i)),this.indexManager.addToCollectionParentIndex(e,s.key.path.popLast())}}catch(c){o.e(c)}finally{o.f()}return be.resolve(a)}},{key:"lookupMutationBatch",value:function(e,t){return be.resolve(this.vs(t))}},{key:"getNextMutationBatchAfterBatchId",value:function(e,t){var n=t+1,r=this.Ps(n),i=r<0?0:r;return be.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)}},{key:"getHighestUnacknowledgedBatchId",value:function(){return be.resolve(0===this.mutationQueue.length?-1:this.As-1)}},{key:"getAllMutationBatches",value:function(e){return be.resolve(this.mutationQueue.slice())}},{key:"getAllMutationBatchesAffectingDocumentKey",value:function(e,t){var n=this,r=new ku(t,0),i=new ku(t,Number.POSITIVE_INFINITY),a=[];return this.Rs.forEachInRange([r,i],(function(e){var t=n.vs(e.Es);a.push(t)})),be.resolve(a)}},{key:"getAllMutationBatchesAffectingDocumentKeys",value:function(e,t){var n=this,r=new mt(J);return t.forEach((function(e){var t=new ku(e,0),i=new ku(e,Number.POSITIVE_INFINITY);n.Rs.forEachInRange([t,i],(function(e){r=r.add(e.Es)}))})),be.resolve(this.bs(r))}},{key:"getAllMutationBatchesAffectingQuery",value:function(e,t){var n=t.path,r=n.length+1,i=n;ue.isDocumentKey(i)||(i=i.child(""));var a=new ku(new ue(i),0),u=new mt(J);return this.Rs.forEachWhile((function(e){var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(u=u.add(e.Es)),!0)}),a),be.resolve(this.bs(u))}},{key:"bs",value:function(e){var t=this,n=[];return e.forEach((function(e){var r=t.vs(e);null!==r&&n.push(r)})),n}},{key:"removeMutationBatch",value:function(e,t){var n=this;F(0===this.Vs(t.batchId,"removed")),this.mutationQueue.shift();var r=this.Rs;return be.forEach(t.mutations,(function(i){var a=new ku(i.key,t.batchId);return r=r.delete(a),n.referenceDelegate.markPotentiallyOrphaned(e,i.key)})).next((function(){n.Rs=r}))}},{key:"Dn",value:function(e){}},{key:"containsKey",value:function(e,t){var n=new ku(t,0),r=this.Rs.firstAfterOrEqual(n);return be.resolve(t.isEqual(r&&r.key))}},{key:"performConsistencyCheck",value:function(e){return this.mutationQueue.length,be.resolve()}},{key:"Vs",value:function(e,t){return this.Ps(e)}},{key:"Ps",value:function(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}},{key:"vs",value:function(e){var t=this.Ps(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}]),e}(),wu=function(){function e(t){Object(h.a)(this,e),this.Ss=t,this.docs=new vt(ue.comparator),this.size=0}return Object(d.a)(e,[{key:"setIndexManager",value:function(e){this.indexManager=e}},{key:"addEntry",value:function(e,t){var n=t.key,r=this.docs.get(n),i=r?r.size:0,a=this.Ss(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:a}),this.size+=a-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}},{key:"removeEntry",value:function(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}},{key:"getEntry",value:function(e,t){var n=this.docs.get(t);return be.resolve(n?n.document.mutableCopy():tn.newInvalidDocument(t))}},{key:"getEntries",value:function(e,t){var n=this,r=er();return t.forEach((function(e){var t=n.docs.get(e);r=r.insert(e,t?t.document.mutableCopy():tn.newInvalidDocument(e))})),be.resolve(r)}},{key:"getDocumentsMatchingQuery",value:function(e,t,n,r){for(var i=er(),a=t.path,u=new ue(a.child("")),o=this.docs.getIteratorFrom(u);o.hasNext();){var s=o.getNext(),c=s.key,l=s.value.document;if(!a.isPrefixOf(c.path))break;c.path.length>a.length+1||ye(de(l),n)<=0||(r.has(l.key)||Hn(t,l))&&(i=i.insert(l.key,l.mutableCopy()))}return be.resolve(i)}},{key:"getAllFromCollectionGroup",value:function(e,t,n,r){R()}},{key:"Ds",value:function(e,t){return be.forEach(this.docs,(function(e){return t(e)}))}},{key:"newChangeBuffer",value:function(e){return new xu(this)}},{key:"getSize",value:function(e){return be.resolve(this.size)}}]),e}(),xu=function(e){Object(s.a)(n,e);var t=I(n);function n(e){var r;return Object(h.a)(this,n),(r=t.call(this)).rs=e,r}return Object(d.a)(n,[{key:"applyChanges",value:function(e){var t=this,n=[];return this.changes.forEach((function(r,i){i.isValidDocument()?n.push(t.rs.addEntry(e,i)):t.rs.removeEntry(r)})),be.waitFor(n)}},{key:"getFromCache",value:function(e,t){return this.rs.getEntry(e,t)}},{key:"getAllFromCache",value:function(e,t){return this.rs.getEntries(e,t)}}]),n}(au),Iu=function(){function e(t){Object(h.a)(this,e),this.persistence=t,this.Cs=new $n((function(e){return _n(e)}),jn),this.lastRemoteSnapshotVersion=te.min(),this.highestTargetId=0,this.xs=0,this.Ns=new gu,this.targetCount=0,this.ks=Wa.Nn()}return Object(d.a)(e,[{key:"forEachTarget",value:function(e,t){return this.Cs.forEach((function(e,n){return t(n)})),be.resolve()}},{key:"getLastRemoteSnapshotVersion",value:function(e){return be.resolve(this.lastRemoteSnapshotVersion)}},{key:"getHighestSequenceNumber",value:function(e){return be.resolve(this.xs)}},{key:"allocateTargetId",value:function(e){return this.highestTargetId=this.ks.next(),be.resolve(this.highestTargetId)}},{key:"setTargetsMetadata",value:function(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.xs&&(this.xs=t),be.resolve()}},{key:"$n",value:function(e){this.Cs.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.ks=new Wa(t),this.highestTargetId=t),e.sequenceNumber>this.xs&&(this.xs=e.sequenceNumber)}},{key:"addTargetData",value:function(e,t){return this.$n(t),this.targetCount+=1,be.resolve()}},{key:"updateTargetData",value:function(e,t){return this.$n(t),be.resolve()}},{key:"removeTargetData",value:function(e,t){return this.Cs.delete(t.target),this.Ns.ps(t.targetId),this.targetCount-=1,be.resolve()}},{key:"removeTargets",value:function(e,t,n){var r=this,i=0,a=[];return this.Cs.forEach((function(u,o){o.sequenceNumber<=t&&null===n.get(o.targetId)&&(r.Cs.delete(u),a.push(r.removeMatchingKeysForTargetId(e,o.targetId)),i++)})),be.waitFor(a).next((function(){return i}))}},{key:"getTargetCount",value:function(e){return be.resolve(this.targetCount)}},{key:"getTargetData",value:function(e,t){var n=this.Cs.get(t)||null;return be.resolve(n)}},{key:"addMatchingKeys",value:function(e,t,n){return this.Ns.ws(t,n),be.resolve()}},{key:"removeMatchingKeys",value:function(e,t,n){this.Ns.ys(t,n);var r=this.persistence.referenceDelegate,i=[];return r&&t.forEach((function(t){i.push(r.markPotentiallyOrphaned(e,t))})),be.waitFor(i)}},{key:"removeMatchingKeysForTargetId",value:function(e,t){return this.Ns.ps(t),be.resolve()}},{key:"getMatchingKeysForTargetId",value:function(e,t){var n=this.Ns.Ts(t);return be.resolve(n)}},{key:"containsKey",value:function(e,t){return be.resolve(this.Ns.containsKey(t))}}]),e}(),Ou=function(){function e(t,n){var r=this;Object(h.a)(this,e),this.Ms={},this.overlays={},this.Os=new Ce(0),this.$s=!1,this.$s=!0,this.referenceDelegate=t(this),this.Fs=new Iu(this),this.indexManager=new ja,this.remoteDocumentCache=new wu((function(e){return r.referenceDelegate.Bs(e)})),this.serializer=new Hi(n),this.Ls=new pu(this.serializer)}return Object(d.a)(e,[{key:"start",value:function(){return Promise.resolve()}},{key:"shutdown",value:function(){return this.$s=!1,Promise.resolve()}},{key:"started",get:function(){return this.$s}},{key:"setDatabaseDeletedListener",value:function(){}},{key:"setNetworkEnabled",value:function(){}},{key:"getIndexManager",value:function(e){return this.indexManager}},{key:"getDocumentOverlayCache",value:function(e){var t=this.overlays[e.toKey()];return t||(t=new mu,this.overlays[e.toKey()]=t),t}},{key:"getMutationQueue",value:function(e,t){var n=this.Ms[e.toKey()];return n||(n=new bu(t,this.referenceDelegate),this.Ms[e.toKey()]=n),n}},{key:"getTargetCache",value:function(){return this.Fs}},{key:"getRemoteDocumentCache",value:function(){return this.remoteDocumentCache}},{key:"getBundleCache",value:function(){return this.Ls}},{key:"runTransaction",value:function(e,t,n){var r=this;D("MemoryPersistence","Starting transaction:",e);var i=new Eu(this.Os.next());return this.referenceDelegate.qs(),n(i).next((function(e){return r.referenceDelegate.Us(i).next((function(){return e}))})).toPromise().then((function(e){return i.raiseOnCommittedEvent(),e}))}},{key:"Ks",value:function(e,t){return be.or(Object.values(this.Ms).map((function(n){return function(){return n.containsKey(e,t)}})))}}]),e}(),Eu=function(e){Object(s.a)(n,e);var t=I(n);function n(e){var r;return Object(h.a)(this,n),(r=t.call(this)).currentSequenceNumber=e,r}return n}(me),Tu=function(){function e(t){Object(h.a)(this,e),this.persistence=t,this.Gs=new gu,this.Qs=null}return Object(d.a)(e,[{key:"zs",get:function(){if(this.Qs)return this.Qs;throw R()}},{key:"addReference",value:function(e,t,n){return this.Gs.addReference(n,t),this.zs.delete(n.toString()),be.resolve()}},{key:"removeReference",value:function(e,t,n){return this.Gs.removeReference(n,t),this.zs.add(n.toString()),be.resolve()}},{key:"markPotentiallyOrphaned",value:function(e,t){return this.zs.add(t.toString()),be.resolve()}},{key:"removeTarget",value:function(e,t){var n=this;this.Gs.ps(t.targetId).forEach((function(e){return n.zs.add(e.toString())}));var r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(e,t.targetId).next((function(e){e.forEach((function(e){return n.zs.add(e.toString())}))})).next((function(){return r.removeTargetData(e,t)}))}},{key:"qs",value:function(){this.Qs=new Set}},{key:"Us",value:function(e){var t=this,n=this.persistence.getRemoteDocumentCache().newChangeBuffer();return be.forEach(this.zs,(function(r){var i=ue.fromPath(r);return t.Ws(e,i).next((function(e){e||n.removeEntry(i,te.min())}))})).next((function(){return t.Qs=null,n.apply(e)}))}},{key:"updateLimboDocument",value:function(e,t){var n=this;return this.Ws(e,t).next((function(e){e?n.zs.delete(t.toString()):n.zs.add(t.toString())}))}},{key:"Bs",value:function(e){return 0}},{key:"Ws",value:function(e,t){var n=this;return be.or([function(){return be.resolve(n.Gs.containsKey(t))},function(){return n.persistence.getTargetCache().containsKey(e,t)},function(){return n.persistence.Ks(e,t)}])}}],[{key:"js",value:function(t){return new e(t)}}]),e}(),Su=function(){function e(t){Object(h.a)(this,e),this.serializer=t}return Object(d.a)(e,[{key:"$",value:function(e,t,n,r){var i=this,a=new we("createOrUpgrade",t);n<1&&r>=1&&(function(e){e.createObjectStore("owner")}(e),function(e){e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",qe,{unique:!0}),e.createObjectStore("documentMutations")}(e),_u(e),function(e){e.createObjectStore("remoteDocuments")}(e));var u=be.resolve();return n<3&&r>=3&&(0!==n&&(function(e){e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal")}(e),_u(e)),u=u.next((function(){return function(e){var t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:te.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(a)}))),n<4&&r>=4&&(0!==n&&(u=u.next((function(){return function(e,t){return t.store("mutations").j().next((function(n){e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",qe,{unique:!0});var r=t.store("mutations"),i=n.map((function(e){return r.put(e)}));return be.waitFor(i)}))}(e,a)}))),u=u.next((function(){!function(e){e.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)}))),n<5&&r>=5&&(u=u.next((function(){return i.Js(a)}))),n<6&&r>=6&&(u=u.next((function(){return function(e){e.createObjectStore("remoteDocumentGlobal")}(e),i.Ys(a)}))),n<7&&r>=7&&(u=u.next((function(){return i.Xs(a)}))),n<8&&r>=8&&(u=u.next((function(){return i.Zs(e,a)}))),n<9&&r>=9&&(u=u.next((function(){!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)}))),n<10&&r>=10&&(u=u.next((function(){return i.ti(a)}))),n<11&&r>=11&&(u=u.next((function(){!function(e){e.createObjectStore("bundles",{keyPath:"bundleId"})}(e),function(e){e.createObjectStore("namedQueries",{keyPath:"name"})}(e)}))),n<12&&r>=12&&(u=u.next((function(){!function(e){var t=e.createObjectStore("documentOverlays",{keyPath:tt});t.createIndex("collectionPathOverlayIndex",nt,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",rt,{unique:!1})}(e)}))),n<13&&r>=13&&(u=u.next((function(){return function(e){var t=e.createObjectStore("remoteDocumentsV14",{keyPath:ze});t.createIndex("documentKeyIndex",Ge),t.createIndex("collectionGroupIndex",Qe)}(e)})).next((function(){return i.ei(e,a)})).next((function(){return e.deleteObjectStore("remoteDocuments")}))),n<14&&r>=14&&(u=u.next((function(){return i.ni(e,a)}))),n<15&&r>=15&&(u=u.next((function(){return function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Je}).createIndex("sequenceNumberIndex",$e,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Ze}).createIndex("documentKeyIndex",et,{unique:!1})}(e)}))),u}},{key:"Ys",value:function(e){var t=0;return e.store("remoteDocuments").X((function(e,n){t+=Ua(n)})).next((function(){var n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}},{key:"Js",value:function(e){var t=this,n=e.store("mutationQueues"),r=e.store("mutations");return n.j().next((function(n){return be.forEach(n,(function(n){var i=IDBKeyRange.bound([n.userId,-1],[n.userId,n.lastAcknowledgedBatchId]);return r.j("userMutationsIndex",i).next((function(r){return be.forEach(r,(function(r){F(r.userId===n.userId);var i=Zi(t.serializer,r);return qa(e,n.userId,i).next((function(){}))}))}))}))}))}},{key:"Xs",value:function(e){var t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next((function(e){var r=[];return n.X((function(n,i){var a=new re(n),u=function(e){return[0,Me(e)]}(a);r.push(t.get(u).next((function(n){return n?be.resolve():function(n){return t.put({targetId:0,path:Me(n),sequenceNumber:e.highestListenSequenceNumber})}(a)})))})).next((function(){return be.waitFor(r)}))}))}},{key:"Zs",value:function(e,t){e.createObjectStore("collectionParents",{keyPath:Ye});var n=t.store("collectionParents"),r=new Da,i=function(e){if(r.add(e)){var t=e.lastSegment(),i=e.popLast();return n.put({collectionId:t,parent:Me(i)})}};return t.store("remoteDocuments").X({Y:!0},(function(e,t){var n=new re(e);return i(n.popLast())})).next((function(){return t.store("documentMutations").X({Y:!0},(function(e,t){var n=Object(a.a)(e,3),r=(n[0],n[1]),u=(n[2],Pe(r));return i(u.popLast())}))}))}},{key:"ti",value:function(e){var t=this,n=e.store("targets");return n.X((function(e,r){var i=ea(r),a=ta(t.serializer,i);return n.put(a)}))}},{key:"ei",value:function(e,t){var n=t.store("remoteDocuments"),r=[];return n.X((function(e,n){var i,a=t.store("remoteDocumentsV14"),u=(i=n,i.document?new ue(re.fromString(i.document.name).popFirst(5)):i.noDocument?ue.fromSegments(i.noDocument.path):i.unknownDocument?ue.fromSegments(i.unknownDocument.path):R()).path.toArray(),o={prefixPath:u.slice(0,u.length-2),collectionGroup:u[u.length-2],documentId:u[u.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(a.put(o))})).next((function(){return be.waitFor(r)}))}},{key:"ni",value:function(e,t){var n=this,r=t.store("mutations"),i=ou(this.serializer),a=new Ou(Tu.js,this.serializer.le);return r.j().next((function(e){var r=new Map;return e.forEach((function(e){var t,i=null!==(t=r.get(e.userId))&&void 0!==t?t:cr();Zi(n.serializer,e).keys().forEach((function(e){return i=i.add(e)})),r.set(e.userId,i)})),be.forEach(r,(function(e,r){var u=new E(r),o=ca.fe(n.serializer,u),s=a.getIndexManager(u),c=Ba.fe(u,n.serializer,s,a.referenceDelegate);return new yu(i,c,o,s).recalculateAndSaveOverlaysForDocumentKeys(new ct(t,Ce.ct),e).next()}))}))}}]),e}();function _u(e){e.createObjectStore("targetDocuments",{keyPath:He}).createIndex("documentTargetsIndex",Xe,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",We,{unique:!0}),e.createObjectStore("targetGlobal")}var ju="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",Du=function(){function e(t,n,r,i,a,u,o,s,c,l){var f=arguments.length>10&&void 0!==arguments[10]?arguments[10]:15;if(Object(h.a)(this,e),this.allowTabSynchronization=t,this.persistenceKey=n,this.clientId=r,this.si=a,this.window=u,this.document=o,this.ii=c,this.ri=l,this.oi=f,this.Os=null,this.$s=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ui=null,this.inForeground=!1,this.ci=null,this.ai=null,this.hi=Number.NEGATIVE_INFINITY,this.li=function(e){return Promise.resolve()},!e.D())throw new P(L.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new ru(this,i),this.fi=n+"main",this.serializer=new Hi(s),this.di=new xe(this.fi,this.oi,new Su(this.serializer)),this.Fs=new Ha(this.referenceDelegate,this.serializer),this.remoteDocumentCache=ou(this.serializer),this.Ls=new ua,this.window&&this.window.localStorage?this._i=this.window.localStorage:(this._i=null,!1===l&&A("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}var t,n;return Object(d.a)(e,[{key:"start",value:function(){var e=this;return this.wi().then((function(){if(!e.isPrimary&&!e.allowTabSynchronization)throw new P(L.FAILED_PRECONDITION,ju);return e.mi(),e.gi(),e.yi(),e.runTransaction("getHighestListenSequenceNumber","readonly",(function(t){return e.Fs.getHighestSequenceNumber(t)}))})).then((function(t){e.Os=new Ce(t,e.ii)})).then((function(){e.$s=!0})).catch((function(t){return e.di&&e.di.close(),Promise.reject(t)}))}},{key:"pi",value:function(e){var t=this;return this.li=function(){var n=Object(o.a)(y.a.mark((function n(r){return y.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!t.started){n.next=2;break}return n.abrupt("return",e(r));case 2:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),e(this.isPrimary)}},{key:"setDatabaseDeletedListener",value:function(e){this.di.B(function(){var t=Object(o.a)(y.a.mark((function t(n){return y.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(t.t0=null===n.newVersion,!t.t0){t.next=4;break}return t.next=4,e();case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},{key:"setNetworkEnabled",value:function(e){var t=this;this.networkEnabled!==e&&(this.networkEnabled=e,this.si.enqueueAndForget(Object(o.a)(y.a.mark((function e(){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=t.started,!e.t0){e.next=4;break}return e.next=4,t.wi();case 4:case"end":return e.stop()}}),e)})))))}},{key:"wi",value:function(){var e=this;return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(function(t){return Cu(t).put({clientId:e.clientId,updateTimeMs:Date.now(),networkEnabled:e.networkEnabled,inForeground:e.inForeground}).next((function(){if(e.isPrimary)return e.Ii(t).next((function(t){t||(e.isPrimary=!1,e.si.enqueueRetryable((function(){return e.li(!1)})))}))})).next((function(){return e.Ti(t)})).next((function(n){return e.isPrimary&&!n?e.Ei(t).next((function(){return!1})):!!n&&e.Ai(t).next((function(){return!0}))}))})).catch((function(t){if(Ee(t))return D("IndexedDbPersistence","Failed to extend owner lease: ",t),e.isPrimary;if(!e.allowTabSynchronization)throw t;return D("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((function(t){e.isPrimary!==t&&e.si.enqueueRetryable((function(){return e.li(t)})),e.isPrimary=t}))}},{key:"Ii",value:function(e){var t=this;return Au(e).get("owner").next((function(e){return be.resolve(t.Ri(e))}))}},{key:"vi",value:function(e){return Cu(e).delete(this.clientId)}},{key:"Pi",value:(n=Object(o.a)(y.a.mark((function e(){var t,n,r,i,a=this;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isPrimary||this.bi(this.hi,18e5)){e.next=6;break}return this.hi=Date.now(),e.next=4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(function(e){var t=lt(e,"clientMetadata");return t.j().next((function(e){var n=a.Vi(e,18e5),r=e.filter((function(e){return-1===n.indexOf(e)}));return be.forEach(r,(function(e){return t.delete(e.clientId)})).next((function(){return r}))}))})).catch((function(){return[]}));case 4:if(t=e.sent,this._i){n=w(t);try{for(n.s();!(r=n.n()).done;)i=r.value,this._i.removeItem(this.Si(i.clientId))}catch(u){n.e(u)}finally{n.f()}}case 6:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"yi",value:function(){var e=this;this.ai=this.si.enqueueAfterDelay("client_metadata_refresh",4e3,(function(){return e.wi().then((function(){return e.Pi()})).then((function(){return e.yi()}))}))}},{key:"Ri",value:function(e){return!!e&&e.ownerId===this.clientId}},{key:"Ti",value:function(e){var t=this;return this.ri?be.resolve(!0):Au(e).get("owner").next((function(n){if(null!==n&&t.bi(n.leaseTimestampMs,5e3)&&!t.Di(n.ownerId)){if(t.Ri(n)&&t.networkEnabled)return!0;if(!t.Ri(n)){if(!n.allowTabSynchronization)throw new P(L.FAILED_PRECONDITION,ju);return!1}}return!(!t.networkEnabled||!t.inForeground)||Cu(e).j().next((function(e){return void 0===t.Vi(e,5e3).find((function(e){if(t.clientId!==e.clientId){var n=!t.networkEnabled&&e.networkEnabled,r=!t.inForeground&&e.inForeground,i=t.networkEnabled===e.networkEnabled;if(n||r&&i)return!0}return!1}))}))})).next((function(e){return t.isPrimary!==e&&D("IndexedDbPersistence","Client ".concat(e?"is":"is not"," eligible for a primary lease.")),e}))}},{key:"shutdown",value:(t=Object(o.a)(y.a.mark((function e(){var t=this;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.$s=!1,this.Ci(),this.ai&&(this.ai.cancel(),this.ai=null),this.xi(),this.Ni(),e.next=7,this.di.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(function(e){var n=new ct(e,Ce.ct);return t.Ei(n).next((function(){return t.vi(n)}))}));case 7:this.di.close(),this.ki();case 9:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"Vi",value:function(e,t){var n=this;return e.filter((function(e){return n.bi(e.updateTimeMs,t)&&!n.Di(e.clientId)}))}},{key:"Mi",value:function(){var e=this;return this.runTransaction("getActiveClients","readonly",(function(t){return Cu(t).j().next((function(t){return e.Vi(t,18e5).map((function(e){return e.clientId}))}))}))}},{key:"started",get:function(){return this.$s}},{key:"getMutationQueue",value:function(e,t){return Ba.fe(e,this.serializer,t,this.referenceDelegate)}},{key:"getTargetCache",value:function(){return this.Fs}},{key:"getRemoteDocumentCache",value:function(){return this.remoteDocumentCache}},{key:"getIndexManager",value:function(e){return new Ca(e,this.serializer.le.databaseId)}},{key:"getDocumentOverlayCache",value:function(e){return ca.fe(this.serializer,e)}},{key:"getBundleCache",value:function(){return this.Ls}},{key:"runTransaction",value:function(e,t,n){var r=this;D("IndexedDbPersistence","Starting transaction:",e);var i,a,u="readonly"===t?"readonly":"readwrite",o=15===(i=this.oi)?st:14===i?ot:13===i?ut:12===i?at:11===i?it:void R();return this.di.runTransaction(e,u,o,(function(i){return a=new ct(i,r.Os?r.Os.next():Ce.ct),"readwrite-primary"===t?r.Ii(a).next((function(e){return!!e||r.Ti(a)})).next((function(t){if(!t)throw A("Failed to obtain primary lease for action '".concat(e,"'.")),r.isPrimary=!1,r.si.enqueueRetryable((function(){return r.li(!1)})),new P(L.FAILED_PRECONDITION,pe);return n(a)})).next((function(e){return r.Ai(a).next((function(){return e}))})):r.Oi(a).next((function(){return n(a)}))})).then((function(e){return a.raiseOnCommittedEvent(),e}))}},{key:"Oi",value:function(e){var t=this;return Au(e).get("owner").next((function(e){if(null!==e&&t.bi(e.leaseTimestampMs,5e3)&&!t.Di(e.ownerId)&&!t.Ri(e)&&!(t.ri||t.allowTabSynchronization&&e.allowTabSynchronization))throw new P(L.FAILED_PRECONDITION,ju)}))}},{key:"Ai",value:function(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Au(e).put("owner",t)}},{key:"Ei",value:function(e){var t=this,n=Au(e);return n.get("owner").next((function(e){return t.Ri(e)?(D("IndexedDbPersistence","Releasing primary lease."),n.delete("owner")):be.resolve()}))}},{key:"bi",value:function(e,t){var n=Date.now();return!(e<n-t||e>n&&(A("Detected an update time that is in the future: ".concat(e," > ").concat(n)),1))}},{key:"mi",value:function(){var e=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ci=function(){e.si.enqueueAndForget((function(){return e.inForeground="visible"===e.document.visibilityState,e.wi()}))},this.document.addEventListener("visibilitychange",this.ci),this.inForeground="visible"===this.document.visibilityState)}},{key:"xi",value:function(){this.ci&&(this.document.removeEventListener("visibilitychange",this.ci),this.ci=null)}},{key:"gi",value:function(){var e,t=this;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ui=function(){t.Ci();var e=/(?:Version|Mobile)\/1[456]/;Object(k.z)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&t.si.enterRestrictedMode(!0),t.si.enqueueAndForget((function(){return t.shutdown()}))},this.window.addEventListener("pagehide",this.ui))}},{key:"Ni",value:function(){this.ui&&(this.window.removeEventListener("pagehide",this.ui),this.ui=null)}},{key:"Di",value:function(e){var t;try{var n=null!==(null===(t=this._i)||void 0===t?void 0:t.getItem(this.Si(e)));return D("IndexedDbPersistence","Client '".concat(e,"' ").concat(n?"is":"is not"," zombied in LocalStorage")),n}catch(e){return A("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}},{key:"Ci",value:function(){if(this._i)try{this._i.setItem(this.Si(this.clientId),String(Date.now()))}catch(e){A("Failed to set zombie client id.",e)}}},{key:"ki",value:function(){if(this._i)try{this._i.removeItem(this.Si(this.clientId))}catch(e){}}},{key:"Si",value:function(e){return"firestore_zombie_".concat(this.persistenceKey,"_").concat(e)}}],[{key:"D",value:function(){return xe.D()}}]),e}();function Au(e){return lt(e,"owner")}function Cu(e){return lt(e,"clientMetadata")}function Nu(e,t){var n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}var Ru=function(){function e(t,n,r,i){Object(h.a)(this,e),this.targetId=t,this.fromCache=n,this.$i=r,this.Fi=i}return Object(d.a)(e,null,[{key:"Bi",value:function(t,n){var r,i=cr(),a=cr(),u=w(n.docChanges);try{for(u.s();!(r=u.n()).done;){var o=r.value;switch(o.type){case 0:i=i.add(o.doc.key);break;case 1:a=a.add(o.doc.key)}}}catch(s){u.e(s)}finally{u.f()}return new e(t,n.fromCache,i,a)}}]),e}(),Fu=function(){function e(){Object(h.a)(this,e),this.Li=!1}return Object(d.a)(e,[{key:"initialize",value:function(e,t){this.qi=e,this.indexManager=t,this.Li=!0}},{key:"getDocumentsMatchingQuery",value:function(e,t,n,r){var i=this;return this.Ui(e,t).next((function(a){return a||i.Ki(e,t,r,n)})).next((function(n){return n||i.Gi(e,t)}))}},{key:"Ui",value:function(e,t){var n=this;if(Vn(t))return be.resolve(null);var r=Bn(t);return this.indexManager.getIndexType(e,r).next((function(i){return 0===i?null:(null!==t.limit&&1===i&&(t=zn(t,null,"F"),r=Bn(t)),n.indexManager.getDocumentsMatchingTarget(e,r).next((function(i){var a=cr.apply(void 0,Object(f.a)(i));return n.qi.getDocuments(e,a).next((function(i){return n.indexManager.getMinOffset(e,r).next((function(r){var u=n.Qi(t,i);return n.ji(t,u,a,r.readTime)?n.Ui(e,zn(t,null,"F")):n.zi(e,u,t,r)}))}))})))}))}},{key:"Ki",value:function(e,t,n,r){var i=this;return Vn(t)||r.isEqual(te.min())?this.Gi(e,t):this.qi.getDocuments(e,n).next((function(a){var u=i.Qi(t,a);return i.ji(t,u,n,r)?i.Gi(e,t):(_()<=g.a.DEBUG&&D("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),Wn(t)),i.zi(e,u,t,he(r,-1)))}))}},{key:"Qi",value:function(e,t){var n=new mt(Yn(e));return t.forEach((function(t,r){Hn(e,r)&&(n=n.add(r))})),n}},{key:"ji",value:function(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;var i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}},{key:"Gi",value:function(e,t){return _()<=g.a.DEBUG&&D("QueryEngine","Using full collection scan to execute query:",Wn(t)),this.qi.getDocumentsMatchingQuery(e,t,ve.min())}},{key:"zi",value:function(e,t,n,r){return this.qi.getDocumentsMatchingQuery(e,n,r).next((function(e){return t.forEach((function(t){e=e.insert(t.key,t)})),e}))}}]),e}(),Mu=function(){function e(t,n,r,i){Object(h.a)(this,e),this.persistence=t,this.Wi=n,this.serializer=i,this.Hi=new vt(J),this.Ji=new $n((function(e){return _n(e)}),jn),this.Yi=new Map,this.Xi=t.getRemoteDocumentCache(),this.Fs=t.getTargetCache(),this.Ls=t.getBundleCache(),this.Zi(r)}return Object(d.a)(e,[{key:"Zi",value:function(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new yu(this.Xi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Xi.setIndexManager(this.indexManager),this.Wi.initialize(this.localDocuments,this.indexManager)}},{key:"collectGarbage",value:function(e){var t=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",(function(n){return e.collect(n,t.Hi)}))}}]),e}();function Vu(e,t,n,r){return new Mu(e,t,n,r)}function Lu(e,t){return Pu.apply(this,arguments)}function Pu(){return(Pu=Object(o.a)(y.a.mark((function e(t,n){var r;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=V(t),e.next=3,r.persistence.runTransaction("Handle user change","readonly",(function(e){var t;return r.mutationQueue.getAllMutationBatches(e).next((function(i){return t=i,r.Zi(n),r.mutationQueue.getAllMutationBatches(e)})).next((function(n){var i,a=[],u=[],o=cr(),s=w(t);try{for(s.s();!(i=s.n()).done;){var c=i.value;a.push(c.batchId);var l,f=w(c.mutations);try{for(f.s();!(l=f.n()).done;){var h=l.value;o=o.add(h.key)}}catch(k){f.e(k)}finally{f.f()}}}catch(k){s.e(k)}finally{s.f()}var d,v=w(n);try{for(v.s();!(d=v.n()).done;){var y=d.value;u.push(y.batchId);var p,m=w(y.mutations);try{for(m.s();!(p=m.n()).done;){var g=p.value;o=o.add(g.key)}}catch(k){m.e(k)}finally{m.f()}}}catch(k){v.e(k)}finally{v.f()}return r.localDocuments.getDocuments(e,o).next((function(e){return{tr:e,removedBatchIds:a,addedBatchIds:u}}))}))}));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function qu(e,t){var n=V(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(function(e){var r=t.batch.keys(),i=n.Xi.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){var i=n.batch,a=i.keys(),u=be.resolve();return a.forEach((function(e){u=u.next((function(){return r.getEntry(t,e)})).next((function(t){var a=n.docVersions.get(e);F(null!==a),t.version.compareTo(a)<0&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),u.next((function(){return e.mutationQueue.removeMutationBatch(t,i)}))}(n,e,t,i).next((function(){return i.apply(e)})).next((function(){return n.mutationQueue.performConsistencyCheck(e)})).next((function(){return n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId)})).next((function(){return n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){for(var t=cr(),n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t))})).next((function(){return n.localDocuments.getDocuments(e,r)}))}))}function Uu(e){var t=V(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(function(e){return t.Fs.getLastRemoteSnapshotVersion(e)}))}function Bu(e,t){var n=V(e),r=t.snapshotVersion,i=n.Hi;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(function(e){var a=n.Xi.newChangeBuffer({trackRemovals:!0});i=n.Hi;var u=[];t.targetChanges.forEach((function(a,o){var s=i.get(o);if(s){u.push(n.Fs.removeMatchingKeys(e,a.removedDocuments,o).next((function(){return n.Fs.addMatchingKeys(e,a.addedDocuments,o)})));var c=s.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(o)?c=c.withResumeToken(It.EMPTY_BYTE_STRING,te.min()).withLastLimboFreeSnapshotVersion(te.min()):a.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(a.resumeToken,r)),i=i.insert(o,c),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||(t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0)}(s,c,a)&&u.push(n.Fs.updateTargetData(e,c))}}));var o=er(),s=cr();if(t.documentUpdates.forEach((function(r){t.resolvedLimboDocuments.has(r)&&u.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),u.push(Ku(e,a,t.documentUpdates).next((function(e){o=e.er,s=e.nr}))),!r.isEqual(te.min())){var c=n.Fs.getLastRemoteSnapshotVersion(e).next((function(t){return n.Fs.setTargetsMetadata(e,e.currentSequenceNumber,r)}));u.push(c)}return be.waitFor(u).next((function(){return a.apply(e)})).next((function(){return n.localDocuments.getLocalViewOfDocuments(e,o,s)})).next((function(){return o}))})).then((function(e){return n.Hi=i,e}))}function Ku(e,t,n){var r=cr(),i=cr();return n.forEach((function(e){return r=r.add(e)})),t.getEntries(e,r).next((function(e){var r=er();return n.forEach((function(n,a){var u=e.get(n);a.isFoundDocument()!==u.isFoundDocument()&&(i=i.add(n)),a.isNoDocument()&&a.version.isEqual(te.min())?(t.removeEntry(n,a.readTime),r=r.insert(n,a)):!u.isValidDocument()||a.version.compareTo(u.version)>0||0===a.version.compareTo(u.version)&&u.hasPendingWrites?(t.addEntry(a),r=r.insert(n,a)):D("LocalStore","Ignoring outdated watch update for ",n,". Current version:",u.version," Watch version:",a.version)})),{er:r,nr:i}}))}function zu(e,t){var n=V(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(function(e){return void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)}))}function Gu(e,t){var n=V(e);return n.persistence.runTransaction("Allocate target","readwrite",(function(e){var r;return n.Fs.getTargetData(e,t).next((function(i){return i?(r=i,be.resolve(r)):n.Fs.allocateTargetId(e).next((function(i){return r=new Wi(t,i,"TargetPurposeListen",e.currentSequenceNumber),n.Fs.addTargetData(e,r).next((function(){return r}))}))}))})).then((function(e){var r=n.Hi.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.Hi=n.Hi.insert(e.targetId,e),n.Ji.set(t,e.targetId)),e}))}function Qu(e,t,n){return Wu.apply(this,arguments)}function Wu(){return(Wu=Object(o.a)(y.a.mark((function e(t,n,r){var i,a,u;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=V(t),a=i.Hi.get(n),u=r?"readwrite":"readwrite-primary",e.prev=1,e.t0=r,e.t0){e.next=6;break}return e.next=6,i.persistence.runTransaction("Release target",u,(function(e){return i.persistence.referenceDelegate.removeTarget(e,a)}));case 6:e.next=13;break;case 8:if(e.prev=8,e.t1=e.catch(1),Ee(e.t1)){e.next=12;break}throw e.t1;case 12:D("LocalStore","Failed to update sequence numbers for target ".concat(n,": ").concat(e.t1));case 13:i.Hi=i.Hi.remove(n),i.Ji.delete(a.target);case 14:case"end":return e.stop()}}),e,null,[[1,8]])})))).apply(this,arguments)}function Hu(e,t,n){var r=V(e),i=te.min(),a=cr();return r.persistence.runTransaction("Execute query","readonly",(function(e){return function(e,t,n){var r=V(e),i=r.Ji.get(n);return void 0!==i?be.resolve(r.Hi.get(i)):r.Fs.getTargetData(t,n)}(r,e,Bn(t)).next((function(t){if(t)return i=t.lastLimboFreeSnapshotVersion,r.Fs.getMatchingKeysForTargetId(e,t.targetId).next((function(e){a=e}))})).next((function(){return r.Wi.getDocumentsMatchingQuery(e,t,n?i:te.min(),n?a:cr())})).next((function(e){return Ju(r,Xn(t),e),{documents:e,sr:a}}))}))}function Xu(e,t){var n=V(e),r=V(n.Fs),i=n.Hi.get(t);return i?Promise.resolve(i.target):n.persistence.runTransaction("Get target data","readonly",(function(e){return r.he(e,t).next((function(e){return e?e.target:null}))}))}function Yu(e,t){var n=V(e),r=n.Yi.get(t)||te.min();return n.persistence.runTransaction("Get new document changes","readonly",(function(e){return n.Xi.getAllFromCollectionGroup(e,t,he(r,-1),Number.MAX_SAFE_INTEGER)})).then((function(e){return Ju(n,t,e),e}))}function Ju(e,t,n){var r=e.Yi.get(t)||te.min();n.forEach((function(e,t){t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.Yi.set(t,r)}function $u(e,t,n,r){return Zu.apply(this,arguments)}function Zu(){return(Zu=Object(o.a)(y.a.mark((function e(t,n,r,i){var a,u,o,s,c,l,f,h,d,v;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=V(t),u=cr(),o=er(),s=w(r);try{for(s.s();!(c=s.n()).done;)l=c.value,f=n.ir(l.metadata.name),l.document&&(u=u.add(f)),(h=n.rr(l)).setReadTime(n.ur(l.metadata.readTime)),o=o.insert(f,h)}catch(y){s.e(y)}finally{s.f()}return d=a.Xi.newChangeBuffer({trackRemovals:!0}),e.next=7,Gu(a,function(e){return Bn(Mn(re.fromString("__bundle__/docs/".concat(e))))}(i));case 7:return v=e.sent,e.abrupt("return",a.persistence.runTransaction("Apply bundle documents","readwrite",(function(e){return Ku(e,d,o).next((function(t){return d.apply(e),t})).next((function(t){return a.Fs.removeMatchingKeysForTargetId(e,v.targetId).next((function(){return a.Fs.addMatchingKeys(e,u,v.targetId)})).next((function(){return a.localDocuments.getLocalViewOfDocuments(e,t.er,t.nr)})).next((function(){return t.er}))}))})));case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function eo(e,t){return to.apply(this,arguments)}function to(){return(to=Object(o.a)(y.a.mark((function e(t,n){var r,i,a,u=arguments;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=u.length>2&&void 0!==u[2]?u[2]:cr(),e.next=3,Gu(t,Bn(na(n.bundledQuery)));case 3:return i=e.sent,a=V(t),e.abrupt("return",a.persistence.runTransaction("Save named query","readwrite",(function(e){var t=Ii(n.readTime);if(i.snapshotVersion.compareTo(t)>=0)return a.Ls.saveNamedQuery(e,n);var u=i.withResumeToken(It.EMPTY_BYTE_STRING,t);return a.Hi=a.Hi.insert(u.targetId,u),a.Fs.updateTargetData(e,u).next((function(){return a.Fs.removeMatchingKeysForTargetId(e,i.targetId)})).next((function(){return a.Fs.addMatchingKeys(e,r,i.targetId)})).next((function(){return a.Ls.saveNamedQuery(e,n)}))})));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function no(e,t){return"firestore_clients_".concat(e,"_").concat(t)}function ro(e,t,n){var r="firestore_mutations_".concat(e,"_").concat(n);return t.isAuthenticated()&&(r+="_".concat(t.uid)),r}function io(e,t){return"firestore_targets_".concat(e,"_").concat(t)}var ao=function(){function e(t,n,r,i){Object(h.a)(this,e),this.user=t,this.batchId=n,this.state=r,this.error=i}return Object(d.a)(e,[{key:"ar",value:function(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}],[{key:"cr",value:function(t,n,r){var i,a=JSON.parse(r),u="object"==typeof a&&-1!==["pending","acknowledged","rejected"].indexOf(a.state)&&(void 0===a.error||"object"==typeof a.error);return u&&a.error&&((u="string"==typeof a.error.message&&"string"==typeof a.error.code)&&(i=new P(a.error.code,a.error.message))),u?new e(t,n,a.state,i):(A("SharedClientState","Failed to parse mutation state for ID '".concat(n,"': ").concat(r)),null)}}]),e}(),uo=function(){function e(t,n,r){Object(h.a)(this,e),this.targetId=t,this.state=n,this.error=r}return Object(d.a)(e,[{key:"ar",value:function(){var e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}],[{key:"cr",value:function(t,n){var r,i=JSON.parse(n),a="object"==typeof i&&-1!==["not-current","current","rejected"].indexOf(i.state)&&(void 0===i.error||"object"==typeof i.error);return a&&i.error&&((a="string"==typeof i.error.message&&"string"==typeof i.error.code)&&(r=new P(i.error.code,i.error.message))),a?new e(t,i.state,r):(A("SharedClientState","Failed to parse target state for ID '".concat(t,"': ").concat(n)),null)}}]),e}(),oo=function(){function e(t,n){Object(h.a)(this,e),this.clientId=t,this.activeTargetIds=n}return Object(d.a)(e,null,[{key:"cr",value:function(t,n){for(var r=JSON.parse(n),i="object"==typeof r&&r.activeTargetIds instanceof Array,a=fr(),u=0;i&&u<r.activeTargetIds.length;++u)i=Fe(r.activeTargetIds[u]),a=a.add(r.activeTargetIds[u]);return i?new e(t,a):(A("SharedClientState","Failed to parse client data for instance '".concat(t,"': ").concat(n)),null)}}]),e}(),so=function(){function e(t,n){Object(h.a)(this,e),this.clientId=t,this.onlineState=n}return Object(d.a)(e,null,[{key:"cr",value:function(t){var n=JSON.parse(t);return"object"==typeof n&&-1!==["Unknown","Online","Offline"].indexOf(n.onlineState)&&"string"==typeof n.clientId?new e(n.clientId,n.onlineState):(A("SharedClientState","Failed to parse online state: ".concat(t)),null)}}]),e}(),co=function(){function e(){Object(h.a)(this,e),this.activeTargetIds=fr()}return Object(d.a)(e,[{key:"hr",value:function(e){this.activeTargetIds=this.activeTargetIds.add(e)}},{key:"lr",value:function(e){this.activeTargetIds=this.activeTargetIds.delete(e)}},{key:"ar",value:function(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}]),e}(),lo=function(){function e(t,n,r,i,a){Object(h.a)(this,e),this.window=t,this.si=n,this.persistenceKey=r,this.dr=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this._r=this.wr.bind(this),this.mr=new vt(J),this.started=!1,this.gr=[];var u=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=a,this.yr=no(this.persistenceKey,this.dr),this.pr=function(e){return"firestore_sequence_number_".concat(e)}(this.persistenceKey),this.mr=this.mr.insert(this.dr,new co),this.Ir=new RegExp("^firestore_clients_".concat(u,"_([^_]*)$")),this.Tr=new RegExp("^firestore_mutations_".concat(u,"_(\\d+)(?:_(.*))?$")),this.Er=new RegExp("^firestore_targets_".concat(u,"_(\\d+)$")),this.Ar=function(e){return"firestore_online_state_".concat(e)}(this.persistenceKey),this.Rr=function(e){return"firestore_bundle_loaded_v2_".concat(e)}(this.persistenceKey),this.window.addEventListener("storage",this._r)}var t,n;return Object(d.a)(e,[{key:"start",value:(n=Object(o.a)(y.a.mark((function e(){var t,n,r,i,a,u,o,s,c,l,f,h=this;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.syncEngine.Mi();case 2:t=e.sent,n=w(t),e.prev=4,n.s();case 6:if((r=n.n()).done){e.next=14;break}if((i=r.value)!==this.dr){e.next=10;break}return e.abrupt("continue",12);case 10:(a=this.getItem(no(this.persistenceKey,i)))&&(u=oo.cr(i,a))&&(this.mr=this.mr.insert(u.clientId,u));case 12:e.next=6;break;case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(4),n.e(e.t0);case 19:return e.prev=19,n.f(),e.finish(19);case 22:this.vr(),(o=this.storage.getItem(this.Ar))&&(s=this.Pr(o))&&this.br(s),c=w(this.gr);try{for(c.s();!(l=c.n()).done;)f=l.value,this.wr(f)}catch(d){c.e(d)}finally{c.f()}this.gr=[],this.window.addEventListener("pagehide",(function(){return h.shutdown()})),this.started=!0;case 28:case"end":return e.stop()}}),e,this,[[4,16,19,22]])}))),function(){return n.apply(this,arguments)})},{key:"writeSequenceNumber",value:function(e){this.setItem(this.pr,JSON.stringify(e))}},{key:"getAllActiveQueryTargets",value:function(){return this.Vr(this.mr)}},{key:"isActiveQueryTarget",value:function(e){var t=!1;return this.mr.forEach((function(n,r){r.activeTargetIds.has(e)&&(t=!0)})),t}},{key:"addPendingMutation",value:function(e){this.Sr(e,"pending")}},{key:"updateMutationState",value:function(e,t,n){this.Sr(e,t,n),this.Dr(e)}},{key:"addLocalQueryTarget",value:function(e){var t="not-current";if(this.isActiveQueryTarget(e)){var n=this.storage.getItem(io(this.persistenceKey,e));if(n){var r=uo.cr(e,n);r&&(t=r.state)}}return this.Cr.hr(e),this.vr(),t}},{key:"removeLocalQueryTarget",value:function(e){this.Cr.lr(e),this.vr()}},{key:"isLocalQueryTarget",value:function(e){return this.Cr.activeTargetIds.has(e)}},{key:"clearQueryState",value:function(e){this.removeItem(io(this.persistenceKey,e))}},{key:"updateQueryState",value:function(e,t,n){this.Nr(e,t,n)}},{key:"handleUserChange",value:function(e,t,n){var r=this;t.forEach((function(e){r.Dr(e)})),this.currentUser=e,n.forEach((function(e){r.addPendingMutation(e)}))}},{key:"setOnlineState",value:function(e){this.kr(e)}},{key:"notifyBundleLoaded",value:function(e){this.Mr(e)}},{key:"shutdown",value:function(){this.started&&(this.window.removeEventListener("storage",this._r),this.removeItem(this.yr),this.started=!1)}},{key:"getItem",value:function(e){var t=this.storage.getItem(e);return D("SharedClientState","READ",e,t),t}},{key:"setItem",value:function(e,t){D("SharedClientState","SET",e,t),this.storage.setItem(e,t)}},{key:"removeItem",value:function(e){D("SharedClientState","REMOVE",e),this.storage.removeItem(e)}},{key:"wr",value:function(e){var t=this,n=e;if(n.storageArea===this.storage){if(D("SharedClientState","EVENT",n.key,n.newValue),n.key===this.yr)return void A("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.si.enqueueRetryable(Object(o.a)(y.a.mark((function e(){var r,i,a,u,o,s,c;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.started){e.next=43;break}if(null===n.key){e.next=41;break}if(!t.Ir.test(n.key)){e.next=11;break}if(null!=n.newValue){e.next=6;break}return r=t.Or(n.key),e.abrupt("return",t.$r(r,null));case 6:if(!(i=t.Fr(n.key,n.newValue))){e.next=9;break}return e.abrupt("return",t.$r(i.clientId,i));case 9:e.next=41;break;case 11:if(!t.Tr.test(n.key)){e.next=18;break}if(null===n.newValue){e.next=16;break}if(!(a=t.Br(n.key,n.newValue))){e.next=16;break}return e.abrupt("return",t.Lr(a));case 16:e.next=41;break;case 18:if(!t.Er.test(n.key)){e.next=25;break}if(null===n.newValue){e.next=23;break}if(!(u=t.qr(n.key,n.newValue))){e.next=23;break}return e.abrupt("return",t.Ur(u));case 23:e.next=41;break;case 25:if(n.key!==t.Ar){e.next=32;break}if(null===n.newValue){e.next=30;break}if(!(o=t.Pr(n.newValue))){e.next=30;break}return e.abrupt("return",t.br(o));case 30:e.next=41;break;case 32:if(n.key!==t.pr){e.next=37;break}(s=function(e){var t=Ce.ct;if(null!=e)try{var n=JSON.parse(e);F("number"==typeof n),t=n}catch(e){A("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(n.newValue))!==Ce.ct&&t.sequenceNumberHandler(s),e.next=41;break;case 37:if(n.key!==t.Rr){e.next=41;break}return c=t.Kr(n.newValue),e.next=41,Promise.all(c.map((function(e){return t.syncEngine.Gr(e)})));case 41:e.next=44;break;case 43:t.gr.push(n);case 44:case"end":return e.stop()}}),e)}))))}}},{key:"Cr",get:function(){return this.mr.get(this.dr)}},{key:"vr",value:function(){this.setItem(this.yr,this.Cr.ar())}},{key:"Sr",value:function(e,t,n){var r=new ao(this.currentUser,e,t,n),i=ro(this.persistenceKey,this.currentUser,e);this.setItem(i,r.ar())}},{key:"Dr",value:function(e){var t=ro(this.persistenceKey,this.currentUser,e);this.removeItem(t)}},{key:"kr",value:function(e){var t={clientId:this.dr,onlineState:e};this.storage.setItem(this.Ar,JSON.stringify(t))}},{key:"Nr",value:function(e,t,n){var r=io(this.persistenceKey,e),i=new uo(e,t,n);this.setItem(r,i.ar())}},{key:"Mr",value:function(e){var t=JSON.stringify(Array.from(e));this.setItem(this.Rr,t)}},{key:"Or",value:function(e){var t=this.Ir.exec(e);return t?t[1]:null}},{key:"Fr",value:function(e,t){var n=this.Or(e);return oo.cr(n,t)}},{key:"Br",value:function(e,t){var n=this.Tr.exec(e),r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return ao.cr(new E(i),r,t)}},{key:"qr",value:function(e,t){var n=this.Er.exec(e),r=Number(n[1]);return uo.cr(r,t)}},{key:"Pr",value:function(e){return so.cr(e)}},{key:"Kr",value:function(e){return JSON.parse(e)}},{key:"Lr",value:(t=Object(o.a)(y.a.mark((function e(t){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.user.uid!==this.currentUser.uid){e.next=2;break}return e.abrupt("return",this.syncEngine.Qr(t.batchId,t.state,t.error));case 2:D("SharedClientState","Ignoring mutation for non-active user ".concat(t.user.uid));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"Ur",value:function(e){return this.syncEngine.jr(e.targetId,e.state,e.error)}},{key:"$r",value:function(e,t){var n=this,r=t?this.mr.insert(e,t):this.mr.remove(e),i=this.Vr(this.mr),a=this.Vr(r),u=[],o=[];return a.forEach((function(e){i.has(e)||u.push(e)})),i.forEach((function(e){a.has(e)||o.push(e)})),this.syncEngine.zr(u,o).then((function(){n.mr=r}))}},{key:"br",value:function(e){this.mr.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}},{key:"Vr",value:function(e){var t=fr();return e.forEach((function(e,n){t=t.unionWith(n.activeTargetIds)})),t}}],[{key:"D",value:function(e){return!(!e||!e.localStorage)}}]),e}(),fo=function(){function e(){Object(h.a)(this,e),this.Wr=new co,this.Hr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}return Object(d.a)(e,[{key:"addPendingMutation",value:function(e){}},{key:"updateMutationState",value:function(e,t,n){}},{key:"addLocalQueryTarget",value:function(e){return this.Wr.hr(e),this.Hr[e]||"not-current"}},{key:"updateQueryState",value:function(e,t,n){this.Hr[e]=t}},{key:"removeLocalQueryTarget",value:function(e){this.Wr.lr(e)}},{key:"isLocalQueryTarget",value:function(e){return this.Wr.activeTargetIds.has(e)}},{key:"clearQueryState",value:function(e){delete this.Hr[e]}},{key:"getAllActiveQueryTargets",value:function(){return this.Wr.activeTargetIds}},{key:"isActiveQueryTarget",value:function(e){return this.Wr.activeTargetIds.has(e)}},{key:"start",value:function(){return this.Wr=new co,Promise.resolve()}},{key:"handleUserChange",value:function(e,t,n){}},{key:"setOnlineState",value:function(e){}},{key:"shutdown",value:function(){}},{key:"writeSequenceNumber",value:function(e){}},{key:"notifyBundleLoaded",value:function(e){}}]),e}(),ho=function(){function e(){Object(h.a)(this,e)}return Object(d.a)(e,[{key:"Jr",value:function(e){}},{key:"shutdown",value:function(){}}]),e}(),vo=function(){function e(){var t=this;Object(h.a)(this,e),this.Yr=function(){return t.Xr()},this.Zr=function(){return t.eo()},this.no=[],this.so()}return Object(d.a)(e,[{key:"Jr",value:function(e){this.no.push(e)}},{key:"shutdown",value:function(){window.removeEventListener("online",this.Yr),window.removeEventListener("offline",this.Zr)}},{key:"so",value:function(){window.addEventListener("online",this.Yr),window.addEventListener("offline",this.Zr)}},{key:"Xr",value:function(){D("ConnectivityMonitor","Network connectivity changed: AVAILABLE");var e,t=w(this.no);try{for(t.s();!(e=t.n()).done;){(0,e.value)(0)}}catch(n){t.e(n)}finally{t.f()}}},{key:"eo",value:function(){D("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");var e,t=w(this.no);try{for(t.s();!(e=t.n()).done;){(0,e.value)(1)}}catch(n){t.e(n)}finally{t.f()}}}],[{key:"D",value:function(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}]),e}(),yo=null;function po(){return null===yo?yo=268435456+Math.round(2147483648*Math.random()):yo++,"0x"+yo.toString(16)}var mo={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"},go=function(){function e(t){Object(h.a)(this,e),this.io=t.io,this.ro=t.ro}return Object(d.a)(e,[{key:"oo",value:function(e){this.uo=e}},{key:"co",value:function(e){this.ao=e}},{key:"onMessage",value:function(e){this.ho=e}},{key:"close",value:function(){this.ro()}},{key:"send",value:function(e){this.io(e)}},{key:"lo",value:function(){this.uo()}},{key:"fo",value:function(e){this.ao(e)}},{key:"_o",value:function(e){this.ho(e)}}]),e}(),ko="WebChannelConnection",bo=function(e){Object(s.a)(n,e);var t=I(n);function n(e){var r;return Object(h.a)(this,n),(r=t.call(this,e)).forceLongPolling=e.forceLongPolling,r.autoDetectLongPolling=e.autoDetectLongPolling,r.useFetchStreams=e.useFetchStreams,r}return Object(d.a)(n,[{key:"Eo",value:function(e,t,n,r){var i=po();return new Promise((function(a,u){var o=new b.i;o.setWithCredentials(!0),o.listenOnce(b.c.COMPLETE,(function(){try{switch(o.getLastErrorCode()){case b.a.NO_ERROR:var t=o.getResponseJson();D(ko,"XHR for RPC '".concat(e,"' ").concat(i," received:"),JSON.stringify(t)),a(t);break;case b.a.TIMEOUT:D(ko,"RPC '".concat(e,"' ").concat(i," timed out")),u(new P(L.DEADLINE_EXCEEDED,"Request time out"));break;case b.a.HTTP_ERROR:var n=o.getStatus();if(D(ko,"RPC '".concat(e,"' ").concat(i," failed with status:"),n,"response text:",o.getResponseText()),n>0){var r=o.getResponseJson();Array.isArray(r)&&(r=r[0]);var s=null==r?void 0:r.error;if(s&&s.status&&s.message){var c=function(e){var t=e.toLowerCase().replace(/_/g,"-");return Object.values(L).indexOf(t)>=0?t:L.UNKNOWN}(s.status);u(new P(c,s.message))}else u(new P(L.UNKNOWN,"Server responded with status "+o.getStatus()))}else u(new P(L.UNAVAILABLE,"Connection failed."));break;default:R()}}finally{D(ko,"RPC '".concat(e,"' ").concat(i," completed."))}}));var s=JSON.stringify(r);D(ko,"RPC '".concat(e,"' ").concat(i," sending request:"),r),o.send(t,"POST",s,n,15)}))}},{key:"Ro",value:function(e,t,n){var r=po(),i=[this.wo,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=Object(b.j)(),u=Object(b.k)(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/".concat(this.databaseId.projectId,"/databases/").concat(this.databaseId.database)},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new b.d({})),this.To(o.initMessageHeaders,t,n),o.encodeInitMessageHeaders=!0;var s=i.join("");D(ko,"Creating RPC '".concat(e,"' stream ").concat(r,": ").concat(s),o);var c=a.createWebChannel(s,o),l=!1,f=!1,h=new go({io:function(t){f?D(ko,"Not sending because RPC '".concat(e,"' stream ").concat(r," is closed:"),t):(l||(D(ko,"Opening RPC '".concat(e,"' stream ").concat(r," transport.")),c.open(),l=!0),D(ko,"RPC '".concat(e,"' stream ").concat(r," sending:"),t),c.send(t))},ro:function(){return c.close()}}),d=function(e,t,n){e.listen(t,(function(e){try{n(e)}catch(e){setTimeout((function(){throw e}),0)}}))};return d(c,b.h.EventType.OPEN,(function(){f||D(ko,"RPC '".concat(e,"' stream ").concat(r," transport opened."))})),d(c,b.h.EventType.CLOSE,(function(){f||(f=!0,D(ko,"RPC '".concat(e,"' stream ").concat(r," transport closed")),h.fo())})),d(c,b.h.EventType.ERROR,(function(t){f||(f=!0,C(ko,"RPC '".concat(e,"' stream ").concat(r," transport errored:"),t),h.fo(new P(L.UNAVAILABLE,"The operation could not be completed")))})),d(c,b.h.EventType.MESSAGE,(function(t){var n;if(!f){var i=t.data[0];F(!!i);var a=i,u=a.error||(null===(n=a[0])||void 0===n?void 0:n.error);if(u){D(ko,"RPC '".concat(e,"' stream ").concat(r," received error:"),u);var o=u.status,s=function(e){var t=Br[e];if(void 0!==t)return Jr(t)}(o),l=u.message;void 0===s&&(s=L.INTERNAL,l="Unknown error status: "+o+" with message "+u.message),f=!0,h.fo(new P(s,l)),c.close()}else D(ko,"RPC '".concat(e,"' stream ").concat(r," received:"),i),h._o(i)}})),d(u,b.b.STAT_EVENT,(function(t){t.stat===b.g.PROXY?D(ko,"RPC '".concat(e,"' stream ").concat(r," detected buffering proxy")):t.stat===b.g.NOPROXY&&D(ko,"RPC '".concat(e,"' stream ").concat(r," detected no buffering proxy"))})),setTimeout((function(){h.lo()}),0),h}}]),n}(function(){function e(t){Object(h.a)(this,e),this.databaseInfo=t,this.databaseId=t.databaseId;var n=t.ssl?"https":"http";this.wo=n+"://"+t.host,this.mo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}return Object(d.a)(e,[{key:"yo",get:function(){return!1}},{key:"po",value:function(e,t,n,r,i){var a=po(),u=this.Io(e,t);D("RestConnection","Sending RPC '".concat(e,"' ").concat(a,":"),u,n);var o={};return this.To(o,r,i),this.Eo(e,u,o,n).then((function(t){return D("RestConnection","Received RPC '".concat(e,"' ").concat(a,": "),t),t}),(function(t){throw C("RestConnection","RPC '".concat(e,"' ").concat(a," failed with error: "),t,"url: ",u,"request:",n),t}))}},{key:"Ao",value:function(e,t,n,r,i,a){return this.po(e,t,n,r,i)}},{key:"To",value:function(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+T,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((function(t,n){return e[n]=t})),n&&n.headers.forEach((function(t,n){return e[n]=t}))}},{key:"Io",value:function(e,t){var n=mo[e];return"".concat(this.wo,"/v1/").concat(t,":").concat(n)}}]),e}());function wo(){return"undefined"!=typeof window?window:null}function xo(){return"undefined"!=typeof document?document:null}function Io(e){return new gi(e,!0)}var Oo=function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1.5,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:6e4;Object(h.a)(this,e),this.si=t,this.timerId=n,this.vo=r,this.Po=i,this.bo=a,this.Vo=0,this.So=null,this.Do=Date.now(),this.reset()}return Object(d.a)(e,[{key:"reset",value:function(){this.Vo=0}},{key:"Co",value:function(){this.Vo=this.bo}},{key:"xo",value:function(e){var t=this;this.cancel();var n=Math.floor(this.Vo+this.No()),r=Math.max(0,Date.now()-this.Do),i=Math.max(0,n-r);i>0&&D("ExponentialBackoff","Backing off for ".concat(i," ms (base delay: ").concat(this.Vo," ms, delay with jitter: ").concat(n," ms, last attempt: ").concat(r," ms ago)")),this.So=this.si.enqueueAfterDelay(this.timerId,i,(function(){return t.Do=Date.now(),e()})),this.Vo*=this.Po,this.Vo<this.vo&&(this.Vo=this.vo),this.Vo>this.bo&&(this.Vo=this.bo)}},{key:"ko",value:function(){null!==this.So&&(this.So.skipDelay(),this.So=null)}},{key:"cancel",value:function(){null!==this.So&&(this.So.cancel(),this.So=null)}},{key:"No",value:function(){return(Math.random()-.5)*this.Vo}}]),e}(),Eo=function(){function e(t,n,r,i,a,u,o,s){Object(h.a)(this,e),this.si=t,this.Mo=r,this.Oo=i,this.connection=a,this.authCredentialsProvider=u,this.appCheckCredentialsProvider=o,this.listener=s,this.state=0,this.$o=0,this.Fo=null,this.Bo=null,this.stream=null,this.Lo=new Oo(t,n)}var t,n,r;return Object(d.a)(e,[{key:"qo",value:function(){return 1===this.state||5===this.state||this.Uo()}},{key:"Uo",value:function(){return 2===this.state||3===this.state}},{key:"start",value:function(){4!==this.state?this.auth():this.Ko()}},{key:"stop",value:(r=Object(o.a)(y.a.mark((function e(){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.qo(),!e.t0){e.next=4;break}return e.next=4,this.close(0);case 4:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"Go",value:function(){this.state=0,this.Lo.reset()}},{key:"Qo",value:function(){var e=this;this.Uo()&&null===this.Fo&&(this.Fo=this.si.enqueueAfterDelay(this.Mo,6e4,(function(){return e.jo()})))}},{key:"zo",value:function(e){this.Wo(),this.stream.send(e)}},{key:"jo",value:(n=Object(o.a)(y.a.mark((function e(){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.Uo()){e.next=2;break}return e.abrupt("return",this.close(0));case 2:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"Wo",value:function(){this.Fo&&(this.Fo.cancel(),this.Fo=null)}},{key:"Ho",value:function(){this.Bo&&(this.Bo.cancel(),this.Bo=null)}},{key:"close",value:(t=Object(o.a)(y.a.mark((function e(t,n){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.Wo(),this.Ho(),this.Lo.cancel(),this.$o++,4!==t?this.Lo.reset():n&&n.code===L.RESOURCE_EXHAUSTED?(A(n.toString()),A("Using maximum backoff delay to prevent overloading the backend."),this.Lo.Co()):n&&n.code===L.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Jo(),this.stream.close(),this.stream=null),this.state=t,e.next=9,this.listener.co(n);case 9:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"Jo",value:function(){}},{key:"auth",value:function(){var e=this;this.state=1;var t=this.Yo(this.$o),n=this.$o;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((function(t){var r=Object(a.a)(t,2),i=r[0],u=r[1];e.$o===n&&e.Xo(i,u)}),(function(n){t((function(){var t=new P(L.UNKNOWN,"Fetching auth token failed: "+n.message);return e.Zo(t)}))}))}},{key:"Xo",value:function(e,t){var n=this,r=this.Yo(this.$o);this.stream=this.tu(e,t),this.stream.oo((function(){r((function(){return n.state=2,n.Bo=n.si.enqueueAfterDelay(n.Oo,1e4,(function(){return n.Uo()&&(n.state=3),Promise.resolve()})),n.listener.oo()}))})),this.stream.co((function(e){r((function(){return n.Zo(e)}))})),this.stream.onMessage((function(e){r((function(){return n.onMessage(e)}))}))}},{key:"Ko",value:function(){var e=this;this.state=5,this.Lo.xo(Object(o.a)(y.a.mark((function t(){return y.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.state=0,e.start();case 1:case"end":return t.stop()}}),t)}))))}},{key:"Zo",value:function(e){return D("PersistentStream","close with error: ".concat(e)),this.stream=null,this.close(4,e)}},{key:"Yo",value:function(e){var t=this;return function(n){t.si.enqueueAndForget((function(){return t.$o===e?n():(D("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())}))}}}]),e}(),To=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r,i,a,u,o){var s;return Object(h.a)(this,n),(s=t.call(this,e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",r,i,a,o)).serializer=u,s}return Object(d.a)(n,[{key:"tu",value:function(e,t){return this.connection.Ro("Listen",e,t)}},{key:"onMessage",value:function(e){this.Lo.reset();var t=function(e,t){var n;if("targetChange"in t){t.targetChange;var r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:R()}(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],a=function(e,t){return e.useProto3Json?(F(void 0===t||"string"==typeof t),It.fromBase64String(t||"")):(F(void 0===t||t instanceof Uint8Array),It.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),u=t.targetChange.cause,o=u&&function(e){var t=void 0===e.code?L.UNKNOWN:Jr(e.code);return new P(t,e.message||"")}(u);n=new li(r,i,a,o||null)}else if("documentChange"in t){t.documentChange;var s=t.documentChange;s.document,s.document.name,s.document.updateTime;var c=Si(e,s.document.name),l=Ii(s.document.updateTime),f=s.document.createTime?Ii(s.document.createTime):te.min(),h=new Zt({mapValue:{fields:s.document.fields}}),d=tn.newFoundDocument(c,l,f,h),v=s.targetIds||[],y=s.removedTargetIds||[];n=new si(v,y,d.key,d)}else if("documentDelete"in t){t.documentDelete;var p=t.documentDelete;p.document;var m=Si(e,p.document),g=p.readTime?Ii(p.readTime):te.min(),k=tn.newNoDocument(m,g),b=p.removedTargetIds||[];n=new si([],b,k.key,k)}else if("documentRemove"in t){t.documentRemove;var w=t.documentRemove;w.document;var x=Si(e,w.document),I=w.removedTargetIds||[];n=new si([],I,x,null)}else{if(!("filter"in t))return R();t.filter;var O=t.filter;O.targetId;var E=O.count,T=void 0===E?0:E,S=O.unchangedNames,_=new Xr(T,S),j=O.targetId;n=new ci(j,_)}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return te.min();var t=e.targetChange;return t.targetIds&&t.targetIds.length?te.min():t.readTime?Ii(t.readTime):te.min()}(e);return this.listener.eu(t,n)}},{key:"nu",value:function(e){var t={};t.database=Di(this.serializer),t.addTarget=function(e,t){var n,r=t.target;if((n=Dn(r)?{documents:Vi(e,r)}:{query:Li(e,r)}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=wi(e,t.resumeToken);var i=ki(e,t.expectedCount);null!==i&&(n.expectedCount=i)}else if(t.snapshotVersion.compareTo(te.min())>0){n.readTime=bi(e,t.snapshotVersion.toTimestamp());var a=ki(e,t.expectedCount);null!==a&&(n.expectedCount=a)}return n}(this.serializer,e);var n=function(e,t){var n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return R()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.zo(t)}},{key:"su",value:function(e){var t={};t.database=Di(this.serializer),t.removeTarget=e,this.zo(t)}}]),n}(Eo),So=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r,i,a,u,o){var s;return Object(h.a)(this,n),(s=t.call(this,e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",r,i,a,o)).serializer=u,s.iu=!1,s}return Object(d.a)(n,[{key:"ru",get:function(){return this.iu}},{key:"start",value:function(){this.iu=!1,this.lastStreamToken=void 0,Object(i.a)(Object(l.a)(n.prototype),"start",this).call(this)}},{key:"Jo",value:function(){this.iu&&this.ou([])}},{key:"tu",value:function(e,t){return this.connection.Ro("Write",e,t)}},{key:"onMessage",value:function(e){if(F(!!e.streamToken),this.lastStreamToken=e.streamToken,this.iu){this.Lo.reset();var t=function(e,t){return e&&e.length>0?(F(void 0!==t),e.map((function(e){return function(e,t){var n=e.updateTime?Ii(e.updateTime):Ii(t);return n.isEqual(te.min())&&(n=Ii(t)),new _r(n,e.transformResults||[])}(e,t)}))):[]}(e.writeResults,e.commitTime),n=Ii(e.commitTime);return this.listener.uu(n,t)}return F(!e.writeResults||0===e.writeResults.length),this.iu=!0,this.listener.cu()}},{key:"au",value:function(){var e={};e.database=Di(this.serializer),this.zo(e)}},{key:"ou",value:function(e){var t=this,n={streamToken:this.lastStreamToken,writes:e.map((function(e){return Fi(t.serializer,e)}))};this.zo(n)}}]),n}(Eo),_o=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r,i,a){var u;return Object(h.a)(this,n),(u=t.call(this)).authCredentials=e,u.appCheckCredentials=r,u.connection=i,u.serializer=a,u.hu=!1,u}return Object(d.a)(n,[{key:"lu",value:function(){if(this.hu)throw new P(L.FAILED_PRECONDITION,"The client has already been terminated.")}},{key:"po",value:function(e,t,n){var r=this;return this.lu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((function(i){var u=Object(a.a)(i,2),o=u[0],s=u[1];return r.connection.po(e,t,n,o,s)})).catch((function(e){throw"FirebaseError"===e.name?(e.code===L.UNAUTHENTICATED&&(r.authCredentials.invalidateToken(),r.appCheckCredentials.invalidateToken()),e):new P(L.UNKNOWN,e.toString())}))}},{key:"Ao",value:function(e,t,n,r){var i=this;return this.lu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((function(u){var o=Object(a.a)(u,2),s=o[0],c=o[1];return i.connection.Ao(e,t,n,s,c,r)})).catch((function(e){throw"FirebaseError"===e.name?(e.code===L.UNAUTHENTICATED&&(i.authCredentials.invalidateToken(),i.appCheckCredentials.invalidateToken()),e):new P(L.UNKNOWN,e.toString())}))}},{key:"terminate",value:function(){this.hu=!0}}]),n}(function(){return function e(){Object(h.a)(this,e)}}());var jo=function(){function e(t,n){Object(h.a)(this,e),this.asyncQueue=t,this.onlineStateHandler=n,this.state="Unknown",this.du=0,this._u=null,this.wu=!0}return Object(d.a)(e,[{key:"mu",value:function(){var e=this;0===this.du&&(this.gu("Unknown"),this._u=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(function(){return e._u=null,e.yu("Backend didn't respond within 10 seconds."),e.gu("Offline"),Promise.resolve()})))}},{key:"pu",value:function(e){"Online"===this.state?this.gu("Unknown"):(this.du++,this.du>=1&&(this.Iu(),this.yu("Connection failed 1 times. Most recent error: ".concat(e.toString())),this.gu("Offline")))}},{key:"set",value:function(e){this.Iu(),this.du=0,"Online"===e&&(this.wu=!1),this.gu(e)}},{key:"gu",value:function(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}},{key:"yu",value:function(e){var t="Could not reach Cloud Firestore backend. ".concat(e,"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.");this.wu?(A(t),this.wu=!1):D("OnlineStateTracker",t)}},{key:"Iu",value:function(){null!==this._u&&(this._u.cancel(),this._u=null)}}]),e}(),Do=function e(t,n,r,i,a){var u=this;Object(h.a)(this,e),this.localStore=t,this.datastore=n,this.asyncQueue=r,this.remoteSyncer={},this.Tu=[],this.Eu=new Map,this.Au=new Set,this.Ru=[],this.vu=a,this.vu.Jr((function(e){r.enqueueAndForget(Object(o.a)(y.a.mark((function e(){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=Uo(u),!e.t0){e.next=5;break}return D("RemoteStore","Restarting streams for network reachability change."),e.next=5,function(){var e=Object(o.a)(y.a.mark((function e(t){var n;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=V(t)).Au.add(4),e.next=4,No(n);case 4:return n.Pu.set("Unknown"),n.Au.delete(4),e.next=8,Ao(n);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()(u);case 5:case"end":return e.stop()}}),e)}))))})),this.Pu=new jo(r,i)};function Ao(e){return Co.apply(this,arguments)}function Co(){return(Co=Object(o.a)(y.a.mark((function e(t){var n,r,i;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Uo(t)){e.next=18;break}n=w(t.Ru),e.prev=2,n.s();case 4:if((r=n.n()).done){e.next=10;break}return i=r.value,e.next=8,i(!0);case 8:e.next=4;break;case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),n.e(e.t0);case 15:return e.prev=15,n.f(),e.finish(15);case 18:case"end":return e.stop()}}),e,null,[[2,12,15,18]])})))).apply(this,arguments)}function No(e){return Ro.apply(this,arguments)}function Ro(){return(Ro=Object(o.a)(y.a.mark((function e(t){var n,r,i;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=w(t.Ru),e.prev=1,n.s();case 3:if((r=n.n()).done){e.next=9;break}return i=r.value,e.next=7,i(!1);case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),n.e(e.t0);case 14:return e.prev=14,n.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,null,[[1,11,14,17]])})))).apply(this,arguments)}function Fo(e,t){var n=V(e);n.Eu.has(t.targetId)||(n.Eu.set(t.targetId,t),qo(n)?Po(n):ps(n).Uo()&&Vo(n,t))}function Mo(e,t){var n=V(e),r=ps(n);n.Eu.delete(t),r.Uo()&&Lo(n,t),0===n.Eu.size&&(r.Uo()?r.Qo():Uo(n)&&n.Pu.set("Unknown"))}function Vo(e,t){if(e.bu.Lt(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(te.min())>0){var n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}ps(e).nu(t)}function Lo(e,t){e.bu.Lt(t),ps(e).su(t)}function Po(e){e.bu=new hi({getRemoteKeysForTarget:function(t){return e.remoteSyncer.getRemoteKeysForTarget(t)},he:function(t){return e.Eu.get(t)||null},oe:function(){return e.datastore.serializer.databaseId}}),ps(e).start(),e.Pu.mu()}function qo(e){return Uo(e)&&!ps(e).qo()&&e.Eu.size>0}function Uo(e){return 0===V(e).Au.size}function Bo(e){e.bu=void 0}function Ko(e){return zo.apply(this,arguments)}function zo(){return(zo=Object(o.a)(y.a.mark((function e(t){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.Eu.forEach((function(e,n){Vo(t,e)}));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Go(e,t){return Qo.apply(this,arguments)}function Qo(){return(Qo=Object(o.a)(y.a.mark((function e(t,n){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Bo(t),qo(t)?(t.Pu.pu(n),Po(t)):t.Pu.set("Unknown");case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Wo(e,t,n){return Ho.apply(this,arguments)}function Ho(){return(Ho=Object(o.a)(y.a.mark((function e(t,n,r){var i;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.Pu.set("Online"),!(n instanceof li&&2===n.state&&n.cause)){e.next=13;break}return e.prev=1,e.next=4,function(){var e=Object(o.a)(y.a.mark((function e(t,n){var r,i,a,u;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=n.cause,i=w(n.targetIds),e.prev=2,i.s();case 4:if((a=i.n()).done){e.next=14;break}if(u=a.value,e.t0=t.Eu.has(u),!e.t0){e.next=12;break}return e.next=10,t.remoteSyncer.rejectListen(u,r);case 10:t.Eu.delete(u),t.bu.removeTarget(u);case 12:e.next=4;break;case 14:e.next=19;break;case 16:e.prev=16,e.t1=e.catch(2),i.e(e.t1);case 19:return e.prev=19,i.f(),e.finish(19);case 22:case"end":return e.stop()}}),e,null,[[2,16,19,22]])})));return function(t,n){return e.apply(this,arguments)}}()(t,n);case 4:e.next=11;break;case 6:return e.prev=6,e.t0=e.catch(1),D("RemoteStore","Failed to remove targets %s: %s ",n.targetIds.join(","),e.t0),e.next=11,Xo(t,e.t0);case 11:e.next=29;break;case 13:if(n instanceof si?t.bu.Wt(n):n instanceof ci?t.bu.ee(n):t.bu.Yt(n),r.isEqual(te.min())){e.next=29;break}return e.prev=14,e.next=17,Uu(t.localStore);case 17:if(i=e.sent,e.t1=r.compareTo(i)>=0,!e.t1){e.next=22;break}return e.next=22,function(e,t){var n=e.bu.ue(t);return n.targetChanges.forEach((function(n,r){if(n.resumeToken.approximateByteSize()>0){var i=e.Eu.get(r);i&&e.Eu.set(r,i.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach((function(t,n){var r=e.Eu.get(t);if(r){e.Eu.set(t,r.withResumeToken(It.EMPTY_BYTE_STRING,r.snapshotVersion)),Lo(e,t);var i=new Wi(r.target,t,n,r.sequenceNumber);Vo(e,i)}})),e.remoteSyncer.applyRemoteEvent(n)}(t,r);case 22:e.next=29;break;case 24:return e.prev=24,e.t2=e.catch(14),D("RemoteStore","Failed to raise snapshot:",e.t2),e.next=29,Xo(t,e.t2);case 29:case"end":return e.stop()}}),e,null,[[1,6],[14,24]])})))).apply(this,arguments)}function Xo(e,t,n){return Yo.apply(this,arguments)}function Yo(){return(Yo=Object(o.a)(y.a.mark((function e(t,n,r){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Ee(n)){e.next=2;break}throw n;case 2:return t.Au.add(1),e.next=5,No(t);case 5:t.Pu.set("Offline"),r||(r=function(){return Uu(t.localStore)}),t.asyncQueue.enqueueRetryable(Object(o.a)(y.a.mark((function e(){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return D("RemoteStore","Retrying IndexedDB access"),e.next=3,r();case 3:return t.Au.delete(1),e.next=6,Ao(t);case 6:case"end":return e.stop()}}),e)}))));case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Jo(e,t){return t().catch((function(n){return Xo(e,n,t)}))}function $o(e){return Zo.apply(this,arguments)}function Zo(){return(Zo=Object(o.a)(y.a.mark((function e(t){var n,r,i,a;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=V(t),r=ms(n),i=n.Tu.length>0?n.Tu[n.Tu.length-1].batchId:-1;case 2:if(!es(n)){e.next=19;break}return e.prev=3,e.next=6,zu(n.localStore,i);case 6:if(null!==(a=e.sent)){e.next=10;break}return 0===n.Tu.length&&r.Qo(),e.abrupt("break",19);case 10:i=a.batchId,ts(n,a),e.next=17;break;case 13:return e.prev=13,e.t0=e.catch(3),e.next=17,Xo(n,e.t0);case 17:e.next=2;break;case 19:ns(n)&&rs(n);case 20:case"end":return e.stop()}}),e,null,[[3,13]])})))).apply(this,arguments)}function es(e){return Uo(e)&&e.Tu.length<10}function ts(e,t){e.Tu.push(t);var n=ms(e);n.Uo()&&n.ru&&n.ou(t.mutations)}function ns(e){return Uo(e)&&!ms(e).qo()&&e.Tu.length>0}function rs(e){ms(e).start()}function is(e){return as.apply(this,arguments)}function as(){return(as=Object(o.a)(y.a.mark((function e(t){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:ms(t).au();case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function us(e){return os.apply(this,arguments)}function os(){return(os=Object(o.a)(y.a.mark((function e(t){var n,r,i,a;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=ms(t),r=w(t.Tu);try{for(r.s();!(i=r.n()).done;)a=i.value,n.ou(a.mutations)}catch(u){r.e(u)}finally{r.f()}case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ss(e,t,n){return cs.apply(this,arguments)}function cs(){return(cs=Object(o.a)(y.a.mark((function e(t,n,r){var i,a;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.Tu.shift(),a=Wr.from(i,n,r),e.next=3,Jo(t,(function(){return t.remoteSyncer.applySuccessfulWrite(a)}));case 3:return e.next=5,$o(t);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ls(e,t){return fs.apply(this,arguments)}function fs(){return(fs=Object(o.a)(y.a.mark((function e(t,n){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=n&&ms(t).ru,!e.t0){e.next=4;break}return e.next=4,function(){var e=Object(o.a)(y.a.mark((function e(t,n){var r,i;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Yr(i=n.code)||i===L.ABORTED){e.next=7;break}return r=t.Tu.shift(),ms(t).Go(),e.next=5,Jo(t,(function(){return t.remoteSyncer.rejectFailedWrite(r.batchId,n)}));case 5:return e.next=7,$o(t);case 7:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()(t,n);case 4:ns(t)&&rs(t);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function hs(e,t){return ds.apply(this,arguments)}function ds(){return(ds=Object(o.a)(y.a.mark((function e(t,n){var r,i;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=V(t)).asyncQueue.verifyOperationInProgress(),D("RemoteStore","RemoteStore received new credentials"),i=Uo(r),r.Au.add(3),e.next=6,No(r);case 6:return i&&r.Pu.set("Unknown"),e.next=9,r.remoteSyncer.handleCredentialChange(n);case 9:return r.Au.delete(3),e.next=12,Ao(r);case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function vs(e,t){return ys.apply(this,arguments)}function ys(){return(ys=Object(o.a)(y.a.mark((function e(t,n){var r;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=V(t),!n){e.next=7;break}return r.Au.delete(2),e.next=5,Ao(r);case 5:e.next=13;break;case 7:if(e.t0=n,e.t0){e.next=13;break}return r.Au.add(2),e.next=12,No(r);case 12:r.Pu.set("Unknown");case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ps(e){return e.Vu||(e.Vu=function(e,t,n){var r=V(e);return r.lu(),new To(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{oo:Ko.bind(null,e),co:Go.bind(null,e),eu:Wo.bind(null,e)}),e.Ru.push(function(){var t=Object(o.a)(y.a.mark((function t(n){return y.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!n){t.next=4;break}e.Vu.Go(),qo(e)?Po(e):e.Pu.set("Unknown"),t.next=7;break;case 4:return t.next=6,e.Vu.stop();case 6:Bo(e);case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())),e.Vu}function ms(e){return e.Su||(e.Su=function(e,t,n){var r=V(e);return r.lu(),new So(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{oo:is.bind(null,e),co:ls.bind(null,e),cu:us.bind(null,e),uu:ss.bind(null,e)}),e.Ru.push(function(){var t=Object(o.a)(y.a.mark((function t(n){return y.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!n){t.next=6;break}return e.Su.Go(),t.next=4,$o(e);case 4:t.next=9;break;case 6:return t.next=8,e.Su.stop();case 8:e.Tu.length>0&&(D("RemoteStore","Stopping write stream with ".concat(e.Tu.length," pending writes")),e.Tu=[]);case 9:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())),e.Su}var gs=function(){function e(t,n,r,i,a){Object(h.a)(this,e),this.asyncQueue=t,this.timerId=n,this.targetTimeMs=r,this.op=i,this.removalCallback=a,this.deferred=new q,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((function(e){}))}return Object(d.a)(e,[{key:"start",value:function(e){var t=this;this.timerHandle=setTimeout((function(){return t.handleDelayElapsed()}),e)}},{key:"skipDelay",value:function(){return this.handleDelayElapsed()}},{key:"cancel",value:function(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new P(L.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}},{key:"handleDelayElapsed",value:function(){var e=this;this.asyncQueue.enqueueAndForget((function(){return null!==e.timerHandle?(e.clearTimeout(),e.op().then((function(t){return e.deferred.resolve(t)}))):Promise.resolve()}))}},{key:"clearTimeout",value:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}))}],[{key:"createAndSchedule",value:function(t,n,r,i,a){var u=new e(t,n,Date.now()+r,i,a);return u.start(r),u}}]),e}();function ks(e,t){if(A("AsyncQueue","".concat(t,": ").concat(e)),Ee(e))return new P(L.UNAVAILABLE,"".concat(t,": ").concat(e));throw e}var bs=function(){function e(t){Object(h.a)(this,e),this.comparator=t?function(e,n){return t(e,n)||ue.comparator(e.key,n.key)}:function(e,t){return ue.comparator(e.key,t.key)},this.keyedMap=nr(),this.sortedSet=new vt(this.comparator)}return Object(d.a)(e,[{key:"has",value:function(e){return null!=this.keyedMap.get(e)}},{key:"get",value:function(e){return this.keyedMap.get(e)}},{key:"first",value:function(){return this.sortedSet.minKey()}},{key:"last",value:function(){return this.sortedSet.maxKey()}},{key:"isEmpty",value:function(){return this.sortedSet.isEmpty()}},{key:"indexOf",value:function(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}},{key:"size",get:function(){return this.sortedSet.size}},{key:"forEach",value:function(e){this.sortedSet.inorderTraversal((function(t,n){return e(t),!1}))}},{key:"add",value:function(e){var t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}},{key:"delete",value:function(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}},{key:"isEqual",value:function(t){if(!(t instanceof e))return!1;if(this.size!==t.size)return!1;for(var n=this.sortedSet.getIterator(),r=t.sortedSet.getIterator();n.hasNext();){var i=n.getNext().key,a=r.getNext().key;if(!i.isEqual(a))return!1}return!0}},{key:"toString",value:function(){var e=[];return this.forEach((function(t){e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}},{key:"copy",value:function(t,n){var r=new e;return r.comparator=this.comparator,r.keyedMap=t,r.sortedSet=n,r}}],[{key:"emptySet",value:function(t){return new e(t.comparator)}}]),e}(),ws=function(){function e(){Object(h.a)(this,e),this.Du=new vt(ue.comparator)}return Object(d.a)(e,[{key:"track",value:function(e){var t=e.doc.key,n=this.Du.get(t);n?0!==e.type&&3===n.type?this.Du=this.Du.insert(t,e):3===e.type&&1!==n.type?this.Du=this.Du.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Du=this.Du.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Du=this.Du.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Du=this.Du.remove(t):1===e.type&&2===n.type?this.Du=this.Du.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Du=this.Du.insert(t,{type:2,doc:e.doc}):R():this.Du=this.Du.insert(t,e)}},{key:"Cu",value:function(){var e=[];return this.Du.inorderTraversal((function(t,n){e.push(n)})),e}}]),e}(),xs=function(){function e(t,n,r,i,a,u,o,s,c){Object(h.a)(this,e),this.query=t,this.docs=n,this.oldDocs=r,this.docChanges=i,this.mutatedKeys=a,this.fromCache=u,this.syncStateChanged=o,this.excludesMetadataChanges=s,this.hasCachedResults=c}return Object(d.a)(e,[{key:"hasPendingWrites",get:function(){return!this.mutatedKeys.isEmpty()}},{key:"isEqual",value:function(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Gn(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;var t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(var r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}],[{key:"fromInitialDocuments",value:function(t,n,r,i,a){var u=[];return n.forEach((function(e){u.push({type:0,doc:e})})),new e(t,n,bs.emptySet(n),u,r,i,!0,!1,a)}}]),e}(),Is=function e(){Object(h.a)(this,e),this.xu=void 0,this.listeners=[]},Os=function e(){Object(h.a)(this,e),this.queries=new $n((function(e){return Qn(e)}),Gn),this.onlineState="Unknown",this.Nu=new Set};function Es(e,t){return Ts.apply(this,arguments)}function Ts(){return(Ts=Object(o.a)(y.a.mark((function e(t,n){var r,i,a,u,o;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=V(t),i=n.query,a=!1,(u=r.queries.get(i))||(a=!0,u=new Is),!a){e.next=13;break}return e.prev=3,e.next=6,r.onListen(i);case 6:u.xu=e.sent,e.next=13;break;case 9:return e.prev=9,e.t0=e.catch(3),o=ks(e.t0,"Initialization of query '".concat(Wn(n.query),"' failed")),e.abrupt("return",void n.onError(o));case 13:r.queries.set(i,u),u.listeners.push(n),n.ku(r.onlineState),u.xu&&n.Mu(u.xu)&&As(r);case 14:case"end":return e.stop()}}),e,null,[[3,9]])})))).apply(this,arguments)}function Ss(e,t){return _s.apply(this,arguments)}function _s(){return(_s=Object(o.a)(y.a.mark((function e(t,n){var r,i,a,u,o;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=V(t),i=n.query,a=!1,(u=r.queries.get(i))&&(o=u.listeners.indexOf(n))>=0&&(u.listeners.splice(o,1),a=0===u.listeners.length),!a){e.next=6;break}return e.abrupt("return",(r.queries.delete(i),r.onUnlisten(i)));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function js(e,t){var n,r=V(e),i=!1,a=w(t);try{for(a.s();!(n=a.n()).done;){var u=n.value,o=u.query,s=r.queries.get(o);if(s){var c,l=w(s.listeners);try{for(l.s();!(c=l.n()).done;){c.value.Mu(u)&&(i=!0)}}catch(f){l.e(f)}finally{l.f()}s.xu=u}}}catch(f){a.e(f)}finally{a.f()}i&&As(r)}function Ds(e,t,n){var r=V(e),i=r.queries.get(t);if(i){var a,u=w(i.listeners);try{for(u.s();!(a=u.n()).done;){a.value.onError(n)}}catch(o){u.e(o)}finally{u.f()}}r.queries.delete(t)}function As(e){e.Nu.forEach((function(e){e.next()}))}var Cs=function(){function e(t,n,r){Object(h.a)(this,e),this.query=t,this.Ou=n,this.$u=!1,this.Fu=null,this.onlineState="Unknown",this.options=r||{}}return Object(d.a)(e,[{key:"Mu",value:function(e){if(!this.options.includeMetadataChanges){var t,n=[],r=w(e.docChanges);try{for(r.s();!(t=r.n()).done;){var i=t.value;3!==i.type&&n.push(i)}}catch(u){r.e(u)}finally{r.f()}e=new xs(e.query,e.docs,e.oldDocs,n,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}var a=!1;return this.$u?this.Bu(e)&&(this.Ou.next(e),a=!0):this.Lu(e,this.onlineState)&&(this.qu(e),a=!0),this.Fu=e,a}},{key:"onError",value:function(e){this.Ou.error(e)}},{key:"ku",value:function(e){this.onlineState=e;var t=!1;return this.Fu&&!this.$u&&this.Lu(this.Fu,e)&&(this.qu(this.Fu),t=!0),t}},{key:"Lu",value:function(e,t){if(!e.fromCache)return!0;var n="Offline"!==t;return(!this.options.Uu||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}},{key:"Bu",value:function(e){if(e.docChanges.length>0)return!0;var t=this.Fu&&this.Fu.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}},{key:"qu",value:function(e){e=xs.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.$u=!0,this.Ou.next(e)}}]),e}(),Ns=function(){function e(t,n){Object(h.a)(this,e),this.Ku=t,this.byteLength=n}return Object(d.a)(e,[{key:"Gu",value:function(){return"metadata"in this.Ku}}]),e}(),Rs=function(){function e(t){Object(h.a)(this,e),this.serializer=t}return Object(d.a)(e,[{key:"ir",value:function(e){return Si(this.serializer,e)}},{key:"rr",value:function(e){return e.metadata.exists?Ni(this.serializer,e.document,!1):tn.newNoDocument(this.ir(e.metadata.name),this.ur(e.metadata.readTime))}},{key:"ur",value:function(e){return Ii(e)}}]),e}(),Fs=function(){function e(t,n,r){Object(h.a)(this,e),this.Qu=t,this.localStore=n,this.serializer=r,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Ms(t)}var t;return Object(d.a)(e,[{key:"ju",value:function(e){this.progress.bytesLoaded+=e.byteLength;var t=this.progress.documentsLoaded;if(e.Ku.namedQuery)this.queries.push(e.Ku.namedQuery);else if(e.Ku.documentMetadata){this.documents.push({metadata:e.Ku.documentMetadata}),e.Ku.documentMetadata.exists||++t;var n=re.fromString(e.Ku.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.Ku.document&&(this.documents[this.documents.length-1].document=e.Ku.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}},{key:"zu",value:function(e){var t,n=new Map,r=new Rs(this.serializer),i=w(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;if(a.metadata.queries){var u,o=r.ir(a.metadata.name),s=w(a.metadata.queries);try{for(s.s();!(u=s.n()).done;){var c=u.value,l=(n.get(c)||cr()).add(o);n.set(c,l)}}catch(f){s.e(f)}finally{s.f()}}}}catch(f){i.e(f)}finally{i.f()}return n}},{key:"complete",value:(t=Object(o.a)(y.a.mark((function e(){var t,n,r,i,a;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,$u(this.localStore,new Rs(this.serializer),this.documents,this.Qu.id);case 2:t=e.sent,n=this.zu(this.documents),r=w(this.queries),e.prev=5,r.s();case 7:if((i=r.n()).done){e.next=13;break}return a=i.value,e.next=11,eo(this.localStore,a,n.get(a.name));case 11:e.next=7;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(5),r.e(e.t0);case 18:return e.prev=18,r.f(),e.finish(18);case 21:return e.abrupt("return",(this.progress.taskState="Success",{progress:this.progress,Wu:this.collectionGroups,Hu:t}));case 22:case"end":return e.stop()}}),e,this,[[5,15,18,21]])}))),function(){return t.apply(this,arguments)})}]),e}();function Ms(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}var Vs=function e(t){Object(h.a)(this,e),this.key=t},Ls=function e(t){Object(h.a)(this,e),this.key=t},Ps=function(){function e(t,n){Object(h.a)(this,e),this.query=t,this.Ju=n,this.Yu=null,this.hasCachedResults=!1,this.current=!1,this.Xu=cr(),this.mutatedKeys=cr(),this.Zu=Yn(t),this.tc=new bs(this.Zu)}return Object(d.a)(e,[{key:"ec",get:function(){return this.Ju}},{key:"nc",value:function(e,t){var n=this,r=t?t.sc:new ws,i=t?t.tc:this.tc,a=t?t.mutatedKeys:this.mutatedKeys,u=i,o=!1,s="F"===this.query.limitType&&i.size===this.query.limit?i.last():null,c="L"===this.query.limitType&&i.size===this.query.limit?i.first():null;if(e.inorderTraversal((function(e,t){var l=i.get(e),f=Hn(n.query,t)?t:null,h=!!l&&n.mutatedKeys.has(l.key),d=!!f&&(f.hasLocalMutations||n.mutatedKeys.has(f.key)&&f.hasCommittedMutations),v=!1;l&&f?l.data.isEqual(f.data)?h!==d&&(r.track({type:3,doc:f}),v=!0):n.ic(l,f)||(r.track({type:2,doc:f}),v=!0,(s&&n.Zu(f,s)>0||c&&n.Zu(f,c)<0)&&(o=!0)):!l&&f?(r.track({type:0,doc:f}),v=!0):l&&!f&&(r.track({type:1,doc:l}),v=!0,(s||c)&&(o=!0)),v&&(f?(u=u.add(f),a=d?a.add(e):a.delete(e)):(u=u.delete(e),a=a.delete(e)))})),null!==this.query.limit)for(;u.size>this.query.limit;){var l="F"===this.query.limitType?u.last():u.first();u=u.delete(l.key),a=a.delete(l.key),r.track({type:1,doc:l})}return{tc:u,sc:r,ji:o,mutatedKeys:a}}},{key:"ic",value:function(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}},{key:"applyChanges",value:function(e,t,n){var r=this,i=this.tc;this.tc=e.tc,this.mutatedKeys=e.mutatedKeys;var a=e.sc.Cu();a.sort((function(e,t){return function(e,t){var n=function(e){switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return R()}};return n(e)-n(t)}(e.type,t.type)||r.Zu(e.doc,t.doc)})),this.rc(n);var u=t?this.oc():[],o=0===this.Xu.size&&this.current?1:0,s=o!==this.Yu;return this.Yu=o,0!==a.length||s?{snapshot:new xs(this.query,e.tc,i,a,e.mutatedKeys,0===o,s,!1,!!n&&n.resumeToken.approximateByteSize()>0),uc:u}:{uc:u}}},{key:"ku",value:function(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({tc:this.tc,sc:new ws,mutatedKeys:this.mutatedKeys,ji:!1},!1)):{uc:[]}}},{key:"cc",value:function(e){return!this.Ju.has(e)&&!!this.tc.has(e)&&!this.tc.get(e).hasLocalMutations}},{key:"rc",value:function(e){var t=this;e&&(e.addedDocuments.forEach((function(e){return t.Ju=t.Ju.add(e)})),e.modifiedDocuments.forEach((function(e){})),e.removedDocuments.forEach((function(e){return t.Ju=t.Ju.delete(e)})),this.current=e.current)}},{key:"oc",value:function(){var e=this;if(!this.current)return[];var t=this.Xu;this.Xu=cr(),this.tc.forEach((function(t){e.cc(t.key)&&(e.Xu=e.Xu.add(t.key))}));var n=[];return t.forEach((function(t){e.Xu.has(t)||n.push(new Ls(t))})),this.Xu.forEach((function(e){t.has(e)||n.push(new Vs(e))})),n}},{key:"ac",value:function(e){this.Ju=e.sr,this.Xu=cr();var t=this.nc(e.documents);return this.applyChanges(t,!0)}},{key:"hc",value:function(){return xs.fromInitialDocuments(this.query,this.tc,this.mutatedKeys,0===this.Yu,this.hasCachedResults)}}]),e}(),qs=function e(t,n,r){Object(h.a)(this,e),this.query=t,this.targetId=n,this.view=r},Us=function e(t){Object(h.a)(this,e),this.key=t,this.lc=!1},Bs=function(){function e(t,n,r,i,a,u){Object(h.a)(this,e),this.localStore=t,this.remoteStore=n,this.eventManager=r,this.sharedClientState=i,this.currentUser=a,this.maxConcurrentLimboResolutions=u,this.fc={},this.dc=new $n((function(e){return Qn(e)}),Gn),this._c=new Map,this.wc=new Set,this.mc=new vt(ue.comparator),this.gc=new Map,this.yc=new gu,this.Ic={},this.Tc=new Map,this.Ec=Wa.kn(),this.onlineState="Unknown",this.Ac=void 0}return Object(d.a)(e,[{key:"isPrimaryClient",get:function(){return!0===this.Ac}}]),e}();function Ks(e,t){return zs.apply(this,arguments)}function zs(){return(zs=Object(o.a)(y.a.mark((function e(t,n){var r,i,a,u,o,s;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=Mc(t),!(u=r.dc.get(n))){e.next=6;break}i=u.targetId,r.sharedClientState.addLocalQueryTarget(i),a=u.view.hc(),e.next=15;break;case 6:return e.next=8,Gu(r.localStore,Bn(n));case 8:return o=e.sent,s=r.sharedClientState.addLocalQueryTarget(o.targetId),i=o.targetId,e.next=13,Gs(r,n,i,"current"===s,o.resumeToken);case 13:a=e.sent,r.isPrimaryClient&&Fo(r.remoteStore,o);case 15:return e.abrupt("return",a);case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Gs(e,t,n,r,i){return Qs.apply(this,arguments)}function Qs(){return(Qs=Object(o.a)(y.a.mark((function e(t,n,r,i,a){var u,s,c,l,f,h;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.Rc=function(e,n,r){return(i=Object(o.a)(y.a.mark((function e(t,n,r,i){var a,u,o;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.view.nc(r),e.t0=a.ji,!e.t0){e.next=6;break}return e.next=5,Hu(t.localStore,n.query,!1).then((function(e){var t=e.documents;return n.view.nc(t,a)}));case 5:a=e.sent;case 6:return u=i&&i.targetChanges.get(n.targetId),o=n.view.applyChanges(a,t.isPrimaryClient,u),e.abrupt("return",(hc(t,n.targetId,o.uc),o.snapshot));case 8:case"end":return e.stop()}}),e)}))),function(e,t,n,r){return i.apply(this,arguments)})(t,e,n,r);var i},e.next=3,Hu(t.localStore,n,!0);case 3:return u=e.sent,s=new Ps(n,u.sr),c=s.nc(u.documents),l=oi.createSynthesizedTargetChangeForCurrentChange(r,i&&"Offline"!==t.onlineState,a),f=s.applyChanges(c,t.isPrimaryClient,l),hc(t,r,f.uc),h=new qs(n,r,s),e.abrupt("return",(t.dc.set(n,h),t._c.has(r)?t._c.get(r).push(n):t._c.set(r,[n]),f.snapshot));case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ws(e,t){return Hs.apply(this,arguments)}function Hs(){return(Hs=Object(o.a)(y.a.mark((function e(t,n){var r,i,a;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=V(t),i=r.dc.get(n),!((a=r._c.get(i.targetId)).length>1)){e.next=3;break}return e.abrupt("return",(r._c.set(i.targetId,a.filter((function(e){return!Gn(e,n)}))),void r.dc.delete(n)));case 3:if(!r.isPrimaryClient){e.next=11;break}if(r.sharedClientState.removeLocalQueryTarget(i.targetId),e.t0=r.sharedClientState.isActiveQueryTarget(i.targetId),e.t0){e.next=9;break}return e.next=9,Qu(r.localStore,i.targetId,!1).then((function(){r.sharedClientState.clearQueryState(i.targetId),Mo(r.remoteStore,i.targetId),lc(r,i.targetId)})).catch(ge);case 9:e.next=14;break;case 11:return lc(r,i.targetId),e.next=14,Qu(r.localStore,i.targetId,!0);case 14:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Xs(e,t,n){return Ys.apply(this,arguments)}function Ys(){return(Ys=Object(o.a)(y.a.mark((function e(t,n,r){var i,a,u;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=Vc(t),e.prev=1,e.next=4,function(e,t){var n,r,i=V(e),a=ee.now(),u=t.reduce((function(e,t){return e.add(t.key)}),cr());return i.persistence.runTransaction("Locally write mutations","readwrite",(function(e){var o=er(),s=cr();return i.Xi.getEntries(e,u).next((function(e){(o=e).forEach((function(e,t){t.isValidDocument()||(s=s.add(e))}))})).next((function(){return i.localDocuments.getOverlayedDocuments(e,o)})).next((function(r){n=r;var u,o=[],s=w(t);try{for(s.s();!(u=s.n()).done;){var c=u.value,l=Fr(c,n.get(c.key).overlayedDocument);null!=l&&o.push(new Lr(c.key,l,en(l.value.mapValue),jr.exists(!0)))}}catch(f){s.e(f)}finally{s.f()}return i.mutationQueue.addMutationBatch(e,a,o,t)})).next((function(t){r=t;var a=t.applyToLocalDocumentSet(n,s);return i.documentOverlayCache.saveOverlays(e,t.batchId,a)}))})).then((function(){return{batchId:r.batchId,changes:rr(n)}}))}(i.localStore,n);case 4:return a=e.sent,i.sharedClientState.addPendingMutation(a.batchId),function(e,t,n){var r=e.Ic[e.currentUser.toKey()];r||(r=new vt(J)),r=r.insert(t,n),e.Ic[e.currentUser.toKey()]=r}(i,a.batchId,r),e.next=9,yc(i,a.changes);case 9:return e.next=11,$o(i.remoteStore);case 11:e.next=17;break;case 13:e.prev=13,e.t0=e.catch(1),u=ks(e.t0,"Failed to persist write"),r.reject(u);case 17:case"end":return e.stop()}}),e,null,[[1,13]])})))).apply(this,arguments)}function Js(e,t){return $s.apply(this,arguments)}function $s(){return($s=Object(o.a)(y.a.mark((function e(t,n){var r,i;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=V(t),e.prev=1,e.next=4,Bu(r.localStore,n);case 4:return i=e.sent,n.targetChanges.forEach((function(e,t){var n=r.gc.get(t);n&&(F(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?n.lc=!0:e.modifiedDocuments.size>0?F(n.lc):e.removedDocuments.size>0&&(F(n.lc),n.lc=!1))})),e.next=8,yc(r,i,n);case 8:e.next=14;break;case 10:return e.prev=10,e.t0=e.catch(1),e.next=14,ge(e.t0);case 14:case"end":return e.stop()}}),e,null,[[1,10]])})))).apply(this,arguments)}function Zs(e,t,n){var r=V(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){var i=[];r.dc.forEach((function(e,n){var r=n.view.ku(t);r.snapshot&&i.push(r.snapshot)})),function(e,t){var n=V(e);n.onlineState=t;var r=!1;n.queries.forEach((function(e,n){var i,a=w(n.listeners);try{for(a.s();!(i=a.n()).done;){i.value.ku(t)&&(r=!0)}}catch(u){a.e(u)}finally{a.f()}})),r&&As(n)}(r.eventManager,t),i.length&&r.fc.eu(i),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}function ec(e,t,n){return tc.apply(this,arguments)}function tc(){return(tc=Object(o.a)(y.a.mark((function e(t,n,r){var i,a,u,o,s,c;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((i=V(t)).sharedClientState.updateQueryState(n,"rejected",r),a=i.gc.get(n),!(u=a&&a.key)){e.next=14;break}return o=(o=new vt(ue.comparator)).insert(u,tn.newNoDocument(u,te.min())),s=cr().add(u),c=new ui(te.min(),new Map,new vt(J),o,s),e.next=9,Js(i,c);case 9:i.mc=i.mc.remove(u),i.gc.delete(n),vc(i),e.next=16;break;case 14:return e.next=16,Qu(i.localStore,n,!1).then((function(){return lc(i,n,r)})).catch(ge);case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function nc(e,t){return rc.apply(this,arguments)}function rc(){return(rc=Object(o.a)(y.a.mark((function e(t,n){var r,i,a;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=V(t),i=n.batch.batchId,e.prev=1,e.next=4,qu(r.localStore,n);case 4:return a=e.sent,cc(r,i,null),sc(r,i),r.sharedClientState.updateMutationState(i,"acknowledged"),e.next=10,yc(r,a);case 10:e.next=16;break;case 12:return e.prev=12,e.t0=e.catch(1),e.next=16,ge(e.t0);case 16:case"end":return e.stop()}}),e,null,[[1,12]])})))).apply(this,arguments)}function ic(e,t,n){return ac.apply(this,arguments)}function ac(){return(ac=Object(o.a)(y.a.mark((function e(t,n,r){var i,a;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=V(t),e.prev=1,e.next=4,function(e,t){var n=V(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(function(e){var r;return n.mutationQueue.lookupMutationBatch(e,t).next((function(t){return F(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)})).next((function(){return n.mutationQueue.performConsistencyCheck(e)})).next((function(){return n.documentOverlayCache.removeOverlaysForBatchId(e,r,t)})).next((function(){return n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r)})).next((function(){return n.localDocuments.getDocuments(e,r)}))}))}(i.localStore,n);case 4:return a=e.sent,cc(i,n,r),sc(i,n),i.sharedClientState.updateMutationState(n,"rejected",r),e.next=10,yc(i,a);case 10:e.next=16;break;case 12:return e.prev=12,e.t0=e.catch(1),e.next=16,ge(e.t0);case 16:case"end":return e.stop()}}),e,null,[[1,12]])})))).apply(this,arguments)}function uc(e,t){return oc.apply(this,arguments)}function oc(){return(oc=Object(o.a)(y.a.mark((function e(t,n){var r,i,a,u;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Uo((r=V(t)).remoteStore)||D("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled."),e.prev=2,e.next=5,function(e){var t=V(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(function(e){return t.mutationQueue.getHighestUnacknowledgedBatchId(e)}))}(r.localStore);case 5:if(-1!==(i=e.sent)){e.next=8;break}return e.abrupt("return",void n.resolve());case 8:(a=r.Tc.get(i)||[]).push(n),r.Tc.set(i,a),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(2),u=ks(e.t0,"Initialization of waitForPendingWrites() operation failed"),n.reject(u);case 16:case"end":return e.stop()}}),e,null,[[2,12]])})))).apply(this,arguments)}function sc(e,t){(e.Tc.get(t)||[]).forEach((function(e){e.resolve()})),e.Tc.delete(t)}function cc(e,t,n){var r=V(e),i=r.Ic[r.currentUser.toKey()];if(i){var a=i.get(t);a&&(n?a.reject(n):a.resolve(),i=i.remove(t)),r.Ic[r.currentUser.toKey()]=i}}function lc(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;e.sharedClientState.removeLocalQueryTarget(t);var r,i=w(e._c.get(t));try{for(i.s();!(r=i.n()).done;){var a=r.value;e.dc.delete(a),n&&e.fc.vc(a,n)}}catch(u){i.e(u)}finally{i.f()}e._c.delete(t),e.isPrimaryClient&&e.yc.ps(t).forEach((function(t){e.yc.containsKey(t)||fc(e,t)}))}function fc(e,t){e.wc.delete(t.path.canonicalString());var n=e.mc.get(t);null!==n&&(Mo(e.remoteStore,n),e.mc=e.mc.remove(t),e.gc.delete(n),vc(e))}function hc(e,t,n){var r,i=w(n);try{for(i.s();!(r=i.n()).done;){var a=r.value;a instanceof Vs?(e.yc.addReference(a.key,t),dc(e,a)):a instanceof Ls?(D("SyncEngine","Document no longer in limbo: "+a.key),e.yc.removeReference(a.key,t),e.yc.containsKey(a.key)||fc(e,a.key)):R()}}catch(u){i.e(u)}finally{i.f()}}function dc(e,t){var n=t.key,r=n.path.canonicalString();e.mc.get(n)||e.wc.has(r)||(D("SyncEngine","New document in limbo: "+n),e.wc.add(r),vc(e))}function vc(e){for(;e.wc.size>0&&e.mc.size<e.maxConcurrentLimboResolutions;){var t=e.wc.values().next().value;e.wc.delete(t);var n=new ue(re.fromString(t)),r=e.Ec.next();e.gc.set(r,new Us(n)),e.mc=e.mc.insert(n,r),Fo(e.remoteStore,new Wi(Bn(Mn(n.path)),r,"TargetPurposeLimboResolution",Ce.ct))}}function yc(e,t,n){return pc.apply(this,arguments)}function pc(){return(pc=Object(o.a)(y.a.mark((function e(t,n,r){var i,a,u,s;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=V(t),a=[],u=[],s=[],e.t0=i.dc.isEmpty(),e.t0){e.next=9;break}return i.dc.forEach((function(e,t){s.push(i.Rc(t,n,r).then((function(e){if((e||r)&&i.isPrimaryClient&&i.sharedClientState.updateQueryState(t.targetId,(null==e?void 0:e.fromCache)?"not-current":"current"),e){a.push(e);var n=Ru.Bi(t.targetId,e);u.push(n)}})))})),e.next=6,Promise.all(s);case 6:return i.fc.eu(a),e.next=9,function(){var e=Object(o.a)(y.a.mark((function e(t,n){var r,i,a,u,o,s,c,l;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=V(t),e.prev=1,e.next=4,r.persistence.runTransaction("notifyLocalViewChanges","readwrite",(function(e){return be.forEach(n,(function(t){return be.forEach(t.$i,(function(n){return r.persistence.referenceDelegate.addReference(e,t.targetId,n)})).next((function(){return be.forEach(t.Fi,(function(n){return r.persistence.referenceDelegate.removeReference(e,t.targetId,n)}))}))}))}));case 4:e.next=11;break;case 6:if(e.prev=6,e.t0=e.catch(1),Ee(e.t0)){e.next=10;break}throw e.t0;case 10:D("LocalStore","Failed to update sequence numbers: "+e.t0);case 11:i=w(n);try{for(i.s();!(a=i.n()).done;)u=a.value,o=u.targetId,u.fromCache||(s=r.Hi.get(o),c=s.snapshotVersion,l=s.withLastLimboFreeSnapshotVersion(c),r.Hi=r.Hi.insert(o,l))}catch(f){i.e(f)}finally{i.f()}case 13:case"end":return e.stop()}}),e,null,[[1,6]])})));return function(t,n){return e.apply(this,arguments)}}()(i.localStore,u);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function mc(e,t){return gc.apply(this,arguments)}function gc(){return(gc=Object(o.a)(y.a.mark((function e(t,n){var r,i;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=V(t)).currentUser.isEqual(n)){e.next=11;break}return D("SyncEngine","User change. New user:",n.toKey()),e.next=5,Lu(r.localStore,n);case 5:return i=e.sent,r.currentUser=n,function(e,t){e.Tc.forEach((function(e){e.forEach((function(e){e.reject(new P(L.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.Tc.clear()}(r),r.sharedClientState.handleUserChange(n,i.removedBatchIds,i.addedBatchIds),e.next=11,yc(r,i.tr);case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function kc(e,t){var n=V(e),r=n.gc.get(t);if(r&&r.lc)return cr().add(r.key);var i=cr(),a=n._c.get(t);if(!a)return i;var u,o=w(a);try{for(o.s();!(u=o.n()).done;){var s=u.value,c=n.dc.get(s);i=i.unionWith(c.view.ec)}}catch(l){o.e(l)}finally{o.f()}return i}function bc(e,t){return wc.apply(this,arguments)}function wc(){return(wc=Object(o.a)(y.a.mark((function e(t,n){var r,i,a;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=V(t),e.next=3,Hu(r.localStore,n.query,!0);case 3:return i=e.sent,a=n.view.ac(i),e.abrupt("return",(r.isPrimaryClient&&hc(r,n.targetId,a.uc),a));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function xc(e,t){return Ic.apply(this,arguments)}function Ic(){return(Ic=Object(o.a)(y.a.mark((function e(t,n){var r;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=V(t),e.abrupt("return",Yu(r.localStore,n).then((function(e){return yc(r,e)})));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Oc(e,t,n,r){return Ec.apply(this,arguments)}function Ec(){return(Ec=Object(o.a)(y.a.mark((function e(t,n,r,i){var a,u;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=V(t),e.next=3,function(e,t){var n=V(e),r=V(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(function(e){return r.Vn(e,t).next((function(t){return t?n.localDocuments.getDocuments(e,t):be.resolve(null)}))}))}(a.localStore,n);case 3:if(null===(u=e.sent)){e.next=15;break}if("pending"!==r){e.next=10;break}return e.next=8,$o(a.remoteStore);case 8:e.next=11;break;case 10:"acknowledged"===r||"rejected"===r?(cc(a,n,i||null),sc(a,n),function(e,t){V(V(e).mutationQueue).Dn(t)}(a.localStore,n)):R();case 11:return e.next=13,yc(a,u);case 13:e.next=16;break;case 15:D("SyncEngine","Cannot apply mutation batch with id: "+n);case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Tc(e,t){return Sc.apply(this,arguments)}function Sc(){return(Sc=Object(o.a)(y.a.mark((function e(t,n){var r,i,a,u,o,s,c,l;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Mc(r=V(t)),Vc(r),!0!==n||!0===r.Ac){e.next=13;break}return i=r.sharedClientState.getAllActiveQueryTargets(),e.next=5,_c(r,i.toArray());case 5:return a=e.sent,r.Ac=!0,e.next=9,vs(r.remoteStore,!0);case 9:u=w(a);try{for(u.s();!(o=u.n()).done;)s=o.value,Fo(r.remoteStore,s)}catch(f){u.e(f)}finally{u.f()}e.next=25;break;case 13:if(!1!==n||!1===r.Ac){e.next=25;break}return c=[],l=Promise.resolve(),r._c.forEach((function(e,t){r.sharedClientState.isLocalQueryTarget(t)?c.push(t):l=l.then((function(){return lc(r,t),Qu(r.localStore,t,!0)})),Mo(r.remoteStore,t)})),e.next=19,l;case 19:return e.next=21,_c(r,c);case 21:return function(e){var t=V(e);t.gc.forEach((function(e,n){Mo(t.remoteStore,n)})),t.yc.Is(),t.gc=new Map,t.mc=new vt(ue.comparator)}(r),r.Ac=!1,e.next=25,vs(r.remoteStore,!1);case 25:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function _c(e,t,n){return jc.apply(this,arguments)}function jc(){return(jc=Object(o.a)(y.a.mark((function e(t,n,r){var i,a,u,o,s,c,l,f,h,d,v,p,m,g;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=V(t),a=[],u=[],o=w(n),e.prev=2,o.s();case 4:if((s=o.n()).done){e.next=45;break}if(c=s.value,l=void 0,!(f=i._c.get(c))||0===f.length){e.next=34;break}return e.next=11,Gu(i.localStore,Bn(f[0]));case 11:l=e.sent,h=w(f),e.prev=13,h.s();case 15:if((d=h.n()).done){e.next=24;break}return v=d.value,p=i.dc.get(v),e.next=20,bc(i,p);case 20:(m=e.sent).snapshot&&u.push(m.snapshot);case 22:e.next=15;break;case 24:e.next=29;break;case 26:e.prev=26,e.t0=e.catch(13),h.e(e.t0);case 29:return e.prev=29,h.f(),e.finish(29);case 32:e.next=42;break;case 34:return e.next=36,Xu(i.localStore,c);case 36:return g=e.sent,e.next=39,Gu(i.localStore,g);case 39:return l=e.sent,e.next=42,Gs(i,Dc(g),c,!1,l.resumeToken);case 42:a.push(l);case 43:e.next=4;break;case 45:e.next=50;break;case 47:e.prev=47,e.t1=e.catch(2),o.e(e.t1);case 50:return e.prev=50,o.f(),e.finish(50);case 53:return e.abrupt("return",(i.fc.eu(u),a));case 54:case"end":return e.stop()}}),e,null,[[2,47,50,53],[13,26,29,32]])})))).apply(this,arguments)}function Dc(e){return Fn(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Ac(e){var t=V(e);return V(V(t.localStore).persistence).Mi()}function Cc(e,t,n,r){return Nc.apply(this,arguments)}function Nc(){return(Nc=Object(o.a)(y.a.mark((function e(t,n,r,i){var a,u,o,s;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(a=V(t)).Ac){e.next=3;break}return e.abrupt("return",void D("SyncEngine","Ignoring unexpected query state notification."));case 3:if(!((u=a._c.get(n))&&u.length>0)){e.next=20;break}e.t0=r,e.next="current"===e.t0||"not-current"===e.t0?8:"rejected"===e.t0?15:19;break;case 8:return e.next=10,Yu(a.localStore,Xn(u[0]));case 10:return o=e.sent,s=ui.createSynthesizedRemoteEventForCurrentChange(n,"current"===r,It.EMPTY_BYTE_STRING),e.next=14,yc(a,o,s);case 14:return e.abrupt("break",20);case 15:return e.next=17,Qu(a.localStore,n,!0);case 17:return lc(a,n,i),e.abrupt("break",20);case 19:R();case 20:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Rc(e,t,n){return Fc.apply(this,arguments)}function Fc(){return(Fc=Object(o.a)(y.a.mark((function e(t,n,r){var i,a,u,o,s,c,l,f,h;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i=Mc(t)).Ac){e.next=45;break}a=w(n),e.prev=3,a.s();case 5:if((u=a.n()).done){e.next=21;break}if(o=u.value,!i._c.has(o)){e.next=10;break}return D("SyncEngine","Adding an already active target "+o),e.abrupt("continue",19);case 10:return e.next=12,Xu(i.localStore,o);case 12:return s=e.sent,e.next=15,Gu(i.localStore,s);case 15:return c=e.sent,e.next=18,Gs(i,Dc(s),c.targetId,!1,c.resumeToken);case 18:Fo(i.remoteStore,c);case 19:e.next=5;break;case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(3),a.e(e.t0);case 26:return e.prev=26,a.f(),e.finish(26);case 29:l=w(r),e.prev=30,h=y.a.mark((function e(){var t;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=f.value,e.t0=i._c.has(t),!e.t0){e.next=5;break}return e.next=5,Qu(i.localStore,t,!1).then((function(){Mo(i.remoteStore,t),lc(i,t)})).catch(ge);case 5:case"end":return e.stop()}}),e)})),l.s();case 33:if((f=l.n()).done){e.next=37;break}return e.delegateYield(h(),"t1",35);case 35:e.next=33;break;case 37:e.next=42;break;case 39:e.prev=39,e.t2=e.catch(30),l.e(e.t2);case 42:return e.prev=42,l.f(),e.finish(42);case 45:case"end":return e.stop()}}),e,null,[[3,23,26,29],[30,39,42,45]])})))).apply(this,arguments)}function Mc(e){var t=V(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=Js.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=kc.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=ec.bind(null,t),t.fc.eu=js.bind(null,t.eventManager),t.fc.vc=Ds.bind(null,t.eventManager),t}function Vc(e){var t=V(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=nc.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=ic.bind(null,t),t}function Lc(e,t,n){var r,i=V(e);(r=Object(o.a)(y.a.mark((function e(t,n,r){var i,a,u,o,s;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.getMetadata();case 3:return i=e.sent,e.next=6,function(e,t){var n=V(e),r=Ii(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(function(e){return n.Ls.getBundleMetadata(e,t.id)})).then((function(e){return!!e&&e.createTime.compareTo(r)>=0}))}(t.localStore,i);case 6:if(!e.sent){e.next=11;break}return e.next=9,n.close();case 9:return r._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(i)),e.abrupt("return",Promise.resolve(new Set));case 11:return r._updateProgress(Ms(i)),a=new Fs(i,t.localStore,n.serializer),e.next=15,n.Pc();case 15:u=e.sent;case 16:if(!u){e.next=26;break}return e.next=19,a.ju(u);case 19:return(o=e.sent)&&r._updateProgress(o),e.next=23,n.Pc();case 23:u=e.sent;case 24:e.next=16;break;case 26:return e.next=28,a.complete();case 28:return s=e.sent,e.next=31,yc(t,s.Hu,void 0);case 31:return e.next=33,function(e,t){var n=V(e);return n.persistence.runTransaction("Save bundle","readwrite",(function(e){return n.Ls.saveBundleMetadata(e,t)}))}(t.localStore,i);case 33:return r._completeWith(s.progress),e.abrupt("return",Promise.resolve(s.Wu));case 37:return e.prev=37,e.t0=e.catch(0),e.abrupt("return",(C("SyncEngine","Loading bundle failed with ".concat(e.t0)),r._failWith(e.t0),Promise.resolve(new Set)));case 40:case"end":return e.stop()}}),e,null,[[0,37]])}))),function(e,t,n){return r.apply(this,arguments)})(i,t,n).then((function(e){i.sharedClientState.notifyBundleLoaded(e)}))}var Pc=function(){function e(){Object(h.a)(this,e),this.synchronizeTabs=!1}var t,n;return Object(d.a)(e,[{key:"initialize",value:(n=Object(o.a)(y.a.mark((function e(t){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.serializer=Io(t.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(t),this.persistence=this.createPersistence(t),e.next=5,this.persistence.start();case 5:this.localStore=this.createLocalStore(t),this.gcScheduler=this.createGarbageCollectionScheduler(t,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(t,this.localStore);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"createGarbageCollectionScheduler",value:function(e,t){return null}},{key:"createIndexBackfillerScheduler",value:function(e,t){return null}},{key:"createLocalStore",value:function(e){return Vu(this.persistence,new Fu,e.initialUser,this.serializer)}},{key:"createPersistence",value:function(e){return new Ou(Tu.js,this.serializer)}},{key:"createSharedClientState",value:function(e){return new fo}},{key:"terminate",value:(t=Object(o.a)(y.a.mark((function e(){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.gcScheduler&&this.gcScheduler.stop(),e.next=3,this.sharedClientState.shutdown();case 3:return e.next=5,this.persistence.shutdown();case 5:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),e}(),qc=function(e){Object(s.a)(r,e);var t,n=I(r);function r(e,t,i){var a;return Object(h.a)(this,r),(a=n.call(this)).bc=e,a.cacheSizeBytes=t,a.forceOwnership=i,a.synchronizeTabs=!1,a}return Object(d.a)(r,[{key:"initialize",value:(t=Object(o.a)(y.a.mark((function e(t){var n=this;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(i.a)(Object(l.a)(r.prototype),"initialize",this).call(this,t);case 2:return e.next=4,this.bc.initialize(this,t);case 4:return e.next=6,Vc(this.bc.syncEngine);case 6:return e.next=8,$o(this.bc.remoteStore);case 8:return e.next=10,this.persistence.pi((function(){return n.gcScheduler&&!n.gcScheduler.started&&n.gcScheduler.start(),n.indexBackfillerScheduler&&!n.indexBackfillerScheduler.started&&n.indexBackfillerScheduler.start(),Promise.resolve()}));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"createLocalStore",value:function(e){return Vu(this.persistence,new Fu,e.initialUser,this.serializer)}},{key:"createGarbageCollectionScheduler",value:function(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new eu(n,e.asyncQueue,t)}},{key:"createIndexBackfillerScheduler",value:function(e,t){var n=new Ae(t,this.persistence);return new De(e.asyncQueue,n)}},{key:"createPersistence",value:function(e){var t=Nu(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Pa.withCacheSize(this.cacheSizeBytes):Pa.DEFAULT;return new Du(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,wo(),xo(),this.serializer,this.sharedClientState,!!this.forceOwnership)}},{key:"createSharedClientState",value:function(e){return new fo}}]),r}(Pc),Uc=function(e){Object(s.a)(r,e);var t,n=I(r);function r(e,t){var i;return Object(h.a)(this,r),(i=n.call(this,e,t,!1)).bc=e,i.cacheSizeBytes=t,i.synchronizeTabs=!0,i}return Object(d.a)(r,[{key:"initialize",value:(t=Object(o.a)(y.a.mark((function e(t){var n,a=this;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(i.a)(Object(l.a)(r.prototype),"initialize",this).call(this,t);case 2:if(n=this.bc.syncEngine,e.t0=this.sharedClientState instanceof lo,!e.t0){e.next=8;break}return this.sharedClientState.syncEngine={Qr:Oc.bind(null,n),jr:Cc.bind(null,n),zr:Rc.bind(null,n),Mi:Ac.bind(null,n),Gr:xc.bind(null,n)},e.next=8,this.sharedClientState.start();case 8:return e.next=10,this.persistence.pi(function(){var e=Object(o.a)(y.a.mark((function e(t){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Tc(a.bc.syncEngine,t);case 2:a.gcScheduler&&(t&&!a.gcScheduler.started?a.gcScheduler.start():t||a.gcScheduler.stop()),a.indexBackfillerScheduler&&(t&&!a.indexBackfillerScheduler.started?a.indexBackfillerScheduler.start():t||a.indexBackfillerScheduler.stop());case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 10:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"createSharedClientState",value:function(e){var t=wo();if(!lo.D(t))throw new P(L.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=Nu(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new lo(t,e.asyncQueue,n,e.clientId,e.initialUser)}}]),r}(qc),Bc=function(){function e(){Object(h.a)(this,e)}var t;return Object(d.a)(e,[{key:"initialize",value:(t=Object(o.a)(y.a.mark((function e(t,n){var r=this;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=this.localStore,e.t0){e.next=12;break}return this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(n),this.remoteStore=this.createRemoteStore(n),this.eventManager=this.createEventManager(n),this.syncEngine=this.createSyncEngine(n,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=function(e){return Zs(r.syncEngine,e,1)},this.remoteStore.remoteSyncer.handleCredentialChange=mc.bind(null,this.syncEngine),e.next=12,vs(this.remoteStore,this.syncEngine.isPrimaryClient);case 12:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"createEventManager",value:function(e){return new Os}},{key:"createDatastore",value:function(e){var t,n=Io(e.databaseInfo.databaseId),r=(t=e.databaseInfo,new bo(t));return function(e,t,n,r){return new _o(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,r,n)}},{key:"createRemoteStore",value:function(e){var t,n,r,i,a,u=this;return t=this.localStore,n=this.datastore,r=e.asyncQueue,i=function(e){return Zs(u.syncEngine,e,0)},a=vo.D()?new vo:new ho,new Do(t,n,r,i,a)}},{key:"createSyncEngine",value:function(e,t){return function(e,t,n,r,i,a,u){var o=new Bs(e,t,n,r,i,a);return u&&(o.Ac=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}},{key:"terminate",value:function(){return(e=Object(o.a)(y.a.mark((function e(t){var n;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=V(t),D("RemoteStore","RemoteStore shutting down."),n.Au.add(5),e.next=5,No(n);case 5:n.vu.shutdown(),n.Pu.set("Unknown");case 7:case"end":return e.stop()}}),e)}))),function(t){return e.apply(this,arguments)})(this.remoteStore);var e}}]),e}();function Kc(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10240,n=0;return{read:function(){return Object(o.a)(y.a.mark((function r(){var i;return y.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!(n<e.byteLength)){r.next=3;break}return i={value:e.slice(n,n+t),done:!1},r.abrupt("return",(n+=t,i));case 3:return r.abrupt("return",{done:!0});case 4:case"end":return r.stop()}}),r)})))()},cancel:function(){return Object(o.a)(y.a.mark((function e(){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})))()},releaseLock:function(){},closed:Promise.resolve()}}var zc=function(){function e(t){Object(h.a)(this,e),this.observer=t,this.muted=!1}return Object(d.a)(e,[{key:"next",value:function(e){this.observer.next&&this.Vc(this.observer.next,e)}},{key:"error",value:function(e){this.observer.error?this.Vc(this.observer.error,e):A("Uncaught Error in snapshot listener:",e.toString())}},{key:"Sc",value:function(){this.muted=!0}},{key:"Vc",value:function(e,t){var n=this;this.muted||setTimeout((function(){n.muted||e(t)}),0)}}]),e}(),Gc=function(){function e(t,n){var r=this;Object(h.a)(this,e),this.Dc=t,this.serializer=n,this.metadata=new q,this.buffer=new Uint8Array,this.Cc=new TextDecoder("utf-8"),this.xc().then((function(e){e&&e.Gu()?r.metadata.resolve(e.Ku.metadata):r.metadata.reject(new Error("The first element of the bundle is not a metadata, it is\n             ".concat(JSON.stringify(null==e?void 0:e.Ku))))}),(function(e){return r.metadata.reject(e)}))}var t,n,r,i,a,u;return Object(d.a)(e,[{key:"close",value:function(){return this.Dc.cancel()}},{key:"getMetadata",value:(u=Object(o.a)(y.a.mark((function e(){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.metadata.promise);case 1:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"Pc",value:(a=Object(o.a)(y.a.mark((function e(){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getMetadata();case 2:return e.abrupt("return",this.xc());case 3:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"xc",value:(i=Object(o.a)(y.a.mark((function e(){var t,n,r,i;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.Nc();case 2:if(null!==(t=e.sent)){e.next=5;break}return e.abrupt("return",null);case 5:return n=this.Cc.decode(t),r=Number(n),isNaN(r)&&this.kc("length string (".concat(n,") is not valid number")),e.next=9,this.Mc(r);case 9:return i=e.sent,e.abrupt("return",new Ns(JSON.parse(i),t.length+r));case 11:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"Oc",value:function(){return this.buffer.findIndex((function(e){return e==="{".charCodeAt(0)}))}},{key:"Nc",value:(r=Object(o.a)(y.a.mark((function e(){var t,n;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.Oc()<0)){e.next=7;break}return e.next=3,this.$c();case 3:if(!e.sent){e.next=5;break}return e.abrupt("break",7);case 5:e.next=0;break;case 7:if(0!==this.buffer.length){e.next=9;break}return e.abrupt("return",null);case 9:return(t=this.Oc())<0&&this.kc("Reached the end of bundle when a length string is expected."),n=this.buffer.slice(0,t),e.abrupt("return",(this.buffer=this.buffer.slice(t),n));case 13:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"Mc",value:(n=Object(o.a)(y.a.mark((function e(t){var n;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.buffer.length<t)){e.next=8;break}return e.next=3,this.$c();case 3:if(e.t0=e.sent,!e.t0){e.next=6;break}this.kc("Reached the end of bundle when more is expected.");case 6:e.next=0;break;case 8:return n=this.Cc.decode(this.buffer.slice(0,t)),e.abrupt("return",(this.buffer=this.buffer.slice(t),n));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"kc",value:function(e){throw this.Dc.cancel(),new Error("Invalid bundle format: ".concat(e))}},{key:"$c",value:(t=Object(o.a)(y.a.mark((function e(){var t,n;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.Dc.read();case 2:return(t=e.sent).done||((n=new Uint8Array(this.buffer.length+t.value.length)).set(this.buffer),n.set(t.value,this.buffer.length),this.buffer=n),e.abrupt("return",t.done);case 5:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),e}(),Qc=function(){function e(t){Object(h.a)(this,e),this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}var t,n;return Object(d.a)(e,[{key:"lookup",value:(n=Object(o.a)(y.a.mark((function e(t){var n,r=this;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.ensureCommitNotCalled(),!(this.mutations.length>0)){e.next=2;break}throw new P(L.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");case 2:return e.next=4,function(){var e=Object(o.a)(y.a.mark((function e(t,n){var r,i,a,u,o,s;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=V(t),i=Di(r.serializer)+"/documents",a={documents:n.map((function(e){return Ti(r.serializer,e)}))},e.next=5,r.Ao("BatchGetDocuments",i,a,n.length);case 5:return u=e.sent,o=new Map,u.forEach((function(e){var t=Ri(r.serializer,e);o.set(t.key.toString(),t)})),s=[],e.abrupt("return",(n.forEach((function(e){var t=o.get(e.toString());F(!!t),s.push(t)})),s));case 10:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()(this.datastore,t);case 4:return n=e.sent,e.abrupt("return",(n.forEach((function(e){return r.recordVersion(e)})),n));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"set",value:function(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}},{key:"update",value:function(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}},{key:"delete",value:function(e){this.write(new zr(e,this.precondition(e))),this.writtenDocs.add(e.toString())}},{key:"commit",value:(t=Object(o.a)(y.a.mark((function e(){var t,n=this;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.ensureCommitNotCalled(),!this.lastWriteError){e.next=2;break}throw this.lastWriteError;case 2:return t=this.readVersions,this.mutations.forEach((function(e){t.delete(e.key.toString())})),t.forEach((function(e,t){var r=ue.fromPath(t);n.mutations.push(new Gr(r,n.precondition(r)))})),e.next=7,function(){var e=Object(o.a)(y.a.mark((function e(t,n){var r,i,a;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=V(t),i=Di(r.serializer)+"/documents",a={writes:n.map((function(e){return Fi(r.serializer,e)}))},e.next=3,r.po("Commit",i,a);case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()(this.datastore,this.mutations);case 7:this.committed=!0;case 8:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"recordVersion",value:function(e){var t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw R();t=te.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new P(L.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}},{key:"precondition",value:function(e){var t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(te.min())?jr.exists(!1):jr.updateTime(t):jr.none()}},{key:"preconditionForUpdate",value:function(e){var t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(te.min()))throw new P(L.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return jr.updateTime(t)}return jr.exists(!0)}},{key:"write",value:function(e){this.ensureCommitNotCalled(),this.mutations.push(e)}},{key:"ensureCommitNotCalled",value:function(){}}]),e}(),Wc=function(){function e(t,n,r,i,a){Object(h.a)(this,e),this.asyncQueue=t,this.datastore=n,this.options=r,this.updateFunction=i,this.deferred=a,this.Fc=r.maxAttempts,this.Lo=new Oo(this.asyncQueue,"transaction_retry")}return Object(d.a)(e,[{key:"run",value:function(){this.Fc-=1,this.Bc()}},{key:"Bc",value:function(){var e=this;this.Lo.xo(Object(o.a)(y.a.mark((function t(){var n,r;return y.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=new Qc(e.datastore),(r=e.Lc(n))&&r.then((function(t){e.asyncQueue.enqueueAndForget((function(){return n.commit().then((function(){e.deferred.resolve(t)})).catch((function(t){e.qc(t)}))}))})).catch((function(t){e.qc(t)}));case 2:case"end":return t.stop()}}),t)}))))}},{key:"Lc",value:function(e){try{var t=this.updateFunction(e);return!Ne(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}},{key:"qc",value:function(e){var t=this;this.Fc>0&&this.Uc(e)?(this.Fc-=1,this.asyncQueue.enqueueAndForget((function(){return t.Bc(),Promise.resolve()}))):this.deferred.reject(e)}},{key:"Uc",value:function(e){if("FirebaseError"===e.name){var t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!Yr(t)}return!1}}]),e}(),Hc=function(){function e(t,n,r,i){var a=this;Object(h.a)(this,e),this.authCredentials=t,this.appCheckCredentials=n,this.asyncQueue=r,this.databaseInfo=i,this.user=E.UNAUTHENTICATED,this.clientId=Y.A(),this.authCredentialListener=function(){return Promise.resolve()},this.appCheckCredentialListener=function(){return Promise.resolve()},this.authCredentials.start(r,function(){var e=Object(o.a)(y.a.mark((function e(t){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return D("FirestoreClient","Received user=",t.uid),e.next=3,a.authCredentialListener(t);case 3:a.user=t;case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),this.appCheckCredentials.start(r,(function(e){return D("FirestoreClient","Received new app check token=",e),a.appCheckCredentialListener(e,a.user)}))}var t;return Object(d.a)(e,[{key:"getConfiguration",value:(t=Object(o.a)(y.a.mark((function e(){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100});case 1:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"setCredentialChangeListener",value:function(e){this.authCredentialListener=e}},{key:"setAppCheckTokenChangeListener",value:function(e){this.appCheckCredentialListener=e}},{key:"verifyNotTerminated",value:function(){if(this.asyncQueue.isShuttingDown)throw new P(L.FAILED_PRECONDITION,"The client has already been terminated.")}},{key:"terminate",value:function(){var e=this;this.asyncQueue.enterRestrictedMode();var t=new q;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(Object(o.a)(y.a.mark((function n(){var r;return y.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(n.prev=0,n.t0=e._onlineComponents,!n.t0){n.next=5;break}return n.next=5,e._onlineComponents.terminate();case 5:if(n.t1=e._offlineComponents,!n.t1){n.next=9;break}return n.next=9,e._offlineComponents.terminate();case 9:e.authCredentials.shutdown(),e.appCheckCredentials.shutdown(),t.resolve(),n.next=18;break;case 14:n.prev=14,n.t2=n.catch(0),r=ks(n.t2,"Failed to shutdown persistence"),t.reject(r);case 18:case"end":return n.stop()}}),n,null,[[0,14]])})))),t.promise}}]),e}();function Xc(e,t){return Yc.apply(this,arguments)}function Yc(){return(Yc=Object(o.a)(y.a.mark((function e(t,n){var r,i;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.asyncQueue.verifyOperationInProgress(),D("FirestoreClient","Initializing OfflineComponentProvider"),e.next=3,t.getConfiguration();case 3:return r=e.sent,e.next=6,n.initialize(r);case 6:i=r.initialUser,t.setCredentialChangeListener(function(){var e=Object(o.a)(y.a.mark((function e(t){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=i.isEqual(t),e.t0){e.next=5;break}return e.next=4,Lu(n.localStore,t);case 4:i=t;case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),n.persistence.setDatabaseDeletedListener((function(){return t.terminate()})),t._offlineComponents=n;case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Jc(e,t){return $c.apply(this,arguments)}function $c(){return($c=Object(o.a)(y.a.mark((function e(t,n){var r,i;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.asyncQueue.verifyOperationInProgress(),e.next=3,el(t);case 3:return r=e.sent,D("FirestoreClient","Initializing OnlineComponentProvider"),e.next=7,t.getConfiguration();case 7:return i=e.sent,e.next=10,n.initialize(r,i);case 10:t.setCredentialChangeListener((function(e){return hs(n.remoteStore,e)})),t.setAppCheckTokenChangeListener((function(e,t){return hs(n.remoteStore,t)})),t._onlineComponents=n;case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Zc(e){return"FirebaseError"===e.name?e.code===L.FAILED_PRECONDITION||e.code===L.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}function el(e){return tl.apply(this,arguments)}function tl(){return(tl=Object(o.a)(y.a.mark((function e(t){var n;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t._offlineComponents){e.next=21;break}if(!t._uninitializedComponentsProvider){e.next=18;break}return D("FirestoreClient","Using user provided OfflineComponentProvider"),e.prev=3,e.next=6,Xc(t,t._uninitializedComponentsProvider._offline);case 6:e.next=16;break;case 8:if(e.prev=8,e.t0=e.catch(3),Zc(n=e.t0)){e.next=13;break}throw n;case 13:return C("Error using user provided cache. Falling back to memory cache: "+n),e.next=16,Xc(t,new Pc);case 16:e.next=21;break;case 18:return D("FirestoreClient","Using default OfflineComponentProvider"),e.next=21,Xc(t,new Pc);case 21:return e.abrupt("return",t._offlineComponents);case 22:case"end":return e.stop()}}),e,null,[[3,8]])})))).apply(this,arguments)}function nl(e){return rl.apply(this,arguments)}function rl(){return(rl=Object(o.a)(y.a.mark((function e(t){return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=t._onlineComponents,e.t0){e.next=11;break}if(!t._uninitializedComponentsProvider){e.next=8;break}return D("FirestoreClient","Using user provided OnlineComponentProvider"),e.next=6,Jc(t,t._uninitializedComponentsProvider._online);case 6:e.next=11;break;case 8:return D("FirestoreClient","Using default OnlineComponentProvider"),e.next=11,Jc(t,new Bc);case 11:return e.abrupt("return",t._onlineComponents);case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function il(e){return el(e).then((function(e){return e.persistence}))}function al(e){return el(e).then((function(e){return e.localStore}))}function ul(e){return nl(e).then((function(e){return e.remoteStore}))}function ol(e){return nl(e).then((function(e){return e.syncEngine}))}function sl(e){return nl(e).then((function(e){return e.datastore}))}function cl(e){return ll.apply(this,arguments)}function ll(){return(ll=Object(o.a)(y.a.mark((function e(t){var n,r;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,nl(t);case 2:return n=e.sent,r=n.eventManager,e.abrupt("return",(r.onListen=Ks.bind(null,n.syncEngine),r.onUnlisten=Ws.bind(null,n.syncEngine),r));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function fl(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=new q;return e.asyncQueue.enqueueAndForget(Object(o.a)(y.a.mark((function i(){return y.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.t0=function(e,t,n,r,i){var a=new zc({next:function(a){t.enqueueAndForget((function(){return Ss(e,u)}));var o=a.docs.has(n);!o&&a.fromCache?i.reject(new P(L.UNAVAILABLE,"Failed to get document because the client is offline.")):o&&a.fromCache&&r&&"server"===r.source?i.reject(new P(L.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(a)},error:function(e){return i.reject(e)}}),u=new Cs(Mn(n.path),a,{includeMetadataChanges:!0,Uu:!0});return Es(e,u)},i.next=3,cl(e);case 3:return i.t1=i.sent,i.t2=e.asyncQueue,i.t3=t,i.t4=n,i.t5=r,i.abrupt("return",(0,i.t0)(i.t1,i.t2,i.t3,i.t4,i.t5));case 9:case"end":return i.stop()}}),i)})))),r.promise}function hl(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=new q;return e.asyncQueue.enqueueAndForget(Object(o.a)(y.a.mark((function i(){return y.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.t0=function(e,t,n,r,i){var a=new zc({next:function(n){t.enqueueAndForget((function(){return Ss(e,u)})),n.fromCache&&"server"===r.source?i.reject(new P(L.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:function(e){return i.reject(e)}}),u=new Cs(n,a,{includeMetadataChanges:!0,Uu:!0});return Es(e,u)},i.next=3,cl(e);case 3:return i.t1=i.sent,i.t2=e.asyncQueue,i.t3=t,i.t4=n,i.t5=r,i.abrupt("return",(0,i.t0)(i.t1,i.t2,i.t3,i.t4,i.t5));case 9:case"end":return i.stop()}}),i)})))),r.promise}var dl=new Map;function vl(e,t,n){if(!n)throw new P(L.INVALID_ARGUMENT,"Function ".concat(e,"() cannot be called with an empty ").concat(t,"."))}function yl(e,t,n,r){if(!0===t&&!0===r)throw new P(L.INVALID_ARGUMENT,"".concat(e," and ").concat(n," cannot be used together."))}function pl(e){if(!ue.isDocumentKey(e))throw new P(L.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but ".concat(e," has ").concat(e.length,"."))}function ml(e){if(ue.isDocumentKey(e))throw new P(L.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but ".concat(e," has ").concat(e.length,"."))}function gl(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e="".concat(e.substring(0,20),"...")),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";var t=function(e){return e.constructor?e.constructor.name:null}(e);return t?"a custom ".concat(t," object"):"an object"}return"function"==typeof e?"a function":R()}function kl(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new P(L.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=gl(e);throw new P(L.INVALID_ARGUMENT,"Expected type '".concat(t.name,"', but it was: ").concat(n))}return e}function bl(e,t){if(t<=0)throw new P(L.INVALID_ARGUMENT,"Function ".concat(e,"() requires a positive number, but it was: ").concat(t,"."))}var wl=function(){function e(t){var n;if(Object(h.a)(this,e),void 0===t.host){if(void 0!==t.ssl)throw new P(L.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(n=t.ssl)||void 0===n||n;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.cache=t.localCache,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new P(L.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}yl("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling||void 0===t.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!1:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams}return Object(d.a)(e,[{key:"isEqual",value:function(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}]),e}(),xl=function(){function e(t,n,r,i){Object(h.a)(this,e),this._authCredentials=t,this._appCheckCredentials=n,this._databaseId=r,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new wl({}),this._settingsFrozen=!1}return Object(d.a)(e,[{key:"app",get:function(){if(!this._app)throw new P(L.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}},{key:"_initialized",get:function(){return this._settingsFrozen}},{key:"_terminated",get:function(){return void 0!==this._terminateTask}},{key:"_setSettings",value:function(e){if(this._settingsFrozen)throw new P(L.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new wl(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new B;switch(e.type){case"firstParty":return new Q(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new P(L.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}},{key:"_getSettings",value:function(){return this._settings}},{key:"_freezeSettings",value:function(){return this._settingsFrozen=!0,this._settings}},{key:"_delete",value:function(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}},{key:"toJSON",value:function(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}},{key:"_terminate",value:function(){return e=this,(t=dl.get(e))&&(D("ComponentProvider","Removing Datastore"),dl.delete(e),t.terminate()),Promise.resolve();var e,t}}]),e}();function Il(e,t,n){var r,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=(e=kl(e,xl))._getSettings();if("firestore.googleapis.com"!==a.host&&a.host!==t&&C("Host has been set in both settings() and useEmulator(), emulator host will be used"),e._setSettings(Object.assign(Object.assign({},a),{host:"".concat(t,":").concat(n),ssl:!1})),i.mockUserToken){var u,o;if("string"==typeof i.mockUserToken)u=i.mockUserToken,o=E.MOCK_USER;else{u=Object(k.g)(i.mockUserToken,null===(r=e._app)||void 0===r?void 0:r.options.projectId);var s=i.mockUserToken.sub||i.mockUserToken.user_id;if(!s)throw new P(L.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");o=new E(s)}e._authCredentials=new K(new U(u,o))}}var Ol=function(){function e(t,n,r){Object(h.a)(this,e),this.converter=n,this._key=r,this.type="document",this.firestore=t}return Object(d.a)(e,[{key:"_path",get:function(){return this._key.path}},{key:"id",get:function(){return this._key.path.lastSegment()}},{key:"path",get:function(){return this._key.path.canonicalString()}},{key:"parent",get:function(){return new Tl(this.firestore,this.converter,this._key.path.popLast())}},{key:"withConverter",value:function(t){return new e(this.firestore,t,this._key)}}]),e}(),El=function(){function e(t,n,r){Object(h.a)(this,e),this.converter=n,this._query=r,this.type="query",this.firestore=t}return Object(d.a)(e,[{key:"withConverter",value:function(t){return new e(this.firestore,t,this._query)}}]),e}(),Tl=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r,i){var a;return Object(h.a)(this,n),(a=t.call(this,e,r,Mn(i)))._path=i,a.type="collection",a}return Object(d.a)(n,[{key:"id",get:function(){return this._query.path.lastSegment()}},{key:"path",get:function(){return this._query.path.canonicalString()}},{key:"parent",get:function(){var e=this._path.popLast();return e.isEmpty()?null:new Ol(this.firestore,null,new ue(e))}},{key:"withConverter",value:function(e){return new n(this.firestore,e,this._path)}}]),n}(El);function Sl(e,t){for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];if(e=Object(k.p)(e),vl("collection","path",t),e instanceof xl){var a=re.fromString.apply(re,[t].concat(r));return ml(a),new Tl(e,null,a)}if(!(e instanceof Ol||e instanceof Tl))throw new P(L.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");var u=e._path.child(re.fromString.apply(re,[t].concat(r)));return ml(u),new Tl(e.firestore,null,u)}function _l(e,t){if(e=kl(e,xl),vl("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new P(L.INVALID_ARGUMENT,"Invalid collection ID '".concat(t,"' passed to function collectionGroup(). Collection IDs must not contain '/'."));return new El(e,null,function(e){return new Rn(re.emptyPath(),e)}(t))}function jl(e,t){for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];if(e=Object(k.p)(e),1===arguments.length&&(t=Y.A()),vl("doc","path",t),e instanceof xl){var a=re.fromString.apply(re,[t].concat(r));return pl(a),new Ol(e,null,new ue(a))}if(!(e instanceof Ol||e instanceof Tl))throw new P(L.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");var u=e._path.child(re.fromString.apply(re,[t].concat(r)));return pl(u),new Ol(e.firestore,e instanceof Tl?e.converter:null,new ue(u))}function Dl(e,t){return e=Object(k.p)(e),t=Object(k.p)(t),(e instanceof Ol||e instanceof Tl)&&(t instanceof Ol||t instanceof Tl)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Al(e,t){return e=Object(k.p)(e),t=Object(k.p)(t),e instanceof El&&t instanceof El&&e.firestore===t.firestore&&Gn(e._query,t._query)&&e.converter===t.converter}var Cl=function(){function e(){var t=this;Object(h.a)(this,e),this.Kc=Promise.resolve(),this.Gc=[],this.Qc=!1,this.jc=[],this.zc=null,this.Wc=!1,this.Hc=!1,this.Jc=[],this.Lo=new Oo(this,"async_queue_retry"),this.Yc=function(){var e=xo();e&&D("AsyncQueue","Visibility state changed to "+e.visibilityState),t.Lo.ko()};var n=xo();n&&"function"==typeof n.addEventListener&&n.addEventListener("visibilitychange",this.Yc)}var t,n;return Object(d.a)(e,[{key:"isShuttingDown",get:function(){return this.Qc}},{key:"enqueueAndForget",value:function(e){this.enqueue(e)}},{key:"enqueueAndForgetEvenWhileRestricted",value:function(e){this.Xc(),this.Zc(e)}},{key:"enterRestrictedMode",value:function(e){if(!this.Qc){this.Qc=!0,this.Hc=e||!1;var t=xo();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Yc)}}},{key:"enqueue",value:function(e){var t=this;if(this.Xc(),this.Qc)return new Promise((function(){}));var n=new q;return this.Zc((function(){return t.Qc&&t.Hc?Promise.resolve():(e().then(n.resolve,n.reject),n.promise)})).then((function(){return n.promise}))}},{key:"enqueueRetryable",value:function(e){var t=this;this.enqueueAndForget((function(){return t.Gc.push(e),t.ta()}))}},{key:"ta",value:(n=Object(o.a)(y.a.mark((function e(){var t=this;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===this.Gc.length){e.next=14;break}return e.prev=1,e.next=4,this.Gc[0]();case 4:this.Gc.shift(),this.Lo.reset(),e.next=13;break;case 8:if(e.prev=8,e.t0=e.catch(1),Ee(e.t0)){e.next=12;break}throw e.t0;case 12:D("AsyncQueue","Operation failed with retryable error: "+e.t0);case 13:this.Gc.length>0&&this.Lo.xo((function(){return t.ta()}));case 14:case"end":return e.stop()}}),e,this,[[1,8]])}))),function(){return n.apply(this,arguments)})},{key:"Zc",value:function(e){var t=this,n=this.Kc.then((function(){return t.Wc=!0,e().catch((function(e){throw t.zc=e,t.Wc=!1,A("INTERNAL UNHANDLED ERROR: ",function(e){var t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e})).then((function(e){return t.Wc=!1,e}))}));return this.Kc=n,n}},{key:"enqueueAfterDelay",value:function(e,t,n){var r=this;this.Xc(),this.Jc.indexOf(e)>-1&&(t=0);var i=gs.createAndSchedule(this,e,t,n,(function(e){return r.ea(e)}));return this.jc.push(i),i}},{key:"Xc",value:function(){this.zc&&R()}},{key:"verifyOperationInProgress",value:function(){}},{key:"na",value:(t=Object(o.a)(y.a.mark((function e(){var t;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.Kc,e.next=3,t;case 3:if(t!==this.Kc){e.next=0;break}case 4:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"sa",value:function(e){var t,n=w(this.jc);try{for(n.s();!(t=n.n()).done;){if(t.value.timerId===e)return!0}}catch(r){n.e(r)}finally{n.f()}return!1}},{key:"ia",value:function(e){var t=this;return this.na().then((function(){t.jc.sort((function(e,t){return e.targetTimeMs-t.targetTimeMs}));var n,r=w(t.jc);try{for(r.s();!(n=r.n()).done;){var i=n.value;if(i.skipDelay(),"all"!==e&&i.timerId===e)break}}catch(a){r.e(a)}finally{r.f()}return t.na()}))}},{key:"ra",value:function(e){this.Jc.push(e)}},{key:"ea",value:function(e){var t=this.jc.indexOf(e);this.jc.splice(t,1)}}]),e}();function Nl(e){return function(e,t){if("object"!=typeof e||null===e)return!1;var n,r=e,i=w(["next","error","complete"]);try{for(i.s();!(n=i.n()).done;){var a=n.value;if(a in r&&"function"==typeof r[a])return!0}}catch(u){i.e(u)}finally{i.f()}return!1}(e)}var Rl=function(){function e(){Object(h.a)(this,e),this._progressObserver={},this._taskCompletionResolver=new q,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}return Object(d.a)(e,[{key:"onProgress",value:function(e,t,n){this._progressObserver={next:e,error:t,complete:n}}},{key:"catch",value:function(e){return this._taskCompletionResolver.promise.catch(e)}},{key:"then",value:function(e,t){return this._taskCompletionResolver.promise.then(e,t)}},{key:"_completeWith",value:function(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}},{key:"_failWith",value:function(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}},{key:"_updateProgress",value:function(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}]),e}(),Fl=-1,Ml=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r,i,a){var u;return Object(h.a)(this,n),(u=t.call(this,e,r,i,a)).type="firestore",u._queue=new Cl,u._persistenceKey=(null==a?void 0:a.name)||"[DEFAULT]",u}return Object(d.a)(n,[{key:"_terminate",value:function(){return this._firestoreClient||Ll(this),this._firestoreClient.terminate()}}]),n}(xl);function Vl(e){return e._firestoreClient||Ll(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Ll(e){var t,n,r,i=e._freezeSettings(),a=function(e,t,n,r){return new At(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,i);e._firestoreClient=new Hc(e._authCredentials,e._appCheckCredentials,e._queue,a),(null===(n=i.cache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=i.cache)||void 0===r?void 0:r._onlineComponentProvider)&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.cache.kind,_offline:i.cache._offlineComponentProvider,_online:i.cache._onlineComponentProvider})}function Pl(e,t){Hl(e=kl(e,Ml));var n=Vl(e);if(n._uninitializedComponentsProvider)throw new P(L.FAILED_PRECONDITION,"SDK cache is already specified.");C("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var r=e._freezeSettings(),i=new Bc;return Ul(n,i,new qc(i,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}function ql(e){Hl(e=kl(e,Ml));var t=Vl(e);if(t._uninitializedComponentsProvider)throw new P(L.FAILED_PRECONDITION,"SDK cache is already specified.");C("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var n=e._freezeSettings(),r=new Bc;return Ul(t,r,new Uc(r,n.cacheSizeBytes))}function Ul(e,t,n){var r=new q;return e.asyncQueue.enqueue(Object(o.a)(y.a.mark((function i(){var a;return y.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.prev=0,i.next=3,Xc(e,n);case 3:return i.next=5,Jc(e,t);case 5:r.resolve(),i.next=14;break;case 8:if(i.prev=8,i.t0=i.catch(0),Zc(a=i.t0)){i.next=13;break}throw a;case 13:C("Error enabling indexeddb cache. Falling back to memory cache: "+a),r.reject(a);case 14:case"end":return i.stop()}}),i,null,[[0,8]])})))).then((function(){return r.promise}))}function Bl(e){if(e._initialized&&!e._terminated)throw new P(L.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");var t=new q;return e._queue.enqueueAndForgetEvenWhileRestricted(Object(o.a)(y.a.mark((function n(){return y.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,function(){var e=Object(o.a)(y.a.mark((function e(t){var n;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(xe.D()){e.next=2;break}return e.abrupt("return",Promise.resolve());case 2:return n=t+"main",e.next=5,xe.delete(n);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()(Nu(e._databaseId,e._persistenceKey));case 3:t.resolve(),n.next=9;break;case 6:n.prev=6,n.t0=n.catch(0),t.reject(n.t0);case 9:case"end":return n.stop()}}),n,null,[[0,6]])})))),t.promise}function Kl(e){return function(e){var t=new q;return e.asyncQueue.enqueueAndForget(Object(o.a)(y.a.mark((function n(){return y.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.t0=uc,n.next=3,ol(e);case 3:return n.t1=n.sent,n.t2=t,n.abrupt("return",(0,n.t0)(n.t1,n.t2));case 6:case"end":return n.stop()}}),n)})))),t.promise}(Vl(e=kl(e,Ml)))}function zl(e){return function(e){return e.asyncQueue.enqueue(Object(o.a)(y.a.mark((function t(){var n,r;return y.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,il(e);case 2:return n=t.sent,t.next=5,ul(e);case 5:return r=t.sent,t.abrupt("return",(n.setNetworkEnabled(!0),function(e){var t=V(e);return t.Au.delete(0),Ao(t)}(r)));case 7:case"end":return t.stop()}}),t)}))))}(Vl(e=kl(e,Ml)))}function Gl(e){return function(e){return e.asyncQueue.enqueue(Object(o.a)(y.a.mark((function t(){var n,r;return y.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,il(e);case 2:return n=t.sent,t.next=5,ul(e);case 5:return r=t.sent,t.abrupt("return",(n.setNetworkEnabled(!1),function(){var e=Object(o.a)(y.a.mark((function e(t){var n;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=V(t)).Au.add(0),e.next=4,No(n);case 4:n.Pu.set("Offline");case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()(r)));case 7:case"end":return t.stop()}}),t)}))))}(Vl(e=kl(e,Ml)))}function Ql(e,t){var n=Vl(e=kl(e,Ml)),r=new Rl;return function(e,t,n,r){var i=function(e,t){return function(e,t){return new Gc(e,t)}(function(e,t){if(e instanceof Uint8Array)return Kc(e,t);if(e instanceof ArrayBuffer)return Kc(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof e?ei().encode(e):e),t)}(n,Io(t));e.asyncQueue.enqueueAndForget(Object(o.a)(y.a.mark((function t(){return y.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=Lc,t.next=3,ol(e);case 3:t.t1=t.sent,t.t2=i,t.t3=r,(0,t.t0)(t.t1,t.t2,t.t3);case 7:case"end":return t.stop()}}),t)}))))}(n,e._databaseId,t,r),r}function Wl(e,t){return function(e,t){return e.asyncQueue.enqueue(Object(o.a)(y.a.mark((function n(){return y.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.t0=function(e,t){var n=V(e);return n.persistence.runTransaction("Get named query","readonly",(function(e){return n.Ls.getNamedQuery(e,t)}))},n.next=3,al(e);case 3:return n.t1=n.sent,n.t2=t,n.abrupt("return",(0,n.t0)(n.t1,n.t2));case 6:case"end":return n.stop()}}),n)}))))}(Vl(e=kl(e,Ml)),t).then((function(t){return t?new El(e,null,t.query):null}))}function Hl(e){if(e._initialized||e._terminated)throw new P(L.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}var Xl=function(){function e(t){Object(h.a)(this,e),this._byteString=t}return Object(d.a)(e,[{key:"toBase64",value:function(){return this._byteString.toBase64()}},{key:"toUint8Array",value:function(){return this._byteString.toUint8Array()}},{key:"toString",value:function(){return"Bytes(base64: "+this.toBase64()+")"}},{key:"isEqual",value:function(e){return this._byteString.isEqual(e._byteString)}}],[{key:"fromBase64String",value:function(t){try{return new e(It.fromBase64String(t))}catch(t){throw new P(L.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}},{key:"fromUint8Array",value:function(t){return new e(It.fromUint8Array(t))}}]),e}(),Yl=function(){function e(){Object(h.a)(this,e);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(var i=0;i<n.length;++i)if(0===n[i].length)throw new P(L.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ae(n)}return Object(d.a)(e,[{key:"isEqual",value:function(e){return this._internalPath.isEqual(e._internalPath)}}]),e}();var Jl=function e(t){Object(h.a)(this,e),this._methodName=t},$l=function(){function e(t,n){if(Object(h.a)(this,e),!isFinite(t)||t<-90||t>90)throw new P(L.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(n)||n<-180||n>180)throw new P(L.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+n);this._lat=t,this._long=n}return Object(d.a)(e,[{key:"latitude",get:function(){return this._lat}},{key:"longitude",get:function(){return this._long}},{key:"isEqual",value:function(e){return this._lat===e._lat&&this._long===e._long}},{key:"toJSON",value:function(){return{latitude:this._lat,longitude:this._long}}},{key:"_compareTo",value:function(e){return J(this._lat,e._lat)||J(this._long,e._long)}}]),e}(),Zl=/^__.*__$/,ef=function(){function e(t,n,r){Object(h.a)(this,e),this.data=t,this.fieldMask=n,this.fieldTransforms=r}return Object(d.a)(e,[{key:"toMutation",value:function(e,t){return null!==this.fieldMask?new Lr(e,this.data,this.fieldMask,t,this.fieldTransforms):new Vr(e,this.data,t,this.fieldTransforms)}}]),e}(),tf=function(){function e(t,n,r){Object(h.a)(this,e),this.data=t,this.fieldMask=n,this.fieldTransforms=r}return Object(d.a)(e,[{key:"toMutation",value:function(e,t){return new Lr(e,this.data,this.fieldMask,t,this.fieldTransforms)}}]),e}();function nf(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw R()}}var rf=function(){function e(t,n,r,i,a,u){Object(h.a)(this,e),this.settings=t,this.databaseId=n,this.serializer=r,this.ignoreUndefinedProperties=i,void 0===a&&this.oa(),this.fieldTransforms=a||[],this.fieldMask=u||[]}return Object(d.a)(e,[{key:"path",get:function(){return this.settings.path}},{key:"ua",get:function(){return this.settings.ua}},{key:"ca",value:function(t){return new e(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}},{key:"aa",value:function(e){var t,n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ca({path:n,ha:!1});return r.la(e),r}},{key:"fa",value:function(e){var t,n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ca({path:n,ha:!1});return r.oa(),r}},{key:"da",value:function(e){return this.ca({path:void 0,ha:!0})}},{key:"_a",value:function(e){return Of(e,this.settings.methodName,this.settings.wa||!1,this.path,this.settings.ma)}},{key:"contains",value:function(e){return void 0!==this.fieldMask.find((function(t){return e.isPrefixOf(t)}))||void 0!==this.fieldTransforms.find((function(t){return e.isPrefixOf(t.field)}))}},{key:"oa",value:function(){if(this.path)for(var e=0;e<this.path.length;e++)this.la(this.path.get(e))}},{key:"la",value:function(e){if(0===e.length)throw this._a("Document fields must not be empty");if(nf(this.ua)&&Zl.test(e))throw this._a('Document fields cannot begin and end with "__"')}}]),e}(),af=function(){function e(t,n,r){Object(h.a)(this,e),this.databaseId=t,this.ignoreUndefinedProperties=n,this.serializer=r||Io(t)}return Object(d.a)(e,[{key:"ga",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return new rf({ua:e,methodName:t,ma:n,path:ae.emptyPath(),ha:!1,wa:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}]),e}();function uf(e){var t=e._freezeSettings(),n=Io(e._databaseId);return new af(e._databaseId,!!t.ignoreUndefinedProperties,n)}function of(e,t,n,r,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},u=e.ga(a.merge||a.mergeFields?2:0,t,n,i);bf("Data must be an object, but it was:",u,r);var o,s,c=gf(r,u);if(a.merge)o=new bt(u.fieldMask),s=u.fieldTransforms;else if(a.mergeFields){var l,f=[],h=w(a.mergeFields);try{for(h.s();!(l=h.n()).done;){var d=l.value,v=wf(t,d,n);if(!u.contains(v))throw new P(L.INVALID_ARGUMENT,"Field '".concat(v,"' is specified in your field mask but missing from your input data."));Ef(f,v)||f.push(v)}}catch(y){h.e(y)}finally{h.f()}o=new bt(f),s=u.fieldTransforms.filter((function(e){return o.covers(e.field)}))}else o=null,s=u.fieldTransforms;return new ef(new Zt(c),o,s)}var sf=function(e){Object(s.a)(n,e);var t=I(n);function n(){return Object(h.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"_toFieldTransform",value:function(e){if(2!==e.ua)throw 1===e.ua?e._a("".concat(this._methodName,"() can only appear at the top level of your update data")):e._a("".concat(this._methodName,"() cannot be used with set() unless you pass {merge:true}"));return e.fieldMask.push(e.path),null}},{key:"isEqual",value:function(e){return e instanceof n}}]),n}(Jl);function cf(e,t,n){return new rf({ua:3,ma:t.settings.ma,methodName:e._methodName,ha:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}var lf=function(e){Object(s.a)(n,e);var t=I(n);function n(){return Object(h.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"_toFieldTransform",value:function(e){return new Sr(e.path,new kr)}},{key:"isEqual",value:function(e){return e instanceof n}}]),n}(Jl),ff=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this,e)).ya=r,i}return Object(d.a)(n,[{key:"_toFieldTransform",value:function(e){var t=cf(this,e,!0),n=this.ya.map((function(e){return mf(e,t)})),r=new br(n);return new Sr(e.path,r)}},{key:"isEqual",value:function(e){return this===e}}]),n}(Jl),hf=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this,e)).ya=r,i}return Object(d.a)(n,[{key:"_toFieldTransform",value:function(e){var t=cf(this,e,!0),n=this.ya.map((function(e){return mf(e,t)})),r=new xr(n);return new Sr(e.path,r)}},{key:"isEqual",value:function(e){return this===e}}]),n}(Jl),df=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this,e)).pa=r,i}return Object(d.a)(n,[{key:"_toFieldTransform",value:function(e){var t=new Or(e.serializer,vr(e.serializer,this.pa));return new Sr(e.path,t)}},{key:"isEqual",value:function(e){return this===e}}]),n}(Jl);function vf(e,t,n,r){var i=e.ga(1,t,n);bf("Data must be an object, but it was:",i,r);var a=[],u=Zt.empty();ht(r,(function(e,r){var o=If(t,e,n);r=Object(k.p)(r);var s=i.fa(o);if(r instanceof sf)a.push(o);else{var c=mf(r,s);null!=c&&(a.push(o),u.set(o,c))}}));var o=new bt(a);return new tf(u,o,i.fieldTransforms)}function yf(e,t,n,r,i,a){var u=e.ga(1,t,n),o=[wf(t,r,n)],s=[i];if(a.length%2!=0)throw new P(L.INVALID_ARGUMENT,"Function ".concat(t,"() needs to be called with an even number of arguments that alternate between field names and values."));for(var c=0;c<a.length;c+=2)o.push(wf(t,a[c])),s.push(a[c+1]);for(var l=[],f=Zt.empty(),h=o.length-1;h>=0;--h)if(!Ef(l,o[h])){var d=o[h],v=s[h];v=Object(k.p)(v);var y=u.fa(d);if(v instanceof sf)l.push(d);else{var p=mf(v,y);null!=p&&(l.push(d),f.set(d,p))}}var m=new bt(l);return new tf(f,m,u.fieldTransforms)}function pf(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return mf(n,e.ga(r?4:3,t))}function mf(e,t){if(kf(e=Object(k.p)(e)))return bf("Unsupported field value:",t,e),gf(e,t);if(e instanceof Jl)return function(e,t){if(!nf(t.ua))throw t._a("".concat(e._methodName,"() can only be used with update() and set()"));if(!t.path)throw t._a("".concat(e._methodName,"() is not currently supported inside arrays"));var n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.ha&&4!==t.ua)throw t._a("Nested arrays are not supported");return function(e,t){var n,r=[],i=0,a=w(e);try{for(a.s();!(n=a.n()).done;){var u=mf(n.value,t.da(i));null==u&&(u={nullValue:"NULL_VALUE"}),r.push(u),i++}}catch(o){a.e(o)}finally{a.f()}return{arrayValue:{values:r}}}(e,t)}return function(e,t){if(null===(e=Object(k.p)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return vr(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){var n=ee.fromDate(e);return{timestampValue:bi(t.serializer,n)}}if(e instanceof ee){var r=new ee(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:bi(t.serializer,r)}}if(e instanceof $l)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Xl)return{bytesValue:wi(t.serializer,e._byteString)};if(e instanceof Ol){var i=t.databaseId,a=e.firestore._databaseId;if(!a.isEqual(i))throw t._a("Document reference is for database ".concat(a.projectId,"/").concat(a.database," but should be for database ").concat(i.projectId,"/").concat(i.database));return{referenceValue:Oi(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t._a("Unsupported field value: ".concat(gl(e)))}(e,t)}function gf(e,t){var n={};return dt(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):ht(e,(function(e,r){var i=mf(r,t.aa(e));null!=i&&(n[e]=i)})),{mapValue:{fields:n}}}function kf(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof ee||e instanceof $l||e instanceof Xl||e instanceof Ol||e instanceof Jl)}function bf(e,t,n){if(!kf(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){var r=gl(n);throw"an object"===r?t._a(e+" a custom object"):t._a(e+" "+r)}}function wf(e,t,n){if((t=Object(k.p)(t))instanceof Yl)return t._internalPath;if("string"==typeof t)return If(e,t);throw Of("Field path arguments must be of type string or ",e,!1,void 0,n)}var xf=new RegExp("[~\\*/\\[\\]]");function If(e,t,n){if(t.search(xf)>=0)throw Of("Invalid field path (".concat(t,"). Paths must not contain '~', '*', '/', '[', or ']'"),e,!1,void 0,n);try{return Object(r.a)(Yl,Object(f.a)(t.split(".")))._internalPath}catch(i){throw Of("Invalid field path (".concat(t,"). Paths must not be empty, begin with '.', end with '.', or contain '..'"),e,!1,void 0,n)}}function Of(e,t,n,r,i){var a=r&&!r.isEmpty(),u=void 0!==i,o="Function ".concat(t,"() called with invalid data");n&&(o+=" (via `toFirestore()`)"),o+=". ";var s="";return(a||u)&&(s+=" (found",a&&(s+=" in field ".concat(r)),u&&(s+=" in document ".concat(i)),s+=")"),new P(L.INVALID_ARGUMENT,o+e+s)}function Ef(e,t){return e.some((function(e){return e.isEqual(t)}))}var Tf=function(){function e(t,n,r,i,a){Object(h.a)(this,e),this._firestore=t,this._userDataWriter=n,this._key=r,this._document=i,this._converter=a}return Object(d.a)(e,[{key:"id",get:function(){return this._key.path.lastSegment()}},{key:"ref",get:function(){return new Ol(this._firestore,this._converter,this._key)}},{key:"exists",value:function(){return null!==this._document}},{key:"data",value:function(){if(this._document){if(this._converter){var e=new Sf(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}},{key:"get",value:function(e){if(this._document){var t=this._document.data.field(_f("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}]),e}(),Sf=function(e){Object(s.a)(n,e);var t=I(n);function n(){return Object(h.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"data",value:function(){return Object(i.a)(Object(l.a)(n.prototype),"data",this).call(this)}}]),n}(Tf);function _f(e,t){return"string"==typeof t?If(e,t):t instanceof Yl?t._internalPath:t._delegate._internalPath}function jf(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new P(L.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var Df=function e(){Object(h.a)(this,e)},Af=function(e){Object(s.a)(n,e);var t=I(n);function n(){return Object(h.a)(this,n),t.apply(this,arguments)}return n}(Df);function Cf(e,t){for(var n=[],r=arguments.length,i=new Array(r>2?r-2:0),a=2;a<r;a++)i[a-2]=arguments[a];t instanceof Df&&n.push(t),function(e){var t=e.filter((function(e){return e instanceof Ff})).length,n=e.filter((function(e){return e instanceof Nf})).length;if(t>1||t>0&&n>0)throw new P(L.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(n=n.concat(i));var u,o=w(n);try{for(o.s();!(u=o.n()).done;){var s=u.value;e=s._apply(e)}}catch(c){o.e(c)}finally{o.f()}return e}var Nf=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r,i){var a;return Object(h.a)(this,n),(a=t.call(this))._field=e,a._op=r,a._value=i,a.type="where",a}return Object(d.a)(n,[{key:"_apply",value:function(e){var t=this._parse(e);return Yf(e._query,t),new El(e.firestore,e.converter,Kn(e._query,t))}},{key:"_parse",value:function(e){var t=uf(e.firestore);return function(e,t,n,r,i,a,u){var o;if(i.isKeyField()){if("array-contains"===a||"array-contains-any"===a)throw new P(L.INVALID_ARGUMENT,"Invalid Query. You can't perform '".concat(a,"' queries on documentId()."));if("in"===a||"not-in"===a){Xf(u,a);var s,c=[],l=w(u);try{for(l.s();!(s=l.n()).done;){var f=s.value;c.push(Hf(r,e,f))}}catch(h){l.e(h)}finally{l.f()}o={arrayValue:{values:c}}}else o=Hf(r,e,u)}else"in"!==a&&"not-in"!==a&&"array-contains-any"!==a||Xf(u,a),o=pf(n,"where",u,"in"===a||"not-in"===a);return cn.create(i,a,o)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value)}}],[{key:"_create",value:function(e,t,r){return new n(e,t,r)}}]),n}(Af);function Rf(e,t,n){var r=t,i=_f("where",e);return Nf._create(i,r,n)}var Ff=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this)).type=e,i._queryConstraints=r,i}return Object(d.a)(n,[{key:"_parse",value:function(e){var t=this._queryConstraints.map((function(t){return t._parse(e)})).filter((function(e){return e.getFilters().length>0}));return 1===t.length?t[0]:ln.create(t,this._getOperator())}},{key:"_apply",value:function(e){var t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){var n,r=e,i=w(t.getFlattenedFilters());try{for(i.s();!(n=i.n()).done;){var a=n.value;Yf(r,a),r=Kn(r,a)}}catch(u){i.e(u)}finally{i.f()}}(e._query,t),new El(e.firestore,e.converter,Kn(e._query,t)))}},{key:"_getQueryConstraints",value:function(){return this._queryConstraints}},{key:"_getOperator",value:function(){return"and"===this.type?"and":"or"}}],[{key:"_create",value:function(e,t){return new n(e,t)}}]),n}(Df);var Mf=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this))._field=e,i._direction=r,i.type="orderBy",i}return Object(d.a)(n,[{key:"_apply",value:function(e){var t=function(e,t,n){if(null!==e.startAt)throw new P(L.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new P(L.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r=new un(t,n);return function(e,t){if(null===Ln(e)){var n=Pn(e);null!==n&&Jf(e,n,t.field)}}(e,r),r}(e._query,this._field,this._direction);return new El(e.firestore,e.converter,function(e,t){var n=e.explicitOrderBy.concat([t]);return new Rn(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}],[{key:"_create",value:function(e,t){return new n(e,t)}}]),n}(Af);function Vf(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"asc",n=t,r=_f("orderBy",e);return Mf._create(r,n)}var Lf=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r,i){var a;return Object(h.a)(this,n),(a=t.call(this)).type=e,a._limit=r,a._limitType=i,a}return Object(d.a)(n,[{key:"_apply",value:function(e){return new El(e.firestore,e.converter,zn(e._query,this._limit,this._limitType))}}],[{key:"_create",value:function(e,t,r){return new n(e,t,r)}}]),n}(Af);function Pf(e){return bl("limit",e),Lf._create("limit",e,"F")}function qf(e){return bl("limitToLast",e),Lf._create("limitToLast",e,"L")}var Uf=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r,i){var a;return Object(h.a)(this,n),(a=t.call(this)).type=e,a._docOrFields=r,a._inclusive=i,a}return Object(d.a)(n,[{key:"_apply",value:function(e){var t=Wf(e,this.type,this._docOrFields,this._inclusive);return new El(e.firestore,e.converter,function(e,t){return new Rn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}],[{key:"_create",value:function(e,t,r){return new n(e,t,r)}}]),n}(Af);function Bf(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Uf._create("startAt",t,!0)}function Kf(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Uf._create("startAfter",t,!1)}var zf=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r,i){var a;return Object(h.a)(this,n),(a=t.call(this)).type=e,a._docOrFields=r,a._inclusive=i,a}return Object(d.a)(n,[{key:"_apply",value:function(e){var t=Wf(e,this.type,this._docOrFields,this._inclusive);return new El(e.firestore,e.converter,function(e,t){return new Rn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}],[{key:"_create",value:function(e,t,r){return new n(e,t,r)}}]),n}(Af);function Gf(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return zf._create("endBefore",t,!1)}function Qf(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return zf._create("endAt",t,!0)}function Wf(e,t,n,r){if(n[0]=Object(k.p)(n[0]),n[0]instanceof Tf)return function(e,t,n,r,i){if(!r)throw new P(L.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for ".concat(n,"()."));var a,u=[],o=w(Un(e));try{for(o.s();!(a=o.n()).done;){var s=a.value;if(s.field.isKeyField())u.push(Ut(t,r.key));else{var c=r.data.field(s.field);if(_t(c))throw new P(L.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+s.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===c){var l=s.field.canonicalString();throw new P(L.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '".concat(l,"' (used as the orderBy) does not exist."))}u.push(c)}}}catch(f){o.e(f)}finally{o.f()}return new nn(u,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var i=uf(e.firestore);return function(e,t,n,r,i,a){var u=e.explicitOrderBy;if(i.length>u.length)throw new P(L.INVALID_ARGUMENT,"Too many arguments provided to ".concat(r,"(). The number of arguments must be less than or equal to the number of orderBy() clauses"));for(var o=[],s=0;s<i.length;s++){var c=i[s];if(u[s].field.isKeyField()){if("string"!=typeof c)throw new P(L.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in ".concat(r,"(), but got a ").concat(typeof c));if(!qn(e)&&-1!==c.indexOf("/"))throw new P(L.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by documentId(), the value passed to ".concat(r,"() must be a plain document ID, but '").concat(c,"' contains a slash."));var l=e.path.child(re.fromString(c));if(!ue.isDocumentKey(l))throw new P(L.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by documentId(), the value passed to ".concat(r,"() must result in a valid document path, but '").concat(l,"' is not because it contains an odd number of segments."));var f=new ue(l);o.push(Ut(t,f))}else{var h=pf(n,r,c);o.push(h)}}return new nn(o,a)}(e._query,e.firestore._databaseId,i,t,n,r)}function Hf(e,t,n){if("string"==typeof(n=Object(k.p)(n))){if(""===n)throw new P(L.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!qn(t)&&-1!==n.indexOf("/"))throw new P(L.INVALID_ARGUMENT,"Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '".concat(n,"' contains a '/' character."));var r=t.path.child(re.fromString(n));if(!ue.isDocumentKey(r))throw new P(L.INVALID_ARGUMENT,"Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '".concat(r,"' is not because it has an odd number of segments (").concat(r.length,")."));return Ut(e,new ue(r))}if(n instanceof Ol)return Ut(e,n._key);throw new P(L.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ".concat(gl(n),"."))}function Xf(e,t){if(!Array.isArray(e)||0===e.length)throw new P(L.INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '".concat(t.toString(),"' filters."))}function Yf(e,t){if(t.isInequality()){var n=Pn(e),r=t.field;if(null!==n&&!n.isEqual(r))throw new P(L.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '".concat(n.toString(),"' and '").concat(r.toString(),"'"));var i=Ln(e);null!==i&&Jf(e,r,i)}var a=function(e,t){var n,r=w(e);try{for(r.s();!(n=r.n()).done;){var i,a=w(n.value.getFlattenedFilters());try{for(a.s();!(i=a.n()).done;){var u=i.value;if(t.indexOf(u.op)>=0)return u.op}}catch(o){a.e(o)}finally{a.f()}}}catch(o){r.e(o)}finally{r.f()}return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==a)throw a===t.op?new P(L.INVALID_ARGUMENT,"Invalid query. You cannot use more than one '".concat(t.op.toString(),"' filter.")):new P(L.INVALID_ARGUMENT,"Invalid query. You cannot use '".concat(t.op.toString(),"' filters with '").concat(a.toString(),"' filters."))}function Jf(e,t,n){if(!n.isEqual(t))throw new P(L.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '".concat(t.toString(),"' and so you must also use '").concat(t.toString(),"' as your first argument to orderBy(), but your first orderBy() is on field '").concat(n.toString(),"' instead."))}var $f=function(){function e(){Object(h.a)(this,e)}return Object(d.a)(e,[{key:"convertValue",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"none";switch(Ft(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Tt(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(St(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw R()}}},{key:"convertObject",value:function(e,t){return this.convertObjectMap(e.fields,t)}},{key:"convertObjectMap",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"none",r={};return ht(e,(function(e,i){r[e]=t.convertValue(i,n)})),r}},{key:"convertGeoPoint",value:function(e){return new $l(Tt(e.latitude),Tt(e.longitude))}},{key:"convertArray",value:function(e,t){var n=this;return(e.values||[]).map((function(e){return n.convertValue(e,t)}))}},{key:"convertServerTimestamp",value:function(e,t){switch(t){case"previous":var n=jt(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Dt(e));default:return null}}},{key:"convertTimestamp",value:function(e){var t=Et(e);return new ee(t.seconds,t.nanos)}},{key:"convertDocumentKey",value:function(e,t){var n=re.fromString(e);F(Qi(n));var r=new Ct(n.get(1),n.get(3)),i=new ue(n.popFirst(5));return r.isEqual(t)||A("Document ".concat(i," contains a document reference within a different database (").concat(r.projectId,"/").concat(r.database,") which is not supported. It will be treated as a reference in the current database (").concat(t.projectId,"/").concat(t.database,") instead.")),i}}]),e}();function Zf(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}var eh=function(e){Object(s.a)(n,e);var t=I(n);function n(e){var r;return Object(h.a)(this,n),(r=t.call(this)).firestore=e,r}return Object(d.a)(n,[{key:"convertBytes",value:function(e){return new Xl(e)}},{key:"convertReference",value:function(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Ol(this.firestore,null,t)}}]),n}($f);var th=function(){function e(t,n){Object(h.a)(this,e),this.hasPendingWrites=t,this.fromCache=n}return Object(d.a)(e,[{key:"isEqual",value:function(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}]),e}(),nh=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r,i,a,u,o){var s;return Object(h.a)(this,n),(s=t.call(this,e,r,i,a,o))._firestore=e,s._firestoreImpl=e,s.metadata=u,s}return Object(d.a)(n,[{key:"exists",value:function(){return Object(i.a)(Object(l.a)(n.prototype),"exists",this).call(this)}},{key:"data",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this._document){if(this._converter){var t=new rh(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}},{key:"get",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this._document){var n=this._document.data.field(_f("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}]),n}(Tf),rh=function(e){Object(s.a)(n,e);var t=I(n);function n(){return Object(h.a)(this,n),t.apply(this,arguments)}return Object(d.a)(n,[{key:"data",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object(i.a)(Object(l.a)(n.prototype),"data",this).call(this,e)}}]),n}(nh),ih=function(){function e(t,n,r,i){Object(h.a)(this,e),this._firestore=t,this._userDataWriter=n,this._snapshot=i,this.metadata=new th(i.hasPendingWrites,i.fromCache),this.query=r}return Object(d.a)(e,[{key:"docs",get:function(){var e=[];return this.forEach((function(t){return e.push(t)})),e}},{key:"size",get:function(){return this._snapshot.docs.size}},{key:"empty",get:function(){return 0===this.size}},{key:"forEach",value:function(e,t){var n=this;this._snapshot.docs.forEach((function(r){e.call(t,new rh(n._firestore,n._userDataWriter,r.key,r,new th(n._snapshot.mutatedKeys.has(r.key),n._snapshot.fromCache),n.query.converter))}))}},{key:"docChanges",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new P(L.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){var n=0;return e._snapshot.docChanges.map((function(t){var r=new rh(e._firestore,e._userDataWriter,t.doc.key,t.doc,new th(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);return t.doc,{type:"added",doc:r,oldIndex:-1,newIndex:n++}}))}var r=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((function(e){return t||3!==e.type})).map((function(t){var n=new rh(e._firestore,e._userDataWriter,t.doc.key,t.doc,new th(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter),i=-1,a=-1;return 0!==t.type&&(i=r.indexOf(t.doc.key),r=r.delete(t.doc.key)),1!==t.type&&(a=(r=r.add(t.doc)).indexOf(t.doc.key)),{type:ah(t.type),doc:n,oldIndex:i,newIndex:a}}))}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}]),e}();function ah(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return R()}}function uh(e,t){return e instanceof nh&&t instanceof nh?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof ih&&t instanceof ih&&e._firestore===t._firestore&&Al(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function oh(e){e=kl(e,Ol);var t=kl(e.firestore,Ml);return fl(Vl(t),e._key).then((function(n){return wh(t,e,n)}))}var sh=function(e){Object(s.a)(n,e);var t=I(n);function n(e){var r;return Object(h.a)(this,n),(r=t.call(this)).firestore=e,r}return Object(d.a)(n,[{key:"convertBytes",value:function(e){return new Xl(e)}},{key:"convertReference",value:function(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Ol(this.firestore,null,t)}}]),n}($f);function ch(e){e=kl(e,Ol);var t=kl(e.firestore,Ml),n=Vl(t),r=new sh(t);return function(e,t){var n=new q;return e.asyncQueue.enqueueAndForget(Object(o.a)(y.a.mark((function r(){return y.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.t0=function(){var e=Object(o.a)(y.a.mark((function e(t,n,r){var i,a;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,function(e,t){var n=V(e);return n.persistence.runTransaction("read document","readonly",(function(e){return n.localDocuments.getDocument(e,t)}))}(t,n);case 3:(i=e.sent).isFoundDocument()?r.resolve(i):i.isNoDocument()?r.resolve(null):r.reject(new P(L.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),a=ks(e.t0,"Failed to get document '".concat(n," from cache")),r.reject(a);case 11:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,n,r){return e.apply(this,arguments)}}(),r.next=3,al(e);case 3:return r.t1=r.sent,r.t2=t,r.t3=n,r.abrupt("return",(0,r.t0)(r.t1,r.t2,r.t3));case 7:case"end":return r.stop()}}),r)})))),n.promise}(n,e._key).then((function(n){return new nh(t,r,e._key,n,new th(null!==n&&n.hasLocalMutations,!0),e.converter)}))}function lh(e){e=kl(e,Ol);var t=kl(e.firestore,Ml);return fl(Vl(t),e._key,{source:"server"}).then((function(n){return wh(t,e,n)}))}function fh(e){e=kl(e,El);var t=kl(e.firestore,Ml),n=Vl(t),r=new sh(t);return jf(e._query),hl(n,e._query).then((function(n){return new ih(t,r,e,n)}))}function hh(e){e=kl(e,El);var t=kl(e.firestore,Ml),n=Vl(t),r=new sh(t);return function(e,t){var n=new q;return e.asyncQueue.enqueueAndForget(Object(o.a)(y.a.mark((function r(){return y.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.t0=function(){var e=Object(o.a)(y.a.mark((function e(t,n,r){var i,a,u,o,s;return y.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Hu(t,n,!0);case 3:i=e.sent,a=new Ps(n,i.sr),u=a.nc(i.documents),o=a.applyChanges(u,!1),r.resolve(o.snapshot),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(0),s=ks(e.t0,"Failed to execute query '".concat(n," against cache")),r.reject(s);case 14:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,n,r){return e.apply(this,arguments)}}(),r.next=3,al(e);case 3:return r.t1=r.sent,r.t2=t,r.t3=n,r.abrupt("return",(0,r.t0)(r.t1,r.t2,r.t3));case 7:case"end":return r.stop()}}),r)})))),n.promise}(n,e._query).then((function(n){return new ih(t,r,e,n)}))}function dh(e){e=kl(e,El);var t=kl(e.firestore,Ml),n=Vl(t),r=new sh(t);return hl(n,e._query,{source:"server"}).then((function(n){return new ih(t,r,e,n)}))}function vh(e,t,n){e=kl(e,Ol);var r=kl(e.firestore,Ml),i=Zf(e.converter,t,n);return bh(r,[of(uf(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,jr.none())])}function yh(e,t,n){e=kl(e,Ol);for(var r=kl(e.firestore,Ml),i=uf(r),a=arguments.length,u=new Array(a>3?a-3:0),o=3;o<a;o++)u[o-3]=arguments[o];return bh(r,[("string"==typeof(t=Object(k.p)(t))||t instanceof Yl?yf(i,"updateDoc",e._key,t,n,u):vf(i,"updateDoc",e._key,t)).toMutation(e._key,jr.exists(!0))])}function ph(e){return bh(kl(e.firestore,Ml),[new zr(e._key,jr.none())])}function mh(e,t){var n=kl(e.firestore,Ml),r=jl(e),i=Zf(e.converter,t);return bh(n,[of(uf(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,jr.exists(!1))]).then((function(){return r}))}function gh(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i,a,u;e=Object(k.p)(e);var s={includeMetadataChanges:!1},c=0;"object"!=typeof n[c]||Nl(n[c])||(s=n[c],c++);var l,f,h,d={includeMetadataChanges:s.includeMetadataChanges};if(Nl(n[c])){var v=n[c];n[c]=null===(i=v.next)||void 0===i?void 0:i.bind(v),n[c+1]=null===(a=v.error)||void 0===a?void 0:a.bind(v),n[c+2]=null===(u=v.complete)||void 0===u?void 0:u.bind(v)}if(e instanceof Ol)f=kl(e.firestore,Ml),h=Mn(e._key.path),l={next:function(t){n[c]&&n[c](wh(f,e,t))},error:n[c+1],complete:n[c+2]};else{var p=kl(e,El);f=kl(p.firestore,Ml),h=p._query;var m=new sh(f);l={next:function(e){n[c]&&n[c](new ih(f,m,p,e))},error:n[c+1],complete:n[c+2]},jf(e._query)}return function(e,t,n,r){var i=new zc(r),a=new Cs(t,i,n);return e.asyncQueue.enqueueAndForget(Object(o.a)(y.a.mark((function t(){return y.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=Es,t.next=3,cl(e);case 3:return t.t1=t.sent,t.t2=a,t.abrupt("return",(0,t.t0)(t.t1,t.t2));case 6:case"end":return t.stop()}}),t)})))),function(){i.Sc(),e.asyncQueue.enqueueAndForget(Object(o.a)(y.a.mark((function t(){return y.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=Ss,t.next=3,cl(e);case 3:return t.t1=t.sent,t.t2=a,t.abrupt("return",(0,t.t0)(t.t1,t.t2));case 6:case"end":return t.stop()}}),t)}))))}}(Vl(f),h,d,l)}function kh(e,t){return function(e,t){var n=new zc(t);return e.asyncQueue.enqueueAndForget(Object(o.a)(y.a.mark((function t(){return y.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=function(e,t){V(e).Nu.add(t),t.next()},t.next=3,cl(e);case 3:return t.t1=t.sent,t.t2=n,t.abrupt("return",(0,t.t0)(t.t1,t.t2));case 6:case"end":return t.stop()}}),t)})))),function(){n.Sc(),e.asyncQueue.enqueueAndForget(Object(o.a)(y.a.mark((function t(){return y.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0=function(e,t){V(e).Nu.delete(t)},t.next=3,cl(e);case 3:return t.t1=t.sent,t.t2=n,t.abrupt("return",(0,t.t0)(t.t1,t.t2));case 6:case"end":return t.stop()}}),t)}))))}}(Vl(e=kl(e,Ml)),Nl(t)?t:{next:t})}function bh(e,t){return function(e,t){var n=new q;return e.asyncQueue.enqueueAndForget(Object(o.a)(y.a.mark((function r(){return y.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.t0=Xs,r.next=3,ol(e);case 3:return r.t1=r.sent,r.t2=t,r.t3=n,r.abrupt("return",(0,r.t0)(r.t1,r.t2,r.t3));case 7:case"end":return r.stop()}}),r)})))),n.promise}(Vl(e),t)}function wh(e,t,n){var r=n.docs.get(t._key),i=new sh(e);return new nh(e,i,t._key,r,new th(n.hasPendingWrites,n.fromCache),t.converter)}var xh={maxAttempts:5},Ih=function(){function e(t,n){Object(h.a)(this,e),this._firestore=t,this._commitHandler=n,this._mutations=[],this._committed=!1,this._dataReader=uf(t)}return Object(d.a)(e,[{key:"set",value:function(e,t,n){this._verifyNotCommitted();var r=Oh(e,this._firestore),i=Zf(r.converter,t,n),a=of(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(a.toMutation(r._key,jr.none())),this}},{key:"update",value:function(e,t,n){this._verifyNotCommitted();for(var r,i=Oh(e,this._firestore),a=arguments.length,u=new Array(a>3?a-3:0),o=3;o<a;o++)u[o-3]=arguments[o];return r="string"==typeof(t=Object(k.p)(t))||t instanceof Yl?yf(this._dataReader,"WriteBatch.update",i._key,t,n,u):vf(this._dataReader,"WriteBatch.update",i._key,t),this._mutations.push(r.toMutation(i._key,jr.exists(!0))),this}},{key:"delete",value:function(e){this._verifyNotCommitted();var t=Oh(e,this._firestore);return this._mutations=this._mutations.concat(new zr(t._key,jr.none())),this}},{key:"commit",value:function(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}},{key:"_verifyNotCommitted",value:function(){if(this._committed)throw new P(L.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}]),e}();function Oh(e,t){if((e=Object(k.p)(e)).firestore!==t)throw new P(L.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}var Eh=function(e){Object(s.a)(n,e);var t=I(n);function n(e,r){var i;return Object(h.a)(this,n),(i=t.call(this,e,r))._firestore=e,i}return Object(d.a)(n,[{key:"get",value:function(e){var t=this,r=Oh(e,this._firestore),a=new sh(this._firestore);return Object(i.a)(Object(l.a)(n.prototype),"get",this).call(this,e).then((function(e){return new nh(t._firestore,a,r._key,e._document,new th(!1,!1),r.converter)}))}}]),n}(function(){function e(t,n){Object(h.a)(this,e),this._firestore=t,this._transaction=n,this._dataReader=uf(t)}return Object(d.a)(e,[{key:"get",value:function(e){var t=this,n=Oh(e,this._firestore),r=new eh(this._firestore);return this._transaction.lookup([n._key]).then((function(e){if(!e||1!==e.length)return R();var i=e[0];if(i.isFoundDocument())return new Tf(t._firestore,r,i.key,i,n.converter);if(i.isNoDocument())return new Tf(t._firestore,r,n._key,null,n.converter);throw R()}))}},{key:"set",value:function(e,t,n){var r=Oh(e,this._firestore),i=Zf(r.converter,t,n),a=of(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,a),this}},{key:"update",value:function(e,t,n){for(var r,i=Oh(e,this._firestore),a=arguments.length,u=new Array(a>3?a-3:0),o=3;o<a;o++)u[o-3]=arguments[o];return r="string"==typeof(t=Object(k.p)(t))||t instanceof Yl?yf(this._dataReader,"Transaction.update",i._key,t,n,u):vf(this._dataReader,"Transaction.update",i._key,t),this._transaction.update(i._key,r),this}},{key:"delete",value:function(e){var t=Oh(e,this._firestore);return this._transaction.delete(t._key),this}}]),e}());function Th(e,t,n){e=kl(e,Ml);var r=Object.assign(Object.assign({},xh),n);return function(e){if(e.maxAttempts<1)throw new P(L.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(e,t,n){var r=new q;return e.asyncQueue.enqueueAndForget(Object(o.a)(y.a.mark((function i(){var a;return y.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,sl(e);case 2:a=i.sent,new Wc(e.asyncQueue,a,n,t,r).run();case 4:case"end":return i.stop()}}),i)})))),r.promise}(Vl(e),(function(n){return t(new Eh(e,n))}),r)}function Sh(){return new sf("deleteField")}function _h(){return new lf("serverTimestamp")}function jh(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return new ff("arrayUnion",t)}function Dh(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return new hf("arrayRemove",t)}function Ah(e){return new df("increment",e)}!function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];!function(e){T=e}(p.SDK_VERSION),Object(p._registerComponent)(new m.a("firestore",(function(e,n){var r=n.instanceIdentifier,i=n.options,a=e.getProvider("app").getImmediate(),u=new Ml(new z(e.getProvider("auth-internal")),new H(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new P(L.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Ct(e.options.projectId,t)}(a,r),a);return i=Object.assign({useFetchStreams:t},i),u._setSettings(i),u}),"PUBLIC").setMultipleInstances(!0)),Object(p.registerVersion)(O,"3.11.0",e),Object(p.registerVersion)(O,"3.11.0","esm2017")}()}).call(this,n("8oxB"))}}]);
//# sourceMappingURL=7112840a-0e8783e98dabcd880da1.js.map